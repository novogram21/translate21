<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Chat Translator</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É PeerJS (–¥–ª—è —Å–≤—è–∑–∏ –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #ece5dd; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ) */
        #setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box; text-align: center;
        }
        
        .box { background: #333; padding: 20px; border-radius: 10px; width: 100%; max-width: 400px; margin-bottom: 20px; }
        input.id-input { width: 90%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; width: 100%; }
        .btn-green { background: #25D366; color: white; }
        .btn-blue { background: #34B7F1; color: white; }
        
        /* –ß–∞—Ç */
        header { background: #128C7E; color: white; padding: 15px; text-align: center; }
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { max-width: 75%; padding: 10px; border-radius: 8px; position: relative; word-wrap: break-word; }
        .msg-mine { align-self: flex-end; background: #dcf8c6; }
        .msg-other { align-self: flex-start; background: white; }
        
        .sub-text { font-size: 0.75em; color: #555; margin-top: 4px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 2px;}

        /* –í–≤–æ–¥ */
        #controls { padding: 10px; background: #f0f0f0; display: flex; gap: 10px; }
        #msg-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù –°–û–ï–î–ò–ù–ï–ù–ò–Ø -->
    <div id="setup-screen">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤—è–∑–∏ / Setup</h2>
        
        <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä —è–∑—ã–∫–∞ -->
        <div class="box">
            <p>1. –ö—Ç–æ —Ç—ã? / Who are you?</p>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-blue" onclick="selectRole('ru')">üá∑üá∫ –Ø –†—É—Å—Å–∫–∏–π</button>
                <button class="btn btn-blue" onclick="selectRole('ar')">üá™üá¨ I am Egyptian</button>
            </div>
            <p id="role-display" style="color:yellow;"></p>
        </div>

        <!-- –®–∞–≥ 2: –ú–æ–π ID -->
        <div class="box" id="step-2" style="display:none;">
            <p>2. –¢–≤–æ–π ID (–°–∫–æ–ø–∏—Ä—É–π –∏ –æ—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É):</p>
            <input type="text" class="id-input" id="my-id" readonly>
            <button class="btn btn-green" onclick="copyId()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å / Copy ID</button>
        </div>

        <!-- –®–∞–≥ 3: ID –î—Ä—É–≥–∞ -->
        <div class="box" id="step-3" style="display:none;">
            <p>3. –í—Å—Ç–∞–≤—å ID –¥—Ä—É–≥–∞ —Å—é–¥–∞ (–µ—Å–ª–∏ –æ–Ω —Å–æ–∑–¥–∞–ª —á–∞—Ç):</p>
            <input type="text" class="id-input" id="friend-id" placeholder="Paste Friend ID here...">
            <button class="btn btn-green" onclick="connectToFriend()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è / Connect</button>
        </div>
        
        <div id="status-msg" style="margin-top:20px; color: #aaa;">–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...</div>
    </div>

    <!-- –ß–ê–¢ (–°–∫—Ä—ã—Ç –¥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è) -->
    <header id="chat-header">–ß–∞—Ç (–û—Ñ–ª–∞–π–Ω)</header>
    <div id="chat-container"></div>
    <div id="controls">
        <input type="text" id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
        <button class="btn btn-green" style="width: auto;" onclick="sendMsg()">‚û§</button>
    </div>

    <script>
        let peer = null;
        let conn = null;
        let myLang = ''; 
        let targetLang = '';

        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PeerJS (—Å–æ–∑–¥–∞–µ–º —Å–µ–±–µ —Å–ª—É—á–∞–π–Ω—ã–π –∫–æ—Ä–æ—Ç–∫–∏–π ID)
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä PeerJS (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
        function initPeer() {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ID –∏–∑ 4 —Ü–∏—Ñ—Ä –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ (–Ω–æ –º–æ–∂–µ—Ç —Å–æ–≤–ø–∞—Å—Ç—å, –ª—É—á—à–µ –¥–ª–∏–Ω–Ω–µ–µ)
            const randomId = Math.floor(1000 + Math.random() * 9000); 
            peer = new Peer('chat-user-' + randomId);

            peer.on('open', (id) => {
                document.getElementById('my-id').value = id;
                document.getElementById('step-2').style.display = 'block';
                document.getElementById('step-3').style.display = 'block';
                document.getElementById('status-msg').innerText = "ID –ø–æ–ª—É—á–µ–Ω. –ñ–¥–µ–º –¥—Ä—É–≥–∞...";
            });

            // –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫–æ –º–Ω–µ
            peer.on('connection', (connection) => {
                setupConnection(connection);
            });
            
            peer.on('error', (err) => {
                console.error(err);
                alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + err.type);
            });
        }

        // –í—ã–±–æ—Ä —Ä–æ–ª–∏
        function selectRole(lang) {
            myLang = lang;
            targetLang = (lang === 'ru') ? 'ar' : 'ru';
            document.getElementById('role-display').innerText = (lang === 'ru') ? "–í—ã–±—Ä–∞–Ω–æ: –†—É—Å—Å–∫–∏–π" : "Selected: Arabic";
            initPeer(); // –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ç—å
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID
        function copyId() {
            const copyText = document.getElementById("my-id");
            copyText.select();
            document.execCommand("copy");
            alert("ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –û—Ç–ø—Ä–∞–≤—å –µ–≥–æ –¥—Ä—É–≥—É.");
        }

        // –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –¥—Ä—É–≥—É (–µ—Å–ª–∏ —è –≤–≤–æ–∂—É –µ–≥–æ ID)
        function connectToFriend() {
            const friendId = document.getElementById('friend-id').value.trim();
            if(!friendId) return alert("–í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞!");
            
            const connection = peer.connect(friendId);
            setupConnection(connection);
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–æ–±—â–∞—è –¥–ª—è –æ–±–æ–∏—Ö)
        function setupConnection(connection) {
            conn = connection;
            
            conn.on('open', () => {
                document.getElementById('setup-screen').style.display = 'none'; // –£–±–∏—Ä–∞–µ–º —à—Ç–æ—Ä–∫—É
                document.getElementById('chat-header').innerText = "üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ / Connected";
                document.getElementById('msg-input').disabled = false;
                alert("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!");
            });

            conn.on('data', (data) => {
                // –ü—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–∞
                displayMessage(data, false);
            });
            
            conn.on('close', () => {
                alert("–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è");
                document.getElementById('chat-header').innerText = "üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ";
            });
        }

        // –ü–µ—Ä–µ–≤–æ–¥ (MyMemory API Free)
        async function translateText(text, from, to) {
            try {
                const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}`;
                const res = await fetch(url);
                const json = await res.json();
                return json.responseData.translatedText;
            } catch (e) {
                console.error(e);
                return text; // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMsg() {
            const input = document.getElementById('msg-input');
            const text = input.value;
            if(!text) return;

            input.value = "–ü–µ—Ä–µ–≤–æ–¥... / Translating...";
            input.disabled = true;

            // 1. –ü–µ—Ä–µ–≤–æ–¥–∏–º
            const translated = await translateText(text, myLang, targetLang);

            // 2. –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç
            const msgObj = {
                original: text,       // –¢–µ–∫—Å—Ç –Ω–∞ –º–æ–µ–º —è–∑—ã–∫–µ
                translated: translated, // –¢–µ–∫—Å—Ç –Ω–∞ –µ–≥–æ —è–∑—ã–∫–µ
                senderLang: myLang
            };

            // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ P2P
            if(conn && conn.open) {
                conn.send(msgObj);
                displayMessage(msgObj, true); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É —Å–µ–±—è
            } else {
                alert("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è!");
            }

            input.value = "";
            input.disabled = false;
            input.focus();
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
        function displayMessage(data, isMine) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            
            let mainText, subText;

            if (isMine) {
                div.className = 'msg msg-mine';
                mainText = data.original;      // –Ø –≤–∏–∂—É —Å–≤–æ–π –æ—Ä–∏–≥–∏–Ω–∞–ª
                subText = data.translated;     // –ú–µ–ª–∫–æ - –ø–µ—Ä–µ–≤–æ–¥
            } else {
                div.className = 'msg msg-other';
                // –ï—Å–ª–∏ —è –ø–æ–ª—É—á–∞—Ç–µ–ª—å, –º–Ω–µ –≤–∞–∂–µ–Ω translated (–æ–Ω –Ω–∞ –º–æ–µ–º —è–∑—ã–∫–µ)
                // –ù–æ data.translated —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ –¢–û–ì–û, –∫—Ç–æ –ø–æ–ª—É—á–∞–ª.
                // –õ–æ–≥–∏–∫–∞: –Ø (ru), –î—Ä—É–≥ (ar). –î—Ä—É–≥ —à–ª–µ—Ç: orig(ar), trans(ru).
                // –Ø –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å trans(ru).
                mainText = data.translated;
                subText = data.original; 
            }

            div.innerHTML = `
                <div>${mainText}</div>
                <div class="sub-text">${subText}</div>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>