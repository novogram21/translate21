<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f1f1f" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="color-scheme" content="dark">
    <meta name="theme-color" content="#1f1f1f">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Novogram</title>
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #121212;
            color: #eee;
            margin: 0;
            display: flex;
            height: 100dvh;
            overflow: hidden;
            overscroll-behavior-y: none;
        }



        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121212;
            z-index: 6000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .auth-box {
            width: 300px;
            padding: 25px;
            background: #2d2d2d;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #444;
        }

            .auth-box input {
                width: 100%;
                padding: 12px;
                margin: 8px 0;
                background: #444;
                border: 1px solid #555;
                color: white;
                border-radius: 6px;
            }

            .auth-box button {
                width: 100%;
                padding: 12px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
                margin-top: 10px;
            }



        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar {
            width: 320px;
            background: #1f1f1f;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .profile-bar {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #252525; /* –ò–ª–∏ –≤–∞—à —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ */
        }


        #searchInput {
            width: 100%;
            height: 44px;
            padding: 0 15px;
            border-radius: 22px; /* –í–æ—Ç —ç—Ç–æ –¥–µ–ª–∞–µ—Ç –µ–≥–æ –∫—Ä—É–≥–ª—ã–º */
            border: 1px solid #333;
            background: #181818;
            color: white;
            font-size: 14px;
            outline: none;
            transition: 0.2s;
        }

            #searchInput:focus {
                border-color: #007bff; /* –°–∏–Ω—è—è –æ–±–≤–æ–¥–∫–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
            }

        .tabs {
            display: flex;
            background: #252525;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #888;
            font-size: 14px;
            position: relative;
        }

            .tab.active {
                border-bottom: 2px solid #007bff;
                color: white;
            }

        .tab-badge {
            background: #ff4444;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            position: absolute;
            top: 5px;
            right: 10px;
        }

        .list-container {
            flex: 1;
            overflow-y: auto;
        }



        /* –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ (–ù–û–í–´–ô –î–ò–ó–ê–ô–ù) */

        /* –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ */
        .user-item {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            display: grid;
            grid-template-columns: 55px 1fr auto; /* –ê–≤–∞—Ç–∞—Ä | –ò–º—è+–¢–µ–∫—Å—Ç | –ú–µ—Ç–∞ (–≤—Ä–µ–º—è, –≥–∞–ª–æ—á–∫–∏, —Å—á–µ—Ç—á–∏–∫) */
            grid-template-rows: auto auto;
            column-gap: 10px;
            align-items: center;
            cursor: pointer;
            transition: 0.2s;
            min-height: 72px;
        }

            .user-item:hover {
                background: #2a2a2a;
            }

        .user-item-avatar {
            grid-column: 1;
            grid-row: 1 / span 2;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-name {
            grid-column: 2;
            grid-row: 1;
            font-weight: 600;
            font-size: 16px;
            color: white;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            align-self: end;
        }

        .last-msg-row {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            align-items: center;
            overflow: hidden;
            align-self: start;
        }

        .last-msg {
            font-size: 14px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }



        /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –í—Ä–µ–º—è (—Å–≤–µ—Ä—Ö—É) –∏ –ì–∞–ª–æ—á–∫–∏/–°—á–µ—Ç—á–∏–∫ (—Å–Ω–∏–∑—É) */
        .meta-column {
            grid-column: 3;
            grid-row: 1 / span 2;
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* –í—Å–µ –ø—Ä–∏–∂–∞—Ç–æ –≤–ø—Ä–∞–≤–æ */
            justify-content: center;
            gap: 5px;
            min-width: 65px;
        }

        .last-msg-date {
            font-size: 13px;
            color: #888;
        }



        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ (–ì–∞–ª–æ—á–∫–∏ –ò–õ–ò –°—á–µ—Ç—á–∏–∫) */
        .meta-bottom-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            height: 20px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
        }



        /* –ì–∞–ª–æ—á–∫–∏ - —Ç–µ–ø–µ—Ä—å –±–µ–ª—ã–µ –∏ –≤ –ø—Ä–∞–≤–æ–º —É–≥–ª—É */
        .list-ticks {
            display: inline-flex;
            font-size: 14px; /* –ß—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ */
            color: white !important; /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –±–µ–ª—ã–µ */
        }

            .list-ticks span {
                color: white !important;
            }

        .badge-count {
            background: #736AF0;
            color: white;
            font-size: 12px;
            padding: 2px 9px;
            border-radius: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            line-height: 1.2;
            display: none;
        }

            .badge-count:not(.hidden) {
                display: block;
            }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: transparent;
            position: relative;
            z-index: 1;
        }



        /* –§–æ–Ω —Å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç" */
        #noChat {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            position: relative;
            overflow: hidden;
        }

        #noChat {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            position: relative;
            overflow: hidden;
            background-color: #0a0c10;
        }

            #noChat > div {
                position: relative;
                z-index: 2;
                font-size: 18px;
                font-weight: 500;
            }

        @keyframes scrollPattern {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(-10%, -10%);
            }
        }

        .chat-header {
            padding: 10px 15px;
            background: #1f1f1f;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 60px;
        }

        .back-btn {
            display: none;
            background: none;
            border: none;
            color: #007bff;
            font-size: 24px;
            cursor: pointer;
            padding-right: 15px;
        }

        .chat-header-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
        }

        .chat-title {
            font-weight: bold;
            font-size: 16px;
        }

        .chat-status {
            font-size: 12px;
            color: #888;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* –î–æ–±–∞–≤–ª—è–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
            width: 100%;
            max-width: 900px; /* –®–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ –∫–∞–∫ –≤ Telegram */
            margin: 0 auto; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–∞–º—É –∫–æ–ª–æ–Ω–∫—É */
            background: transparent; /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ñ–æ–Ω –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π */
            /* –£–±–∏—Ä–∞–µ–º position: relative, –µ—Å–ª–∏ –æ–Ω –º–µ—à–∞–µ—Ç —Ñ–æ–Ω—É, –Ω–æ –æ–±—ã—á–Ω–æ –Ω–µ –º–µ—à–∞–µ—Ç */
            position: relative;
            z-index: 1;
        }



            /* –í–∞–∂–Ω–æ! –°–æ–æ–±—â–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –í–´–®–ï —Ñ–æ–Ω–∞ */
            .messages > * {
                position: relative;
                z-index: 1;
            }

        .input-bar {
            padding: 10px 20px;
            background: transparent; /* –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Ñ–æ–Ω */
            display: flex;
            justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤—Å—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 900px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É, —á—Ç–æ–±—ã –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –±—ã–ª–æ –Ω–µ —Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–æ */
            margin: 0 auto; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–∞–º –±–ª–æ–∫ */
            position: relative;
            z-index: 5;
        }

        .input-container {
            flex: 1;
            display: flex;
            align-items: center;
            background: #1f1f1f; /* –§–æ–Ω —Å–∞–º–æ–≥–æ –ø–æ–ª—è –≤–≤–æ–¥–∞ */
            border-radius: 25px; /* –°–∏–ª—å–Ω–æ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
            padding: 5px 15px;
            border: 1px solid #333;
            position: relative;
        }

            .input-container input {
                flex: 1;
                background: transparent;
                border: none;
                color: white;
                padding: 10px;
                font-size: 15px;
                outline: none;
            }



        /* –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä–µ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª—è */
        .attach-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: 0.2s;
        }

            .attach-btn:hover {
                color: #ccc;
            }



        /* –ö—Ä—É–≥–ª–∞—è –∫–Ω–æ–ø–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞/–æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ø—Ä–∞–≤–∞ */
        .voice-btn, .send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: 0.2s;
            flex-shrink: 0;
        }

        .voice-btn {
            background: #2d2d2d; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ */
            color: white;
        }

            .voice-btn:hover {
                background: #333;
            }

        .send-btn {
            background: #007bff; /* –°–∏–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ */
            color: white;
            padding-left: 5px; /* –í–∏–∑—É–∞–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–µ–ª–æ—á–∫—É */
        }

            .send-btn:hover {
                background: #0056b3;
            }

        .input-bar input {
            flex: 1;
            padding: 12px;
            border-radius: 20px;
            border: 1px solid #444;
            background: #2d2d2d;
            color: white;
        }



        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è */
        .msg {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.4;
            position: relative;
            cursor: pointer;
            word-wrap: break-word; /* –ß—Ç–æ–±—ã –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª–∏—Å—å */
        }



        /* –°–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–ø—Ä–∞–≤–∞) - —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ */
        .msg-me {
            align-self: flex-end;
            background: #736AF0; /* –ö—Ä–∞—Å–∏–≤—ã–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ */
            color: white;
            border-bottom-right-radius: 2px;
        }



        /* –ß—É–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–ª–µ–≤–∞) - —Å–µ—Ä—ã–µ */
        .msg-other {
            align-self: flex-start;
            background: #2d2d2d; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π */
            color: white;
            border-bottom-left-radius: 2px;
        }



        /* –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ —Ü–µ–Ω—Ç—Ä—É) */
        .msg-sys {
            align-self: center;
            background: rgba(34, 34, 34, 0.8);
            border: 1px solid #444;
            font-size: 13px;
            color: #aaa;
            padding: 4px 10px;
            border-radius: 10px;
        }



        /* –ë–ª–æ–∫ –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–≤—Ä–µ–º—è + –≥–∞–ª–æ—á–∫–∏) */

        /* –ú–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–≤—Ä–µ–º—è + –≥–∞–ª–æ—á–∫–∏) */

        /* –ú–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–≤—Ä–µ–º—è + –≥–∞–ª–æ—á–∫–∏) */
        .msg-meta {
            float: right;
            margin-left: 7px;
            margin-top: 6px;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            vertical-align: bottom;
            position: relative;
            top: 3px;
            white-space: nowrap; /* –í–∞–∂–Ω–æ: –∑–∞–ø—Ä–µ—â–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–∞-–±–ª–æ–∫–∞ */
            height: 14px;
            line-height: 1;
        }

        .msg-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-right: 2px;
        }

        .msg-ticks {
            font-size: 12px;
            color: white; /* –í—Å–µ–≥–¥–∞ –±–µ–ª—ã–µ */
            display: none;
            font-weight: bold;
        }

        .msg-me .msg-ticks {
            display: inline-block;
        }



        /* –ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –≥–∞–ª–æ—á–∫–∏ (—Ç–µ–ø–µ—Ä—å –æ–Ω–∏ —Ç–æ–∂–µ –±–µ–ª—ã–µ, —Ü–≤–µ—Ç –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è) */
        .tick-read {
            color: white;
        }



        /* –®—Ç–æ—Ä–∫–∏ */
        .overlay-sheet {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 4999;
            display: none;
        }

        .search-section-title {
            padding: 8px 15px;
            font-size: 12px;
            font-weight: bold;
            color: #007bff;
            background: #2a2a2a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-sheet {
            /* –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ */
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #1f1f1f;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            padding: 20px;
            z-index: 5000;
            transform: translateY(100%);
            /* –î–û–ë–ê–í–õ–Ø–ï–ú –≠–¢–û: —Å–∫—Ä—ã–≤–∞–µ–º –æ—Ç —Ç–∞–±–∞/—Ñ–æ–∫—É—Å–∞, –∫–æ–≥–¥–∞ –∑–∞–∫—Ä—ã—Ç–æ */
            visibility: hidden;
            transition: transform 0.3s, visibility 0s linear 0.3s;
        }

            .action-sheet.open {
                transform: translateY(0);
                /* –î–û–ë–ê–í–õ–Ø–ï–ú –≠–¢–û: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ */
                visibility: visible;
                transition: transform 0.3s, visibility 0s;
            }

        .action-btn {
            background: #2d2d2d;
            border: none;
            padding: 15px;
            color: white;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
        }

            .action-btn:active {
                background: #333;
            }

            .action-btn.delete {
                color: #ff4444;
            }

        .sheet-title {
            color: #777;
            font-size: 13px;
            text-align: center;
            margin-bottom: 5px;
        }



        /* –ü—Ä–æ—Ñ–∏–ª—å –®—Ç–æ—Ä–∫–∞ */
        .profile-option {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

            .profile-option h3 {
                margin: 0 0 10px 0;
                font-size: 15px;
                color: #ddd;
            }

        .profile-input-group {
            display: flex;
            gap: 10px;
        }



        /* –ó–≤–æ–Ω–∫–∏ */
        .call-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 4000;
            display: none;
            flex-direction: column;
            transition: opacity 0.5s;
        }

        .video-grid {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        .local-video-container {
            position: absolute;
            bottom: 160px;
            right: 20px;
            /* –£–í–ï–õ–ò–ß–ï–ù–ù–´–ï –†–ê–ó–ú–ï–†–´ */
            width: 140px; /* –ë—ã–ª–æ 100px */
            height: 210px; /* –ë—ã–ª–æ 150px (–ø—Ä–æ–ø–æ—Ä—Ü–∏—è 2:3 —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞) */
            /* –ö–†–ê–°–ò–í–û–ï –°–ö–†–£–ì–õ–ï–ù–ò–ï */
            border-radius: 18px; /* –°–∏–ª—å–Ω–µ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–æ (–±—ã–ª–æ 10px) */
            overflow: hidden;
            /* –£–¢–û–ù–ß–ï–ù–ù–ê–Ø –†–ê–ú–ö–ê */
            border: 2px solid rgba(255, 255, 255, 0.2); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –±–µ–ª–∞—è —Ä–∞–º–∫–∞ –≤—ã–≥–ª—è–¥–∏—Ç —Å—Ç–∏–ª—å–Ω–µ–µ */
            /* –¢–ï–ù–¨ –î–õ–Ø –û–ë–™–ï–ú–ê */
            box-shadow: 0 8px 25px rgba(0,0,0,0.6);
            z-index: 4002;
            display: block;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è */
        }

        #localVideo {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important; /* <--- –£–±–∏—Ä–∞–µ—Ç —á–µ—Ä–Ω—ã–µ –ø–æ–ª–æ—Å—ã, –æ–±—Ä–µ–∑–∞—è –ª–∏—à–Ω–µ–µ */
            position: absolute; /* <--- –§–∏–∫—Å–∏—Ä—É–µ—Ç –≤–∏–¥–µ–æ –≤ —É–≥–ª—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            top: 0;
            left: 0;
            background: #000;
        }

            #localVideo.mirror {
                transform: scaleX(-1);
            }

        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px 10px 40px 10px;
            z-index: 4003;
            background: #18191c;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 70px;
        }

        .control-label {
            font-size: 11px;
            color: #b5bac1;
            white-space: nowrap;
        }

        .btn-circle {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            transition: 0.2s;
            background: #2b2d31;
            color: #dbdee1;
        }

            .btn-circle:active {
                transform: scale(0.95);
            }

        .btn-active-white {
            background: #f2f3f5 !important;
            color: #313338 !important;
        }

        .btn-hangup {
            background: #da373c !important;
            color: white !important;
        }

        .btn-screen-on {
            background: #248046 !important;
            color: white !important;
        }

        .incoming-call {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #222;
            padding: 15px 25px;
            border-radius: 30px;
            z-index: 5000;
            display: none;
            align-items: center;
            gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            border: 1px solid #444;
            width: 90%;
            max-width: 400px;
            justify-content: space-between;
        }

        .timer-badge {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            border-radius: 20px;
            color: #fff;
            z-index: 4003;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
        }

        #callStatusText {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #callTimer {
            font-size: 18px;
            font-family: monospace;
            font-weight: bold;
        }

        #callPing {
            font-size: 11px;
            color: #4caf50;
            margin-top: 5px;
            opacity: 0.9;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                border-right: none;
            }

            .chat-area {
                display: none;
                width: 100%;
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 20;
            }

                .chat-area.active {
                    display: flex;
                }

            .sidebar.hidden-mobile {
                display: none;
            }

            .back-btn {
                display: block;
            }
        }



        /* –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ (—Å—Ç–∏–ª—å Telegram) */
        #searchResults {
            /* –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ "–ø–æ–≤–µ—Ä—Ö" */
            position: relative;
            top: 0;
            left: 0;
            right: 0;
            background: transparent; /* –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω, —á—Ç–æ–±—ã –±—ã–ª –æ–±—â–∏–π */
            border: none;
            border-radius: 0;
            box-shadow: none;
            /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤—Å—é –≤—ã—Å–æ—Ç—É */
            flex: 1;
            overflow-y: auto;
            display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            flex-direction: column;
            z-index: 10;
        }

            #searchResults.active {
                display: flex;
            }






        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ –≤ –ø–æ–∏—Å–∫–µ */
        .search-section-title {
            padding: 10px 15px;
            font-size: 13px;
            font-weight: bold;
            color: #007bff;
            background: rgba(0, 123, 255, 0.05);
            text-transform: uppercase;
        }



        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ */
        .search-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            gap: 12px;
            cursor: pointer;
            border-bottom: 1px solid #2a2a2a;
        }

            .search-item:hover {
                background: #2a2a2a;
            }

            .search-item img, .search-avatar-placeholder {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
            }

        .search-info {
            flex: 1;
            overflow: hidden;
        }

        .search-name {
            font-weight: bold;
            color: white;
            font-size: 15px;
        }

        .search-sub {
            font-size: 13px;
            color: #888;
        }

        .search-action {
            color: #007bff;
            font-size: 20px;
            padding-right: 5px;
        }



        /* 1. –û–±—â–∏–π —Ñ–æ–Ω –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        #app-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* –õ–µ–∂–∏—Ç –ø–æ–¥ –≤—Å–µ–º */
            background-color: #0a0c10;
        }

            #app-background::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                opacity: 0.7;
                pointer-events: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='500' height='500' viewBox='0 0 500 500'%3E%3Cstyle%3E text %7B font-family: 'Segoe UI Emoji', 'Apple Color Emoji', sans-serif; %7D %3C/style%3E%3C!-- –ò–ö–û–ù–ö–ò --%3E%3Ctext x='40' y='60' font-size='36' fill='%234a9eff' fill-opacity='0.4' transform='rotate(12 40 60)'%3EüéÆ%3C/text%3E%3Ctext x='380' y='120' font-size='40' fill='%237c3aed' fill-opacity='0.35' transform='rotate(-15 380 120)'%3EüöÄ%3C/text%3E%3Ctext x='220' y='400' font-size='38' fill='%2306b6d4' fill-opacity='0.4' transform='rotate(8 220 400)'%3Eüéß%3C/text%3E%3Ctext x='180' y='90' font-size='28' fill='%23ec4899' fill-opacity='0.35' transform='rotate(-10 180 90)'%3Eüí°%3C/text%3E%3Ctext x='90' y='250' font-size='30' fill='%2310b981' fill-opacity='0.3' transform='rotate(20 90 250)'%3Eüçï%3C/text%3E%3Ctext x='340' y='320' font-size='26' fill='%23f59e0b' fill-opacity='0.35' transform='rotate(-8 340 320)'%3E‚öΩ%3C/text%3E%3Ctext x='420' y='450' font-size='32' fill='%236366f1' fill-opacity='0.4' transform='rotate(15 420 450)'%3Eüì∑%3C/text%3E%3Ctext x='300' y='180' font-size='20' fill='%238b5cf6' fill-opacity='0.25' transform='rotate(-20 300 180)'%3Eüé∏%3C/text%3E%3Ctext x='150' y='350' font-size='22' fill='%2314b8a6' fill-opacity='0.3' transform='rotate(25 150 350)'%3Eüíª%3C/text%3E%3Ctext x='450' y='260' font-size='18' fill='%23ef4444' fill-opacity='0.3' transform='rotate(-12 450 260)'%3EüèÜ%3C/text%3E%3Ctext x='60' y='430' font-size='24' fill='%233b82f6' fill-opacity='0.35' transform='rotate(18 60 430)'%3Eüé≤%3C/text%3E%3Ctext x='280' y='50' font-size='20' fill='%23a855f7' fill-opacity='0.3' transform='rotate(-5 280 50)'%3Eüëª%3C/text%3E%3C/svg%3E");
                background-size: 400px 400px;
            }

            #app-background::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: radial-gradient(circle at 50% 50%, rgba(10, 12, 16, 0.3) 0%, rgba(10, 12, 16, 0.7) 100%);
                pointer-events: none;
            }



        /* 2. –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω—ã —É –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –±–ª–æ–∫–æ–≤, —á—Ç–æ–±—ã –ø—Ä–æ—Å–≤–µ—á–∏–≤–∞–ª –æ–±—â–∏–π —Ñ–æ–Ω */
        body {
            background: transparent; /* –ë—ã–ª–æ 121212 */
        }

        .chat-area {
            background: transparent; /* –ë—ã–ª–æ 0d1117 */
        }

        #noChat {
            background: transparent; /* –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω –æ—Ç—Å—é–¥–∞ */
            /* –£–±–∏—Ä–∞–µ–º –ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç—ã ::before –∏ ::after —É #noChat, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –æ–±—â–∏–π —Ñ–æ–Ω */
        }



        /* –ï—Å–ª–∏ —É –≤–∞—Å –æ—Å—Ç–∞–ª–∏—Å—å —Å—Ç–∏–ª–∏ –¥–ª—è #noChat::before –∏ #noChat::after - –£–î–ê–õ–ò–¢–ï –ò–• */
        .messages {
            background: transparent; /* –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω */
            /* –£–±–∏—Ä–∞–µ–º –ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç—ã ::before –∏ ::after —É .messages */
        }



            /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è Chrome, Safari –∏ Opera */
            .messages::-webkit-scrollbar {
                display: none;
            }



        /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è IE, Edge –∏ Firefox */
        .messages {
            -ms-overflow-style: none; /* IE –∏ Edge */
            scrollbar-width: none; /* Firefox */
        }



        /* PIP drag/resize */
        #localPip {
            /* –≤–∞–∂–Ω–æ: –±—É–¥–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ left/top –≤–Ω—É—Ç—Ä–∏ .video-grid (–æ–Ω–∞ position: relative) */
            touch-action: none;
            user-select: none;
            cursor: grab;
        }

            #localPip.dragging,
            #localPip.resizing {
                transition: none !important; /* —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ "—Ä–µ–∑–∏–Ω—ã" –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */
            }

            #localPip.dragging {
                cursor: grabbing;
            }



            /* —á—Ç–æ–±—ã drag —Ä–∞–±–æ—Ç–∞–ª –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–∞–ø–∞–µ—à—å –ø–æ —Å–∞–º–æ–º—É –≤–∏–¥–µ–æ */
            #localPip > video {
                pointer-events: none;
            }



            /* –†—É—á–∫–∞ —Ä–µ—Å–∞–π–∑–∞ */
            #localPip .pip-resize-handle {
                position: absolute;
                right: 8px;
                bottom: 8px;
                width: 22px;
                height: 22px;
                border-radius: 7px;
                cursor: nwse-resize;
                background: rgba(255,255,255,0.16);
                border: 1px solid rgba(255,255,255,0.22);
                box-shadow: 0 6px 16px rgba(0,0,0,0.35);
                backdrop-filter: blur(8px);
            }



                /* –Ω–µ–±–æ–ª—å—à–æ–π ‚Äú–±–ª–∏–∫‚Äù, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ UI-—ç–ª–µ–º–µ–Ω—Ç */
                #localPip .pip-resize-handle::after {
                    content: "";
                    position: absolute;
                    inset: 6px;
                    border-right: 2px solid rgba(255,255,255,0.55);
                    border-bottom: 2px solid rgba(255,255,255,0.55);
                    border-radius: 2px;
                    transform: rotate(0deg);
                }



        /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–æ–∫ */
        .control-item-hidden {
            display: none !important;
        }



        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –≤ —á–∞—Ç–µ */
        .chat-media-img {
            max-width: 240px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É */
            max-height: 300px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É */
            border-radius: 12px;
            cursor: pointer;
            display: block;
            margin-bottom: 2px;
            object-fit: cover;
            background: #222; /* –§–æ–Ω –ø–æ–∫–∞ –≥—Ä—É–∑–∏—Ç—Å—è */
        }



        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤ */
        .chat-file-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.08); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –ø–æ–¥–ª–æ–∂–∫–∞ */
            border-radius: 10px;
            text-decoration: none;
            max-width: 260px;
            transition: 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }

            .chat-file-card:hover {
                background: rgba(255, 255, 255, 0.12);
            }

        .file-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .file-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .file-name {
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .file-action {
            color: #8faebf;
            font-size: 11px;
            margin-top: 2px;
        }



        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –≥–∞–ª–æ—á–µ–∫ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
        .msg-meta {
            display: inline-block;
            vertical-align: bottom;
            margin-left: 5px;
        }



        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ö–ê–†–¢–ò–ù–û–ö –í –ß–ê–¢–ï --- */
        .chat-media-img {
            /* –î–µ–ª–∞–µ–º –∏—Ö –∫—Ä—É–ø–Ω–µ–µ */
            width: 100%;
            max-width: 320px; /* –ë—ã–ª–æ 240, —Å—Ç–∞–ª–æ —à–∏—Ä–µ */
            height: auto; /* –ê–≤—Ç–æ-–≤—ã—Å–æ—Ç–∞, —á—Ç–æ–±—ã –Ω–µ –∏—Å–∫–∞–∂–∞–ª–æ—Å—å */
            max-height: 400px;
            border-radius: 12px;
            cursor: zoom-in; /* –ö—É—Ä—Å–æ—Ä –ª—É–ø—ã */
            display: block;
            object-fit: cover;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); /* –¢–µ–Ω—å –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
            transition: transform 0.2s;
        }

            .chat-media-img:active {
                transform: scale(0.98); /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è */
            }

        .media-container {
            overflow: hidden;
            border-radius: 12px;
            background: transparent; /* –£–±–∏—Ä–∞–µ–º —á–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
            display: inline-block;
        }



        /* --- –°–¢–ò–õ–ò –î–õ–Ø –í–°–ü–õ–´–í–ê–Æ–©–ï–ì–û –û–ö–ù–ê (LIGHTBOX) --- */
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9); /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            z-index: 9999; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
            backdrop-filter: blur(5px); /* –†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ */
        }

            .image-viewer.active {
                display: flex;
                opacity: 1;
            }

            .image-viewer img {
                max-width: 95%;
                max-height: 95%;
                border-radius: 8px;
                box-shadow: 0 0 20px rgba(0,0,0,0.5);
                transform: scale(0.9);
                transition: transform 0.3s;
            }

            .image-viewer.active img {
                transform: scale(1);
            }

        .close-viewer-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
        }



        /* –ö—Ä—É—Ç–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
        .upload-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            z-index: 10;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        @keyframes spin {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }



        /* --- –°—Ç–∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è –∫–∞–∫ –≤ Telegram --- */

        /* –§–æ–Ω —à–∞–ø–∫–∏ (–∑–µ–ª–µ–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω) */
        .tg-header-bg {
            background: #5a9e57;
            /* –ò–ó–ú–ï–ù–ï–ù–û: —É—á–∏—Ç—ã–≤–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–æ–Ω—É —Å–≤–µ—Ä—Ö—É (—á–µ–ª–∫—É) */
            padding: calc(10px + env(safe-area-inset-top)) 15px 20px 15px;
            color: white;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .tg-header-top {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .tg-icon-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .tg-profile-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }



        /* –ê–≤–∞—Ç–∞—Ä–∫–∞ */
        .tg-avatar-large {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #333;
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #aaa;
            border: 2px solid white; /* –ë–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞ –∫–∞–∫ –≤ –¥–∏–∑–∞–π–Ω–µ */
        }

            .tg-avatar-large img {
                width: 100%;
                height: 100%;
                border-radius: 50%;
                object-fit: cover;
            }

        .tg-avatar-edit-icon {
            position: absolute;
            bottom: -2px;
            right: -2px;
            background: #4a8e4a;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #5a9e57;
        }



        /* –ò–º—è –∏ —Å—Ç–∞—Ç—É—Å */
        .tg-profile-name-block {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .tg-name-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            font-weight: 600;
            width: 100%;
            outline: none;
            padding: 0;
        }

            .tg-name-input::placeholder {
                color: rgba(255,255,255,0.6);
            }

        .tg-profile-status {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            margin-top: 4px;
        }



        /* –°–ø–∏—Å–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        .tg-settings-list {
            background: #17212b; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω —Å–ø–∏—Å–∫–∞ */
            padding-top: 10px;
        }

        .tg-section-title {
            color: #7394ae; /* –ì–æ–ª—É–±–æ–π —Ü–≤–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
            font-size: 13px;
            font-weight: bold;
            padding: 15px 20px 5px 20px;
            text-transform: uppercase;
        }

        .tg-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            transition: 0.2s;
        }

            .tg-item:hover {
                background: #202b36;
            }

        .tg-item-icon {
            font-size: 22px;
            width: 40px;
            text-align: center;
            margin-right: 15px;
            color: #8faebf;
        }

        .tg-item-content {
            flex: 1;
            border-bottom: 1px solid #0e1621; /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
            padding-bottom: 10px;
            padding-top: 5px;
        }

        .tg-item:last-child .tg-item-content {
            border-bottom: none;
        }

        .tg-input-clean {
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            width: 100%;
            outline: none;
            padding: 0;
            margin-bottom: 3px;
        }

        .tg-item-label {
            color: #7f91a4;
            font-size: 12px;
        }

        .tg-item-value {
            color: white;
            font-size: 16px;
            margin-bottom: 3px;
        }

        .tg-divider {
            height: 10px;
            background: #0e1621; /* –¢–µ–º–Ω–∞—è –ø–æ–ª–æ—Å–∞ –º–µ–∂–¥—É —Å–µ–∫—Ü–∏—è–º–∏ */
            margin: 5px 0;
        }


        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .full-screen-sheet {
            top: 0;
            height: 100% !important;
            background: #181818 !important;
            display: flex;
            flex-direction: column;
            z-index: 6000;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            /* –î–û–ë–ê–í–õ–ï–ù–û: —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ action-sheet */
            padding: 0 !important;
            border-radius: 0 !important;
        }

            .full-screen-sheet.open {
                transform: translateY(0);
            }

        .edit-content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }


        /* –ê–≤–∞—Ç–∞—Ä —Å–µ–∫—Ü–∏—è */
        .edit-avatar-section {
            display: flex;
            justify-content: center;
            padding: 30px 0;
            background: #181818;
        }

        .edit-avatar-wrapper {
            width: 100px;
            height: 100px;
            position: relative;
            cursor: pointer;
        }


        /* --- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å (Toggle Switch) --- */
        .tg-switch {
            position: relative;
            display: inline-block;
            width: 42px;
            height: 24px;
        }

            .tg-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555; /* –°–µ—Ä—ã–π –≤—ã–∫–ª */
            transition: .4s;
            border-radius: 24px;
        }

            .slider:before {
                position: absolute;
                content: "";
                height: 18px;
                width: 18px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
            }

        input:checked + .slider {
            background-color: #8774e1; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –≤–∫–ª */
        }

            input:checked + .slider:before {
                transform: translateX(18px);
            }

        .edit-avatar-wrapper img, .avatar-placeholder-large {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .avatar-placeholder-large {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            color: white;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }


        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ (Material Design —Å—Ç–∏–ª—å) */
        .edit-form-group {
            padding: 10px 20px;
        }

        .tg-input-field {
            position: relative;
            margin-bottom: 24px;
            background: transparent;
            border: 1px solid #444; /* –†–∞–º–∫–∞ */
            border-radius: 12px;
            padding: 0;
        }

            .tg-input-field input, .tg-input-field textarea {
                width: 100%;
                background: transparent;
                border: none;
                color: white;
                font-size: 16px;
                padding: 14px 12px;
                outline: none;
                border-radius: 12px;
            }

            .tg-input-field textarea {
                resize: none;
                min-height: 50px;
            }


            /* –ü–ª–∞–≤–∞—é—â–∏–π –ª–µ–π–±–ª */
            .tg-input-field label {
                position: absolute;
                left: 12px;
                top: 14px;
                color: #888;
                font-size: 16px;
                pointer-events: none;
                transition: 0.2s ease all;
                background: #181818;
                padding: 0 4px;
            }


            /* –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ–∫—É—Å–∞ –∏–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ */
            .tg-input-field input:focus ~ label,
            .tg-input-field input:not(:placeholder-shown) ~ label,
            .tg-input-field textarea:focus ~ label,
            .tg-input-field textarea:not(:placeholder-shown) ~ label {
                top: -10px;
                font-size: 12px;
                color: #8774e1;
            }

            .tg-input-field input:focus, .tg-input-field textarea:focus {
                border-color: #8774e1; /* –¶–≤–µ—Ç –∞–∫—Ü–µ–Ω—Ç–∞ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
            }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ —è–∑—ã–∫–æ–≤ */
        .lang-option {
            padding: 12px 15px;
            background: #333;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            color: white;
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }

            .lang-option:hover {
                background: #444;
            }

            .lang-option:active {
                background: #555;
            }

        .char-counter {
            position: absolute;
            bottom: -20px;
            right: 5px;
            font-size: 12px;
            color: #888;
        }

        .field-hint {
            font-size: 13px;
            color: #888;
            margin-top: -15px;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .edit-separator {
            height: 12px;
            background: #0f0f0f;
            border-top: 1px solid #222;
            border-bottom: 1px solid #222;
            margin-bottom: 15px;
        }

        .section-header {
            color: #8774e1;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 15px;
            text-transform: uppercase;
        }



        /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading-overlay img {
            filter: brightness(0.5) blur(2px);
            transition: 0.3s;
        }



        /* –≠—Ñ—Ñ–µ–∫—Ç –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ */
        .click-to-copy {
            cursor: pointer;
            position: relative;
        }

            .click-to-copy:active {
                background-color: #202b36;
            }



        /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7); /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            z-index: 20000; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            animation: fadeIn 0.2s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }


        /* –°–∞–º–æ –æ–∫–Ω–æ */
        .delete-modal {
            background: #252525;
            width: 90%;
            max-width: 320px;
            border-radius: 16px;
            padding: 22px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            transform: scale(0.9);
            animation: scaleUp 0.2s forwards;
        }

        @keyframes scaleUp {
            to {
                transform: scale(1);
            }
        }

        .delete-modal h3 {
            margin: 0;
            font-size: 18px;
            color: white;
            font-weight: 600;
        }

        .delete-modal p {
            margin: 0;
            font-size: 15px;
            color: #ccc;
            line-height: 1.4;
        }


        /* –ß–µ–∫–±–æ–∫—Å */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

            .checkbox-container input[type="checkbox"] {
                appearance: none;
                width: 20px;
                height: 20px;
                border: 2px solid #888;
                border-radius: 6px;
                background: transparent;
                cursor: pointer;
                position: relative;
                transition: 0.2s;
            }

                .checkbox-container input[type="checkbox"]:checked {
                    background: #8774e1; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç –∫–∞–∫ –≤ TG */
                    border-color: #8774e1;
                }

                    .checkbox-container input[type="checkbox"]:checked::after {
                        content: '‚úì';
                        position: absolute;
                        color: white;
                        font-size: 14px;
                        left: 3px;
                        top: -1px;
                        font-weight: bold;
                    }

            .checkbox-container label {
                font-size: 15px;
                color: white;
                cursor: pointer;
                user-select: none;
            }


        /* –ö–Ω–æ–ø–∫–∏ */
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 10px;
        }

            .modal-buttons button {
                background: none;
                border: none;
                font-size: 15px;
                font-weight: bold;
                cursor: pointer;
                padding: 5px 10px;
                border-radius: 6px;
                transition: 0.2s;
            }

        .btn-cancel {
            color: #8774e1; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π */
        }

            .btn-cancel:hover {
                background: rgba(135, 116, 225, 0.1);
            }

        .btn-confirm {
            color: #ff595a; /* –ö—Ä–∞—Å–Ω—ã–π */
        }

            .btn-confirm:hover {
                background: rgba(255, 89, 90, 0.1);
            }


        /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
        .context-menu {
            position: fixed;
            z-index: 10000;
            width: 220px;
            background: transparent;
            display: none; /* –°–∫—Ä—ã—Ç–æ */
            flex-direction: column;
            gap: 8px;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.2s, transform 0.2s;
        }

            .context-menu.active {
                display: flex;
                opacity: 1;
                transform: scale(1);
            }


        /* –ë–∞—Ä —Ä–µ–∞–∫—Ü–∏–π —Å–≤–µ—Ä—Ö—É */
        .reactions-bar {
            background: #252525;
            padding: 8px;
            border-radius: 14px;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

            .reactions-bar span {
                font-size: 20px;
                cursor: pointer;
                transition: transform 0.2s;
            }

                .reactions-bar span:hover {
                    transform: scale(1.2);
                }


        /* –û—Å–Ω–æ–≤–Ω–æ–π —Å–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
        .context-list {
            background: #252525; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –º–µ–Ω—é –∫–∞–∫ –≤ TG */
            border-radius: 14px;
            padding: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        .context-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.1s;
        }

            .context-item:hover {
                background: #333; /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
            }

        .context-icon {
            margin-right: 12px;
            font-size: 16px;
            width: 20px;
            text-align: center;
        }


        /* –ö—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */
        .context-item.delete {
            color: #ff595a;
        }

            .context-item.delete .context-icon {
                filter: grayscale(0) !important; /* –ß—Ç–æ–±—ã –∏–∫–æ–Ω–∫–∞ –Ω–µ –±—ã–ª–∞ —Å–µ—Ä–æ–π */
            }

        .context-divider {
            height: 1px;
            background: #383838;
            margin: 4px 10px;
        }


        /* –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (Toast) */
        #toast-notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 7000;
            pointer-events: none;
        }

            #toast-notification.show {
                opacity: 1;
            }

        .tg-bio-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            width: 100%;
            outline: none;
            resize: none;
            font-family: inherit;
            padding: 0;
            margin-bottom: 3px;
            min-height: 24px;
        }

            .tg-bio-input::placeholder {
                color: rgba(255, 255, 255, 0.4);
            }



        /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–µ–Ω—é (–∫–∞–∫ –≤ Telegram) */
        .action-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            background: #252525;
            transition: background 0.2s;
        }

            .action-item:hover {
                background: #2f2f2f;
            }

        .action-icon {
            font-size: 20px;
            margin-right: 15px;
            width: 24px;
            text-align: center;
        }

        .action-text {
            font-size: 16px;
            color: white;
        }


        /* –ü–∞–Ω–µ–ª—å –æ—Ç–≤–µ—Ç–∞ –Ω–∞–¥ –≤–≤–æ–¥–æ–º */
        .reply-bar {
            width: 100%;
            background: #1f1f1f;
            border-top: 1px solid #333;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            border-left: 3px solid #736AF0; /* –§–∏–æ–ª–µ—Ç–æ–≤–∞—è –ø–æ–ª–æ—Å–∫–∞ —Å–ª–µ–≤–∞ */
        }

            .reply-bar.editing {
                border-left: 3px solid #007bff; /* –°–∏–Ω—è—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
            }

        .reply-content {
            flex: 1;
            margin-left: 10px;
            overflow: hidden;
        }

        .reply-title {
            color: #736AF0;
            font-size: 13px;
            font-weight: bold;
        }

        .reply-text {
            color: #ccc;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reply-close {
            background: none;
            border: none;
            color: #888;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
        }


        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ü–∏—Ç–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .msg-reply-quote {
            border-left: 2px solid white;
            padding-left: 8px;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .msg-reply-name {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            font-weight: bold;
        }

        .msg-reply-text {
            font-size: 12px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .birth-modal {
            background: #252525;
            width: 92%;
            max-width: 360px;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .birth-pickers {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

            .birth-pickers select {
                width: 100%;
                background: #1f1f1f;
                border: 1px solid #444;
                color: white;
                padding: 12px 10px;
                border-radius: 12px;
                outline: none;
            }


        /* –ê–Ω–∏–º–∞—Ü–∏—è —Ç–æ—á–µ–∫ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç" */
        @keyframes blink {
            0% {
                opacity: .2;
            }

            20% {
                opacity: 1;
            }

            100% {
                opacity: .2;
            }
        }

        .typing-dots span {
            animation-name: blink;
            animation-duration: 1.4s;
            animation-iteration-count: infinite;
            animation-fill-mode: both;
        }

            .typing-dots span:nth-child(2) {
                animation-delay: .2s;
            }

            .typing-dots span:nth-child(3) {
                animation-delay: .4s;
            }

        .typing-text {
            color: #736AF0 !important; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—á–∞—Ç–∞–µ—Ç */
            font-weight: bold;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ */
        .translated-block {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
            color: #4a9eff; /* –ì–æ–ª—É–±–æ–π —Ü–≤–µ—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ */
            font-style: italic;
            display: block;
            animation: fadeIn 0.5s;
        }

        .translating-loader {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
        }

    </style>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
</head>
<body>
    <div id="app-background"></div>
    <audio id="ringtone" loop src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <!-- AUTH & REGISTRATION -->
    <div id="authScreen" class="auth-overlay">
        <!-- –®–ê–ì 1: –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <div id="stepEmail" class="auth-box">
            <h2>–í—Ö–æ–¥ –≤ Messenger</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="authAction()">–î–∞–ª–µ–µ</button>
            <div id="authError" style="color: #ff4444; margin-top: 10px; font-size: 13px;"></div>
        </div>
        <!-- –®–ê–ì 2: –ò–º—è –∏ –§–∞–º–∏–ª–∏—è -->
        <div id="stepName" class="auth-box" style="display: none;">
            <h2>–í–∞—à–µ –∏–º—è</h2>
            <div style="font-size: 13px; color: #aaa; margin-bottom: 15px;">
                –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ).
            </div>
            <input type="text" id="regName" placeholder="–ò–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" oninput="checkNameInput()">
            <input type="text" id="regSurname" placeholder="–§–∞–º–∏–ª–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            <button id="btnNameNext" onclick="goToUsernameStep()" disabled style="background: #444; cursor: not-allowed;">–î–∞–ª–µ–µ</button>
        </div>
        <!-- –®–ê–ì 3: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div id="stepUsername" class="auth-box" style="display: none;">
            <div style="display:flex; justify-content: flex-start;">
                <button onclick="backToName()" style="width: auto; background: none; color: #007bff; padding: 0; margin: 0 0 10px 0;">‚Üê –ù–∞–∑–∞–¥</button>
            </div>
            <h2>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <div style="font-size: 13px; color: #aaa; margin-bottom: 15px;">
                –í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –õ—é–¥–∏ —Å–º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –≤–∞—Å –ø–æ –Ω–µ–º—É.
            </div>
            <div style="position: relative;">
                <input type="text" id="regUsername" placeholder="@Username" oninput="checkUsernameInput()" style="padding-left: 10px;">
            </div>
            <div id="usernameStatus" style="font-size: 12px; text-align: left; margin-top: 5px; min-height: 15px;"></div>
            <button id="btnFinish" onclick="finishRegistration()" disabled style="background: #444; cursor: not-allowed; margin-top: 15px;">–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</button>
        </div>
    </div>
    <!-- INCOMING -->
    <div id="incomingPopup" class="incoming-call">
        <!-- –¢–µ–ø–µ—Ä—å –∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω span, –≤ –∫–æ—Ç–æ—Ä—ã–π –º—ã –±—É–¥–µ–º –ø–∏—Å–∞—Ç—å –ø–æ—á—Ç—É -->
        <span id="callerName" style="font-weight:bold; font-size: 14px;">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        <div style="display:flex; gap:15px;">
            <button onclick="answerCall()" class="btn-circle" style="background:#248046; width:45px; height:45px; font-size:18px;">üìû</button>
            <button onclick="rejectCall()" class="btn-circle btn-hangup" style="width:45px; height:45px; font-size:18px;">‚úñ</button>
        </div>
    </div>

    <div id="langModal" class="modal-overlay" style="display:none" onclick="closeLangModal()">
        <div class="delete-modal" onclick="event.stopPropagation()">
            <h3 style="margin-bottom: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</h3>

            <div class="lang-list-container" style="display:flex; flex-direction:column; gap:5px; max-height: 300px; overflow-y:auto;">
                <div class="lang-option" onclick="selectLanguage('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π (ru)</div>
                <div class="lang-option" onclick="selectLanguage('en')">üá¨üáß English (en)</div>
                <div class="lang-option" onclick="selectLanguage('de')">üá©üá™ Deutsch (de)</div>
                <div class="lang-option" onclick="selectLanguage('fr')">üá´üá∑ Fran√ßais (fr)</div>
                <div class="lang-option" onclick="selectLanguage('es')">üá™üá∏ Espa√±ol (es)</div>
                <div class="lang-option" onclick="selectLanguage('it')">üáÆüáπ Italiano (it)</div>
                <div class="lang-option" onclick="selectLanguage('tr')">üáπüá∑ T√ºrk√ße (tr)</div>
                <div class="lang-option" onclick="selectLanguage('uk')">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ (uk)</div>
            </div>

            <div class="modal-buttons" style="margin-top:15px;">
                <button class="btn-cancel" onclick="closeLangModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>


    <div id="generalSettingsSheet" class="action-sheet full-screen-sheet">
        <div class="tg-header-bg">
            <div class="tg-header-top">
                <button onclick="closeGeneralSettings()" class="tg-icon-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7" /></svg>
                </button>
                <div style="flex:1; font-weight: 500; font-size: 20px; margin-left: 10px;">–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
        </div>

        
    </div>


    <!-- –®–¢–ûÔøΩ –öÔøΩ? -->
    <div id="overlaySheet" class="overlay-sheet" onclick="closeAllSheets()"></div>
    <!-- –®—Ç–æ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="contextMenu" class="context-menu">
        <div class="reactions-bar">
            <span>üî•</span><span>üëç</span><span>‚ù§Ô∏è</span><span>ü•∞</span><span>üëè</span><span>üí©</span>
        </div>

        <div class="context-list">
            <div class="context-item" onclick="handleReply()">
                <span class="context-icon">‚Ü©Ô∏è</span> –û—Ç–≤–µ—Ç–∏—Ç—å
            </div>

            <div id="ctxEdit" class="context-item" onclick="handleEdit()">
                <span class="context-icon">‚úèÔ∏è</span> –ò–∑–º–µ–Ω–∏—Ç—å
            </div>

            <div class="context-item" onclick="handleCopy()">
                <span class="context-icon">üìÑ</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
            </div>

            <div class="context-item" onclick="alert('–§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç!')">
                <span class="context-icon">üìå</span> –ó–∞–∫—Ä–µ–ø–∏—Ç—å
            </div>

            <div class="context-divider"></div>

            <div class="context-item delete" onclick="openDeleteSheet()">
                <span class="context-icon">üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å
            </div>
        </div>
    </div>

    <div id="deleteModalOverlay" class="modal-overlay" style="display: none;" onclick="closeDeleteModal()">
        <div class="delete-modal" onclick="event.stopPropagation()">
            <h3>–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
            <p>–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?</p>

            <div class="checkbox-container" id="deleteForEveryoneBlock">
                <input type="checkbox" id="deleteForEveryone" checked>
                <label for="deleteForEveryone">–¢–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç—å –¥–ª—è <span id="deleteFriendName">User</span></label>
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeDeleteModal()">–û–¢–ú–ï–ù–ê</button>
                <button class="btn-confirm" onclick="executeDelete()">–£–î–ê–õ–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <!-- –û–ö–ù–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ü–†–û–§–ò–õ–Ø -->
    <div id="editProfileSheet" class="action-sheet full-screen-sheet">
        <div class="tg-header-bg">
            <div class="tg-header-top">
                <button onclick="closeEditProfile()" class="tg-icon-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7" /></svg>
                </button>
                <div style="flex:1; font-weight: 500; font-size: 20px; margin-left: 10px;">–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
                <button onclick="saveEditProfile()" class="tg-icon-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12" /></svg>
                </button>
            </div>
        </div>

        <div class="edit-content-scroll">
            <!-- –ê–≤–∞—Ç–∞—Ä -->
            <div class="edit-avatar-section">
                <div class="edit-avatar-wrapper" onclick="document.getElementById('editAvatarInput').click()">
                    <img id="editAvatarPreview" src="" style="display:none">
                    <div id="editAvatarPlaceholder" class="avatar-placeholder-large"></div>
                    <div class="camera-overlay">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" /><circle cx="12" cy="13" r="4" /></svg>
                    </div>
                </div>
                <input type="file" id="editAvatarInput" hidden accept="image/*" onchange="handleEditAvatarSelect(this)">
            </div>

            <!-- –ü–æ–ª—è –≤–≤–æ–¥–∞ -->
            <div class="edit-form-group">
                <div class="tg-input-field">
                    <input type="text" id="editName" placeholder=" " required>
                    <label>–ò–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                </div>

                <div class="tg-input-field">
                    <input type="text" id="editSurname" placeholder=" ">
                    <label>–§–∞–º–∏–ª–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                </div>

                <div class="tg-input-field">
                    <textarea id="editBio" placeholder=" " maxlength="70" rows="1" oninput="updateBioCounter(this)"></textarea>
                    <label>–û —Å–µ–±–µ</label>
                    <div class="char-counter" id="bioCounter">70</div>
                </div>
                <div class="field-hint">–õ—é–±—ã–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: –≤–æ–∑—Ä–∞—Å—Ç, —Ä–æ–¥ –∑–∞–Ω—è—Ç–∏–π –∏–ª–∏ –≥–æ—Ä–æ–¥.</div>
            </div>

            <div class="edit-separator"></div>

            <!-- –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è -->
            <div class="edit-form-group">
                <div class="section-label-row">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span style="font-weight: 500; color: #8774e1; margin-left: 10px;">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</span>
                </div>
                <div class="tg-input-field" style="margin-top:10px">
                    <input type="text" id="editBirthdateView" placeholder=" " readonly>
                    <label>–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</label>

                    <!-- –≤–∞–∂–Ω–æ: id —Ç–æ—Ç –∂–µ, —á—Ç–æ —É —Ç–µ–±—è –±—ã–ª, —á—Ç–æ–±—ã saveEditProfile() –Ω–µ –º–µ–Ω—è—Ç—å -->
                    <input type="hidden" id="editBirthdate">
                </div>
                <div class="field-hint">–í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å, –∫—Ç–æ –±—É–¥–µ—Ç –≤–∏–¥–µ—Ç—å –í–∞—à –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è, –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.</div>
            </div>

            <div class="edit-separator"></div>

            <!-- –Æ–∑–µ—Ä–Ω–µ–π–º -->
            <div class="edit-form-group">
                <div class="section-header">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                <div class="tg-input-field">
                    <input type="text" id="editUsername" placeholder=" " oninput="checkUsernameAvailability(this)">
                    <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                </div>
                <div class="field-hint">
                    –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –ø—É–±–ª–∏—á–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –¥—Ä—É–≥–∏–µ –ª—é–¥–∏ —Å–º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –í–∞—Å –ø–æ —Ç–∞–∫–æ–º—É –∏–º–µ–Ω–∏.
                </div>
                <div id="editUsernameStatus" class="field-hint" style="color: #4caf50; display: none;">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–≤–æ–±–æ–¥–Ω–æ.</div>
            </div>

            <div style="height: 100px;"></div> <!-- –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É -->
        </div>
    </div>



    <!-- –®—Ç–æ—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
    <div id="deleteSheet" class="action-sheet">
        <div class="sheet-title">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?</div>
        <button id="btnDelAll" class="action-btn delete" onclick="confirmDelete('all')">–£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö</button>
        <button class="action-btn delete" onclick="confirmDelete('me')">–£–¥–∞–ª–∏—Ç—å —É –º–µ–Ω—è</button>
        <button class="action-btn" onclick="closeAllSheets()">–û—Ç–º–µ–Ω–∞</button>
    </div>
    <!-- –®—Ç–æ—Ä–∫–∞ –üÔøΩ –û–§ÔøΩ?–õ–Ø (–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞) -->
    <!-- –ü–†–û–§–ò–õ–¨ -->
    <div id="profileSheet" class="action-sheet" style="padding: 0; background: #17212b; height: 100%; max-height: 100%; border-radius: 0;">

        <div class="tg-header-bg">
            <div class="tg-header-top">
                <button onclick="closeAllSheets()" class="tg-icon-btn">‚Üê</button>
                <div style="flex:1; font-weight: 500; font-size: 18px;">–ü—Ä–æ—Ñ–∏–ª—å</div>
                <button onclick="openEditProfile()" class="tg-icon-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <button onclick="logout()" class="tg-icon-btn" style="margin-left: 5px;">‚ãÆ</button>
            </div>

            <div class="tg-profile-info">
                <div class="tg-avatar-large" onclick="viewProfileAvatar()">
                    <img id="profileAvatarPreview" src="" style="display:none">
                    <div id="profileAvatarPlaceholder">üë§</div>
                </div>

                <div class="tg-profile-name-block">
                    <input type="text" id="profileName" class="tg-name-input" placeholder="–ò–º—è" readonly onblur="if(this.value.trim() === '') this.value = 'User'">
                    <input type="text" id="profileSurname" class="tg-name-input" placeholder="" readonly style="font-size: 16px; margin-top: 2px; font-weight: normal;">
                    <div class="tg-profile-status">–≤ —Å–µ—Ç–∏</div>
                </div>
            </div>
        </div>

        <div class="tg-settings-list" style="overflow-y: auto; height: calc(100% - 140px);">

            <div class="tg-section-title">–ê–∫–∫–∞—É–Ω—Ç</div>

            <div class="tg-item click-to-copy" onclick="copyData('profileEmail', 'Email')">
                <div class="tg-item-icon">üìû</div>
                <div class="tg-item-content">
                    <div class="tg-item-value" id="profileEmail" style="font-size: 16px; color: #fff;"></div>
                    <div class="tg-item-label">Email</div>
                </div>
            </div>

            <div class="tg-item click-to-copy" onclick="copyData('profileUsername', 'Username')">
                <div class="tg-item-icon">@</div>
                <div class="tg-item-content">
                    <div class="tg-item-value" id="profileUsername" style="font-size: 16px; color: #fff;"></div>
                    <div class="tg-item-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                </div>
            </div>

            <div class="tg-item click-to-copy" id="birthdateBlock" onclick="copyData('displayBirthdate', '–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è')" style="display: none;">
                <div class="tg-item-icon">üéÇ</div>
                <div class="tg-item-content">
                    <div class="tg-item-value" id="displayBirthdate"></div>
                    <div class="tg-item-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</div>
                </div>
            </div>

            <div class="tg-item">
                <div class="tg-item-icon">‚ÑπÔ∏è</div>
                <div class="tg-item-content">
                    <textarea id="profileBio" class="tg-bio-input" placeholder="–ù–µ —É–∫–∞–∑–∞–Ω–æ" rows="1" readonly style="pointer-events: none;"></textarea>
                    <div class="tg-item-label">–û —Å–µ–±–µ</div>
                </div>
            </div>

            <input type="date" id="profileBirthdate" style="display: none;">

            <div class="tg-divider"></div>

            <div class="tg-item" onclick="openGeneralSettings()">
                <div class="tg-item-icon" style="color: #7f91a4;">‚öôÔ∏è</div>
                <div class="tg-item-content">
                    <div class="tg-item-value">–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                </div>
            </div>
            <div class="tg-item">
                <div class="tg-item-icon" style="color: #7f91a4;">üîî</div>
                <div class="tg-item-content">
                    <div class="tg-item-value">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                </div>
            </div>
            <div class="tg-item">
                <div class="tg-item-icon" style="color: #7f91a4;">üîí</div>
                <div class="tg-item-content">
                    <div class="tg-item-value">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</div>
                </div>
            </div>

            <div class="tg-divider"></div>

            <div class="tg-item" onclick="logout()" style="cursor: pointer;">
                <div class="tg-item-icon" style="color: #ff595a;">üö™</div>
                <div class="tg-item-content" style="border: none;">
                    <div class="tg-item-value" style="color: #ff595a;">–í—ã–π—Ç–∏</div>
                </div>
            </div>

            <div style="height: 50px;"></div>
        </div>
    </div>

    <div id="toast-notification">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>

    <div id="toast-notification">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>
    <!-- MAIN -->
    <div id="mainSidebar" class="sidebar">
        <!-- –ï–î–ò–ù–ê–Ø –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨: –ê–≤–∞—Ç–∞—Ä + –ü–æ–∏—Å–∫ -->
        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <div class="profile-bar" style="padding: 12px 15px; gap: 12px; position: relative;">
            <button id="searchBackBtn" onclick="closeSearch()" style="display: none; background: none; border: none; color: #007bff; font-size: 20px; cursor: pointer; flex-shrink: 0;">
                ‚Üê
            </button>

            <button id="profileBtn" onclick="openProfileSheet()" style="width: 44px; height: 44px; border-radius: 50%; background: #2d2d2d; border: 1px solid #444; color: #fff; font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: 0.2s;">
                <span id="myAvatarSmall">üë§</span>
            </button>

            <div style="flex: 1; position: relative;">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..."
                       ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†style="width: 100%; height: 44px; padding: 0 15px; border-radius: 22px; border: 1px solid #333; background: #181818; color: white; outline: none; font-size: 14px; transition: 0.2s;"
                       ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†onfocus="openSearchUI()"
                       ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†oninput="handleSearchInput(this)">

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –í–ù–£–¢–†–ò flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
                <div id="searchResults"></div>
            </div>
        </div>

        <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div id="searchResults" style="position: absolute; top: 45px; left: 10px; right: 10px; background: #2d2d2d; border: 1px solid #444; border-radius: 6px; z-index: 100; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">
        </div>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('friends')">
                –î—Ä—É–∑—å—è <span id="friendsBadge" class="tab-badge hidden">0</span>
            </div>
            <div class="tab" onclick="switchTab('requests')">
                –ó–∞—è–≤–∫–∏ <span id="requestsBadge" class="tab-badge hidden">0</span>
            </div>
        </div>
        <div id="friendsList" class="list-container"></div>
        <div id="requestsList" class="list-container hidden"></div>
    </div>
    <div id="mainChatArea" class="chat-area">
        <div id="noChat" style="height:100%; display:flex; align-items:center; justify-content:center; color:#555;"></div>
        <div id="activeChat" class="hidden" style="height:100%; display:flex; flex-direction:column;">
            <div class="chat-header">
                <button class="back-btn" onclick="closeChat()" style="background: none; border: none; cursor: pointer; padding: 0 15px 0 0; display: flex; align-items: center;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 12H4M4 12L10 6M4 12L10 18" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </button>
                <div class="chat-header-info">
                    <div class="chat-title" id="chatTitle">User</div>
                    <div class="chat-status" id="chatStatus">–∑–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="startCall()" style="background:#28a745; color:white; border:none; padding:8px 15px; border-radius:20px; cursor:pointer; font-weight:bold;">üìπ –ó–≤–æ–Ω–æ–∫</button>
                </div>
            </div>
            <div id="msgList" class="messages"></div>
            <div class="input-bar" style="flex-direction: column; gap: 0; padding: 0; align-items: stretch;">

                <div id="replyBar" class="reply-bar hidden">
                    <div class="reply-icon">‚Ü©Ô∏è</div>
                    <div class="reply-content">
                        <div id="replyTitle" class="reply-title">Reply Name</div>
                        <div id="replyText" class="reply-text">Message text...</div>
                    </div>
                    <button class="reply-close" onclick="cancelReplyOrEdit()">‚úñ</button>
                </div>

                <div style="display: flex; width: 100%; align-items: center; gap: 10px; padding: 10px 15px; box-sizing: border-box;">
                    <div class="input-container">
                        <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" onkeypress="if(event.key==='Enter') sendMsg()">
                        <input type="file" id="fileInput" style="display: none;" onchange="uploadFile(this)">
                        <button class="attach-btn" onclick="document.getElementById('fileInput').click()">üìé</button>
                    </div>
                    <button class="voice-btn" onclick="alert('–ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–∫–æ—Ä–æ –±—É–¥—É—Ç!')">üé§</button>
                    <button class="send-btn hidden" id="sendBtn" onclick="sendMsg()">‚û§</button>
                </div>
            </div>
        </div>
    </div>
    <!-- CALL UI -->
    <div id="callScreen" class="call-screen">
        <div class="video-grid">
            <video id="remoteVideo" autoplay playsinline></video>
            <div class="local-video-container" id="localPip">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="pip-resize-handle" aria-hidden="true"></div>
            </div>
        </div>
        <div class="timer-badge">
            <div id="callStatusText">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</div>
            <div id="callTimer">00:00</div>
            <div id="callPing">Ping: -</div>
        </div>
        <div class="controls">
            <div class="control-item">
                <button onclick="toggleScreen()" id="btnScr" class="btn-circle">üñ•Ô∏è</button>
                <span id="lblScr" class="control-label">–≠–∫—Ä–∞–Ω</span>
            </div>
            <div class="control-item">
                <button onclick="toggleCamera()" id="btnCam" class="btn-circle">üì∑</button>
                <span id="lblCam" class="control-label">–í–∫–ª. –≤–∏–¥–µ–æ</span>
            </div>
            <div class="control-item">
                <button onclick="switchCamera()" id="btnFlip" class="btn-circle">üîÑ</button>
                <span class="control-label">–ö–∞–º–µ—Ä–∞</span>
            </div>
            <div class="control-item">
                <button onclick="endCallUser()" class="btn-circle btn-hangup">üìû</button>
                <span class="control-label">–ó–∞–≤–µ—Ä—à–∏—Ç—å</span>
            </div>
            <div class="control-item">
                <button onclick="toggleMic()" id="btnMic" class="btn-circle">üé§</button>
                <span id="lblMic" class="control-label">–í—ã–∫–ª. –∑–≤—É–∫</span>
            </div>
        </div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBncXLA4D1JdsqQtA8_8rPqQioq2XRfic4",
            authDomain: "mycoolmessenger.firebaseapp.com",
            databaseURL: "https://mycoolmessenger-default-rtdb.firebaseio.com",
            projectId: "mycoolmessenger",
            storageBucket: "mycoolmessenger.firebasestorage.app",
            messagingSenderId: "225503087166",
            appId: "1:225503087166:web:1355f138e34e3a0172df6f"
        };
        if (firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app();
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- –ö–†–ò–ü–¢–û–ì–†–ê–§–ò–Ø (–ë–ï–ó–û–ü–ê–°–ù–ê–Ø) ---
        // –¢–≤–æ—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç
        const KEY_PROVIDER_URL = "https://script.google.com/macros/s/AKfycbwkRCYUHSgywECcVq4YYn6RJt4A27KLZO5l_KgB-dO7OvITMc-7VJF27u4u_mlCZOk/exec";

        let sessionKeys = {}; // –ö—ç—à –∫–ª—é—á–µ–π –≤ –ø–∞–º—è—Ç–∏

        // 1. –ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á (–∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É)
        async function fetchChatKey(chatId) {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ –ø–∞–º—è—Ç–∏ (—Å–∞–º–æ–µ –±—ã—Å—Ç—Ä–æ–µ)
            if (sessionKeys[chatId]) return sessionKeys[chatId];

            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage (–±—ã—Å—Ç—Ä–æ)
            const localKey = localStorage.getItem('chatKey_' + chatId);
            if (localKey) {
                sessionKeys[chatId] = localKey;
                return localKey;
            }

            // 3. –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏–≥–¥–µ - –∏–¥–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–¥–æ–ª–≥–æ, –Ω–æ —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑)
            try {
                console.log("–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –∫–ª—é—á –¥–ª—è:", chatId);
                const response = await fetch(KEY_PROVIDER_URL, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({
                        chatId: chatId,
                        userId: currentUser.uid
                    })
                });

                const textResult = await response.text();
                const data = JSON.parse(textResult);

                if (data.status === "success" && data.key) {
                    sessionKeys[chatId] = data.key;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –Ω–∞ –±—É–¥—É—â–µ–µ
                    localStorage.setItem('chatKey_' + chatId, data.key);
                    console.log("‚úÖ –ö–ª—é—á –ø–æ–ª—É—á–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
                    return data.key;
                } else {
                    console.error("‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É:", data.message || "–ù–µ—Ç –∫–ª—é—á–∞");
                    return null;
                }
            } catch (e) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞:", e);
                return null;
            }
        }

        // 2. –ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å (–∏—Å–ø–æ–ª—å–∑—É—è –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–ª—é—á)
        function encryptText(text, chatId) {
            const key = sessionKeys[chatId];
            if (!key || !text) return text;
            try {
                return CryptoJS.AES.encrypt(text, key).toString();
            } catch (e) { return text; }
        }

        // 3. –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å (–∏—Å–ø–æ–ª—å–∑—É—è –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–ª—é—á)
        function decryptText(cipherText, chatId) {
            const key = sessionKeys[chatId];
            if (!key || !cipherText) return cipherText;
            try {
                const bytes = CryptoJS.AES.decrypt(cipherText, key);
                const originalText = bytes.toString(CryptoJS.enc.Utf8);
                return originalText || cipherText;
            } catch (e) { return cipherText; }
        }



        // --- –®ÔøΩ?–§ÔøΩ –û–í–ê–ùÔøΩ?–ï –¢–û–ö–ï–ù–ê –¢–ï–õ–ï–ìÔøΩ –ê–ú–ê (Base64) ---
        // –¢–æ–∫–µ–Ω: 8387775107:AAGhXPcfytIcnh-_zD04HvlGXIJ_b-crPK4


        const iceServers = {
            iceServers: [
                { urls: "stun:stun.relay.metered.ca:80" },
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] },
                { urls: "turn:global.relay.metered.ca:80", username: "ae2c0c3b821722b03a252928", credential: "TVZk6SgD8cbvbQlB" },
                { urls: "turn:global.relay.metered.ca:80?transport=tcp", username: "ae2c0c3b821722b03a252928", credential: "TVZk6SgD8cbvbQlB" },
                { urls: "turn:global.relay.metered.ca:443", username: "ae2c0c3b821722b03a252928", credential: "TVZk6SgD8cbvbQlB" },
                { urls: "turns:global.relay.metered.ca:443?transport=tcp", username: "ae2c0c3b821722b03a252928", credential: "TVZk6SgD8cbvbQlB" },
                { urls: "turn:open-turn.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:open-turn.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:open-turn.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
            ],
            iceCandidatePoolSize: 10
        };
        let currentUser = null;
        let currentFriendId = null;
        let currentCallId = null;
        let currentChatId = null;
        let pc = null;
        let localStream = null;
        let usersCache = {};
        let currentFacingMode = "user";
        let msgUnsub = null;
        let candidateQueue = [];
        let callTimerInt = null;
        let callStartTime = 0;
        let isConnected = false;
        let wasCallConnected = false;
        let amICaller = false;
        let pingInterval = null;
        let selectedMsgId = null;
        let selectedMsgIsMine = false;
        let lastSeenInterval = null;
        let unreadCounts = {};
        let audioCtx = null;
        let toneTimer = null;
        let typingUnsub = null; // –°–ª—É—à–∞—Ç–µ–ª—å –≤—Ö–æ–¥—è—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
        let isTyping = false;   // –ú–æ–π —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
        let typingTimeout = null; // –¢–∞–π–º–µ—Ä –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞
        let lastTypingTime = 0; // –î–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É (throttle)
        let chatStatusUnsub = null;
        let originalUsername = ""; // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É
        let isUsernameValid = true; // –ò —ç—Ç—É
        let usernameCheckTimeout = null; // –ò —ç—Ç—É

        // --- –ù–û–í–´–ô –ü–û–ò–°–ö ---
        // --- –ù–û–í–´–ô –ü–û–ò–°–ö (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô) ---
        let searchTimeout = null;

        async function handleSearchInput(input) {
            const resultsBox = document.getElementById('searchResults');

            // –≠–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —Å–∫—Ä—ã—Ç—å –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
            const friendsList = document.getElementById('friendsList');
            const requestsList = document.getElementById('requestsList');
            const tabs = document.querySelector('.tabs');

            const cleanQuery = input.value.trim().toLowerCase();

            // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å—ë –∫–∞–∫ –±—ã–ª–æ
            if (cleanQuery.length === 0) {
                closeSearch();
                return;
            }

            // 1. –ü–ï–†–ï–ö–õ–Æ–ß–ê–ï–ú –ò–ù–¢–ï–†–§–ï–ô–°
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–∫–∏ —á–∞—Ç–æ–≤ –∏ –≤–∫–ª–∞–¥–∫–∏
            friendsList.classList.add('hidden');
            requestsList.classList.add('hidden');
            if (tabs) tabs.classList.add('hidden');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            resultsBox.classList.add('active');
            resultsBox.style.display = 'flex'; // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ –ø–æ–∏—Å–∫–µ
            document.getElementById('profileName').value = d.name;

            const surnameEl = document.getElementById('profileSurname');
            if (d.surname && d.surname.trim() !== "") {
                surnameEl.value = d.surname;
                surnameEl.style.display = "block"; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–º–∏–ª–∏—è
            } else {
                surnameEl.style.display = "none";¬† // –°–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –ø—É—Å—Ç–æ
            }

            resultsBox.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">üîç –ü–æ–∏—Å–∫...</div>';

            // Debounce (–∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º)
            if (searchTimeout) clearTimeout(searchTimeout);

            searchTimeout = setTimeout(async () => {
                try {
                    const localHits = [];
                    const globalHits = [];

                    // --- –ü–û–ò–°–ö –ü–û –ö–≠–®–£ (–î—Ä—É–∑—å—è) ---
                    const cachedUsers = Object.keys(usersCache || {}).map(id => ({
                        id: id,
                        ...usersCache[id]
                    }));

                    cachedUsers.forEach(fr => {
                        const nameMatch = fr.name && fr.name.toLowerCase().includes(cleanQuery);
                        const usernameMatch = fr.username && fr.username.toLowerCase().includes(cleanQuery);
                        const emailMatch = fr.email && fr.email.toLowerCase().includes(cleanQuery);

                        if (nameMatch || usernameMatch || emailMatch) {
                            localHits.push(fr);
                        }
                    });

                    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö (–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö) ---
                    if (cleanQuery.length >= 3) {
                        const snapUser = await db.collection('users')
                            .where('username', '>=', cleanQuery)
                            .where('username', '<=', cleanQuery + '\uf8ff')
                            .limit(10)
                            .get();

                        snapUser.forEach(doc => {
                            if (doc.id !== currentUser.uid && !localHits.find(h => h.id === doc.id)) {
                                globalHits.push({ id: doc.id, ...doc.data() });
                            }
                        });
                    }

                    // --- –û–¢–†–ò–°–û–í–ö–ê ---
                    resultsBox.innerHTML = '';

                    if (localHits.length === 0 && globalHits.length === 0) {
                        resultsBox.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                        return;
                    }

                    if (localHits.length > 0) {
                        const section = document.createElement('div');
                        section.innerHTML = `<div class="search-section-title">–í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã</div>`;
                        localHits.forEach(user => section.appendChild(renderSearchResult(user, true)));
                        resultsBox.appendChild(section);
                    }

                    if (globalHits.length > 0) {
                        const section = document.createElement('div');
                        section.innerHTML = `<div class="search-section-title">–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫</div>`;
                        globalHits.forEach(user => section.appendChild(renderSearchResult(user, false)));
                        resultsBox.appendChild(section);
                    }

                } catch (e) {
                    console.error(e);
                    resultsBox.innerHTML = '<div style="padding:10px; color:red; text-align:center;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
                }
            }, 500);
        }


        async function performSearch(query) {
            const resultsBox = document.getElementById('searchResults');
            resultsBox.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">–ü–æ–∏—Å–∫...</div>';

            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ (–∫–ª–∞—Å—Å active –∏–∑ CSS)
            if (!resultsBox.classList.contains('active')) {
                openSearchUI();
            }

            const cleanQuery = query.startsWith('@') ? query.slice(1).toLowerCase() : query.toLowerCase();

            try {
                // --- –ê. –õ–û–ö–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö (–°–†–ï–î–ò –î–†–£–ó–ï–ô) ---
                // –ò—â–µ–º –≤ –∫—ç—à–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const localHits = Object.keys(usersCache || {})
                    .map(id => ({ id, ...usersCache[id] }))
                    .filter(u => {
                        const q = cleanQuery;
                        return (u.name && u.name.toLowerCase().includes(q)) ||
                            (u.username && u.username.toLowerCase().includes(q)) ||
                            (u.email && u.email.toLowerCase().includes(q));
                    });

                // --- –ë. –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö (–ë–ê–ó–ê –î–ê–ù–ù–´–•) ---
                const globalHits = [];

                // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –¥–ª–∏–Ω–Ω–µ–µ 2 —Å–∏–º–≤–æ–ª–æ–≤, –∏—â–µ–º –≤ –±–∞–∑–µ
                if (cleanQuery.length >= 2) {
                    // –ò—â–µ–º –ø–æ username
                    const snapUser = await db.collection('users')
                        .where('username', '>=', cleanQuery)
                        .where('username', '<=', cleanQuery + '\uf8ff')
                        .limit(5)
                        .get();

                    snapUser.forEach(doc => {
                        // –ò—Å–∫–ª—é—á–∞–µ–º —Å–µ–±—è –∏ —Ç–µ—Ö, –∫—Ç–æ —É–∂–µ –µ—Å—Ç—å –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –ø–æ–∏—Å–∫–µ
                        if (doc.id !== currentUser.uid && !localHits.find(h => h.id === doc.id)) {
                            globalHits.push({ id: doc.id, ...doc.data() });
                        }
                    });

                    // –ò—â–µ–º –ø–æ email (–µ—Å–ª–∏ –º–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
                    if (globalHits.length < 3) {
                        const snapEmail = await db.collection('users')
                            .where('email', '>=', cleanQuery)
                            .where('email', '<=', cleanQuery + '\uf8ff')
                            .limit(5)
                            .get();

                        snapEmail.forEach(doc => {
                            if (doc.id !== currentUser.uid &&
                                !localHits.find(h => h.id === doc.id) &&
                                !globalHits.find(h => h.id === doc.id)) {
                                globalHits.push({ id: doc.id, ...doc.data() });
                            }
                        });
                    }
                }

                // --- –í. –û–¢–†–ò–°–û–í–ö–ê ---
                resultsBox.innerHTML = '';

                if (localHits.length === 0 && globalHits.length === 0) {
                    resultsBox.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    return;
                }

                if (localHits.length > 0) {
                    resultsBox.innerHTML += `<div class="search-section-title">–í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã</div>`;
                    localHits.forEach(user => resultsBox.appendChild(renderSearchResult(user, true)));
                }

                if (globalHits.length > 0) {
                    resultsBox.innerHTML += `<div class="search-section-title">–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫</div>`;
                    globalHits.forEach(user => resultsBox.appendChild(renderSearchResult(user, false)));
                }

            } catch (e) {
                console.error(e);
                resultsBox.innerHTML = '<div style="padding:10px; color:red; text-align:center;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
            }
        }
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è HTML —ç–ª–µ–º–µ–Ω—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        function renderSearchResult(user, isFriend) {
            const div = document.createElement('div');
            div.style.padding = '10px';
            div.style.borderBottom = '1px solid #333';
            div.style.cursor = 'pointer';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.gap = '10px';
            div.className = 'search-item-row';
            const avatarSrc = user.avatar
                ? `<img src="${user.avatar}" style="width:35px;height:35px;border-radius:50%;object-fit:cover;">`
                : `<div style="width:35px;height:35px;border-radius:50%;background:#444;display:flex;align-items:center;justify-content:center;font-size:14px;">üë§</div>`;
            const displayNick = user.username ? `@${user.username}` : user.email;
            div.innerHTML = `
                                                                                                                                                            ${avatarSrc}
                                                                                                                                                            <div style="flex:1; overflow:hidden;">
                                                                                                                                                                <div style="font-weight:bold; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${user.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                                                                                                                                                                <div style="font-size:12px; color:#888;">${displayNick}</div>
                                                                                                                                                            </div>
                                                                                                                                                            <div style="font-size:18px; color:#007bff;">${isFriend ? 'üí¨' : '‚ûï'}</div>
                                                                                                                                                        `;
            div.onclick = () => {
                document.getElementById('searchResults').style.display = 'none';
                document.getElementById('searchInput').value = '';
                if (isFriend) {
                    // –ï—Å–ª–∏ –¥—Ä—É–≥ ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
                    openChat(user.id, user.name || user.username, user.username ? '@' + user.username : '');
                } else {
                    // –ï—Å–ª–∏ –Ω–µ –¥—Ä—É–≥ ‚Äî –∫–∏–¥–∞–µ–º –∑–∞—è–≤–∫—É
                    sendFriendRequestToId(user.id);
                }
            };
            return div;
        }
        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ –ø–æ ID (–∞ –Ω–µ email)
        async function sendFriendRequestToId(targetUid) {
            try {
                const myUsername = await getCurrentUsername();
                await db.collection('friend_requests').add({
                    from: currentUser.uid,
                    fromEmail: currentUser.email,
                    fromUsername: myUsername || 'none',
                    to: targetUid,
                    ts: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('–ó–∞—è–≤–∫–∞ –≤ –¥—Ä—É–∑—å—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏');
            }
        }
        async function getCurrentUsername() {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            return doc.exists ? doc.data().username : null;
        }
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        function beep(freq, duration, vol = 0.05) {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = freq;
            osc.type = 'sine';
            gain.gain.value = vol;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            setTimeout(() => {
                gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.04);
                osc.stop(audioCtx.currentTime + 0.05);
            }, duration);
        }
        function playConnectingTone() {
            stopAllTones();
            const loop = () => beep(425, 100, 0.05);
            loop();
            toneTimer = setInterval(loop, 1500);
        }
        function playRingingTone() {
            stopAllTones();
            const loop = () => beep(425, 1000, 0.08);
            loop();
            toneTimer = setInterval(loop, 4000);
        }
        function playEndTone() {
            stopAllTones();
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.4);
        }
        function stopAllTones() {
            if (toneTimer) { clearInterval(toneTimer); toneTimer = null; }
        }
        function formatLastSeen(timestamp) {
            if (!timestamp) return "–±—ã–ª –¥–∞–≤–Ω–æ";
            const now = Date.now();
            const diff = now - timestamp.toMillis();
            const seconds = Math.floor(diff / 1000); // –°—á–∏—Ç–∞–µ–º —Å–µ–∫—É–Ω–¥—ã
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            const months = Math.floor(days / 30);
            // === –ù–ê–°–¢–†–û–ô–ö–ê –ó–î–ï–°–¨ ===
            // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ 45 —Å–µ–∫—É–Ω–¥, —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –æ–Ω –µ—â—ë "–≤ —Å–µ—Ç–∏"
            if (seconds < 30) return "–≤ —Å–µ—Ç–∏";
            // –ï—Å–ª–∏ –æ—Ç 45 —Å–µ–∫ –¥–æ 1 –º–∏–Ω—É—Ç—ã - –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å "–±—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ" –∏–ª–∏ —É–∂–µ —Å—á–∏—Ç–∞—Ç—å –º–∏–Ω—É—Ç—ã
            if (minutes < 1) return "–±—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ";
            // –î–∞–ª—å—à–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ
            if (minutes < 60) return `${minutes} ${minutes === 1 ? '–º–∏–Ω—É—Ç—É' : minutes < 5 ? '–º–∏–Ω—É—Ç—ã' : '–º–∏–Ω—É—Ç'} –Ω–∞–∑–∞–¥`;
            if (hours < 24) return `${hours} ${hours === 1 ? '—á–∞—Å' : hours < 5 ? '—á–∞—Å–∞' : '—á–∞—Å–æ–≤'} –Ω–∞–∑–∞–¥`;
            if (days < 30) return `${days} ${days === 1 ? '–¥–µ–Ω—å' : days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'} –Ω–∞–∑–∞–¥`;
            return "–±—ã–ª –¥–∞–≤–Ω–æ";
        }
        let lastActivityTime = Date.now();
        let isOnline = false;
        // –°–ª–µ–¥–∏–º –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, () => {
                lastActivityTime = Date.now();
                if (!isOnline) {
                    // –ï—Å–ª–∏ –æ–Ω "–ø—Ä–æ—Å–Ω—É–ª—Å—è" - —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                    updateLastSeen();
                }
            });
        });
        function updateLastSeen() {
            const now = Date.now();
            // –ï—Å–ª–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ 30 —Å–µ–∫—É–Ω–¥ - –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑—É
            if (now - lastActivityTime < 30000) {
                isOnline = true;
                if (currentUser) {
                    db.collection('users').doc(currentUser.uid).update({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(e => console.log('Err update lastSeen', e));
                }
            } else {
                isOnline = false;
                // –ú–æ–∂–Ω–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —è–≤–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å "–æ—Ñ–ª–∞–π–Ω" –≤ –±–∞–∑—É, –Ω–æ –ª—É—á—à–µ –ø—Ä–æ—Å—Ç–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–∞—Ç—É
            }
        }
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
        // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω -> –æ–±–Ω–æ–≤–∏—Ç –¥–∞—Ç—É –≤ –±–∞–∑–µ.
        // –ï—Å–ª–∏ –ù–ï –∞–∫—Ç–∏–≤–µ–Ω -> –Ω–µ –æ–±–Ω–æ–≤–∏—Ç, –∏ —á–µ—Ä–µ–∑ 30-60 —Å–µ–∫ –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ–Ω —Å—Ç–∞–Ω–µ—Ç "–±—ã–ª –Ω–µ–¥–∞–≤–Ω–æ"
        setInterval(updateLastSeen, 15000);
        // --- AUTH ---
        // 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        function authAction() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            if (!e || !p) return;
            // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —é–∑–µ—Ä—É, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –ø–æ—à–µ–ª
            const btn = document.querySelector('#stepEmail button'); // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É
            const originalText = btn.innerText;
            btn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            btn.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–∂–∞–ª –¥–≤–∞–∂–¥—ã
            btn.style.opacity = "0.7";
            auth.signInWithEmailAndPassword(e, p).catch(err => {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å
                if (err.code.includes('not-found') || err.code.includes('wrong') || err.code.includes('invalid')) {
                    auth.createUserWithEmailAndPassword(e, p).then(cred => {
                        db.collection('users').doc(cred.user.uid).set({
                            email: e,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, onAuthStateChanged –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    }).catch(regErr => {
                        // –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                        document.getElementById('authError').innerText = regErr.message;
                        btn.innerText = originalText;
                        btn.disabled = false;
                        btn.style.opacity = "1";
                    });
                } else {
                    // –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞
                    document.getElementById('authError').innerText = err.message;
                    btn.innerText = originalText;
                    btn.disabled = false;
                    btn.style.opacity = "1";
                }
            });
        }
        // --- 1. –û–ü–¢–ò–ú–ò–°–¢–ò–ß–ù–´–ô –í–•–û–î (–í—Å—Ç–∞–≤–∏—Ç—å –ü–ï–†–ï–î auth.onAuthStateChanged) ---
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Ö–æ–¥–∏–ª –ª–∏ —é–∑–µ—Ä –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑
        const wasLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        if (wasLoggedIn) {
            // –°—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –æ—Ç–≤–µ—Ç–∞ –æ—Ç Google
            document.getElementById('authScreen').classList.add('hidden');
        }
        // --- 2. –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê (–í–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è) ---
        auth.onAuthStateChanged(u => {
            if (u) {
                currentUser = u;
                localStorage.setItem('isLoggedIn', 'true');

                db.collection('users').doc(u.uid).get().then(doc => {
                    if (doc.exists) {
                        const d = doc.data();

                        // === –ê–í–ê–¢–ê–†–ö–ê ===
                        const myAvatarSmall = document.getElementById('myAvatarSmall');
                        if (myAvatarSmall && d.avatar) {
                            // 1. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –≤–µ—Å—å –∫—Ä—É–≥
                            myAvatarSmall.style.width = '100%';
                            myAvatarSmall.style.height = '100%';
                            myAvatarSmall.style.display = 'block';
                            myAvatarSmall.style.borderRadius = '50%';
                            myAvatarSmall.style.overflow = 'hidden'; // –û–±—Ä–µ–∑–∞–µ–º –ª–∏—à–Ω–µ–µ

                            // 2. –í—Å—Ç–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É
                            myAvatarSmall.innerHTML = `<img src="${d.avatar}" style="width:100%;height:100%;object-fit:cover;display:block;">`;
                        }
                        // === –ö–û–ù–ï–¶ ===

                        if (doc.data().username) {
                            document.getElementById('authScreen').classList.add('hidden');
                            document.getElementById('profileEmail').innerText = u.email;
                            updateLastSeen();

                            loadData();
                            listenForIncomingCalls();
                            loadTgId();
                            setTimeout(handleHashChange, 500);
                            if (lastSeenInterval) clearInterval(lastSeenInterval);
                        } else {
                            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                            document.getElementById('stepEmail').style.display = 'none';
                            document.getElementById('stepName').style.display = 'block';
                            document.getElementById('stepUsername').style.display = 'none';
                            document.getElementById('authScreen').classList.remove('hidden');
                        }
                    } // <--- –í–û–¢ –≠–¢–û–ô –°–ö–û–ë–ö–ò –ù–ï –•–í–ê–¢–ê–õ–û (–∑–∞–∫—Ä—ã–≤–∞–µ—Ç if (doc.exists))
                });
            } else {
                localStorage.removeItem('isLoggedIn');
                const wasLoggedIn = localStorage.getItem('isLoggedIn'); // –î–æ–±–∞–≤–∏–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤—ã—à–µ
                if (wasLoggedIn) {
                    alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
                }
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('stepEmail').style.display = 'block';
                document.getElementById('stepName').style.display = 'none';
                document.getElementById('stepUsername').style.display = 'none';
                if (lastSeenInterval) clearInterval(lastSeenInterval);
            }
        });



        function checkNameInput() {
            const name = document.getElementById('regName').value.trim();
            const btn = document.getElementById('btnNameNext');
            if (name.length > 0) {
                btn.disabled = false;
                btn.style.background = '#007bff'; // –°–∏–Ω–∏–π
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.background = '#444';
                btn.style.cursor = 'not-allowed';
            }
        }
        // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É 3
        function goToUsernameStep() {
            document.getElementById('stepName').style.display = 'none';
            document.getElementById('stepUsername').style.display = 'block';
        }
        // –í–æ–∑–≤—Ä–∞—Ç –Ω–∞–∑–∞–¥ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º—è)
        function backToName() {
            document.getElementById('stepUsername').style.display = 'none';
            document.getElementById('stepName').style.display = 'block';
        }
        // –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —é–∑–µ—Ä–Ω–µ–π–º–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        let usernameTimeout = null;
        function checkUsernameInput() {
            let val = document.getElementById('regUsername').value;
            const status = document.getElementById('usernameStatus');
            const btn = document.getElementById('btnFinish');
            // –û—á–∏—Å—Ç–∫–∞ –æ—Ç –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
            val = val.replace(/[^a-zA-Z0-9_.]/g, '');
            document.getElementById('regUsername').value = val; // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ
            // –í–∏–∑—É–∞–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º @
            // (–í –∫–æ–¥–µ –≤—ã—à–µ input —É–∂–µ –∏–º–µ–µ—Ç placeholder, –Ω–æ –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å)
            btn.disabled = true;
            btn.style.background = '#444';
            btn.style.cursor = 'not-allowed';
            if (val.length < 3) {
                status.innerText = "–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)";
                status.style.color = "#ff4444";
                return;
            }
            status.innerText = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";
            status.style.color = "#aaa";
            // Debounce (–∂–¥–µ–º –ø–æ–∫–∞ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –ø–µ—á–∞—Ç–∞—Ç—å)
            if (usernameTimeout) clearTimeout(usernameTimeout);
            usernameTimeout = setTimeout(() => {
                // –ó–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ
                db.collection('users').where('username', '==', val).get().then(snap => {
                    if (snap.empty) {
                        status.innerText = `@${val} —Å–≤–æ–±–æ–¥–Ω–æ`;
                        status.style.color = "#4caf50"; // –ó–µ–ª–µ–Ω—ã–π
                        btn.disabled = false;
                        btn.style.background = '#007bff';
                        btn.style.cursor = 'pointer';
                    } else {
                        status.innerText = `@${val} —É–∂–µ –∑–∞–Ω—è—Ç–æ`;
                        status.style.color = "#ff4444"; // –ö—Ä–∞—Å–Ω—ã–π
                    }
                });
            }, 500); // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–≤–æ–¥–∞
        }
        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        function finishRegistration() {
            const name = document.getElementById('regName').value.trim();
            const surname = document.getElementById('regSurname').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            if (!name || !username) return;
            db.collection('users').doc(currentUser.uid).set({
                name: name,
                surname: surname,
                username: username,
                email: currentUser.email, // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }).then(() => {
                // –£—Å–ø–µ—Ö -> –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
                // –õ—É—á—à–µ –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É, –∫–∞–∫ –≤ onAuthStateChanged
                document.getElementById('authScreen').classList.add('hidden');
                loadData();
                listenForIncomingCalls();
                loadTgId();
                if (lastSeenInterval) clearInterval(lastSeenInterval);
                lastSeenInterval = setInterval(updateLastSeen, 30000);
            });
        }
        window.addEventListener('beforeunload', updateLastSeen);
        // --- LOGIC ---
        function switchTab(t) {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            if (t === 'friends') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('friendsList').classList.remove('hidden');
                document.getElementById('requestsList').classList.add('hidden');
            }
            else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('friendsList').classList.add('hidden');
                document.getElementById('requestsList').classList.remove('hidden');
            }
        }
        // –°–ª—É—à–∞—Ç–µ–ª—å –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞—è–≤–æ–∫ –≤ –¥—Ä—É–∑—å—è
        function listenForFriendRequests() {
            db.collection('friend_requests')
                .where('to', '==', currentUser.uid)
                .onSnapshot(async snap => {
                    const list = document.getElementById('requestsList');
                    const badge = document.getElementById('requestsBadge');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞—è–≤–æ–∫
                    if (snap.size > 0) {
                        badge.innerText = snap.size;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                    // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç, –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
                    list.innerHTML = '';
                    if (snap.empty) {
                        list.innerHTML = '<div style="padding:20px;text-align:center;color:#888">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</div>';
                        return;
                    }
                    snap.forEach(doc => {
                        const data = doc.data();
                        const div = document.createElement('div');
                        div.className = 'user-item'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Å—Ç–∏–ª—å, —á—Ç–æ –∏ –¥–ª—è —á–∞—Ç–æ–≤
                        // –ê–≤–∞—Ç–∞—Ä–∫–∞ (–∑–∞–≥–ª—É—à–∫–∞ –∏–ª–∏ –º–æ–∂–Ω–æ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é)
                        const avatar = '<div class="user-item-avatar" style="background:#444;display:flex;align-items:center;justify-content:center;">üë§</div>';
                        div.innerHTML = `
                                                                                                                                                                                                                                                                                                                                                                ${avatar}
                                                                                                                                                                                                                                                                                                                                                                <div class="user-name" style="grid-row: 1/span 2; align-self:center;">
                                                                                                                                                                                                                                                                                                                                                                    ${data.fromUsername ? '@' + data.fromUsername : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
                                                                                                                                                                                                                                                                                                                                                                    <div style="font-size:12px; color:#888; font-weight:normal;">–•–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –¥—Ä—É–∑—å—è</div>
                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                <div style="grid-column:3; grid-row:1/span 2; display:flex; gap:10px;">
                                                                                                                                                                                                                                                                                                                                                                    <button onclick="accept('${doc.id}', '${data.from}', '${data.fromEmail}')" style="background:#28a745; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;">‚úì</button>
                                                                                                                                                                                                                                                                                                                                                                    <button onclick="reject('${doc.id}')" style="background:#dc3545; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;">‚úï</button>
                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                            `;
                        list.appendChild(div);
                    });
                });
        }
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ
        function startMessageListener(chatId, fid, createdTime) {
            db.collection('chats').doc(chatId).collection('msgs')
                .orderBy('ts', 'desc').limit(1)
                .onSnapshot(msgSnap => {
                    const lastEl = document.getElementById('last-' + chatId);
                    const dateEl = document.getElementById('date-' + chatId);
                    const statusEl = document.getElementById('status-' + chatId);
                    const userDiv = document.getElementById('u-' + fid);
                    // –í—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –∫–æ–≥–¥–∞ –¥–æ–±–∞–≤–∏–ª–∏ –≤ –¥—Ä—É–∑—å—è
                    let timeToDisplay = createdTime;
                    if (!msgSnap.empty) {
                        const lastData = msgSnap.docs[0].data();
                        // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                        // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                        if (lastEl) {
                            const type = lastData.type || 'text';
                            let displayText = '';

                            // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –¥–ª—è –ø—Ä–µ–≤—å—é
                            const decryptedPreview = decryptText(lastData.txt, chatId);

                            if (type === 'image') {
                                displayText = 'üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è';
                            } else if (type === 'file') {
                                displayText = 'üìÑ –§–∞–π–ª';
                            } else {
                                displayText = decryptedPreview || '';
                                if (displayText.length > 25) displayText = displayText.substring(0, 25) + '...';
                            }

                            if (lastData.from === currentUser.uid) {
                                displayText = '–í—ã: ' + displayText;
                            }
                            lastEl.innerHTML = displayText;
                        }
                        // –í—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏—è
                        if (lastData.ts) timeToDisplay = lastData.ts.toMillis();
                        // –ì–∞–ª–æ—á–∫–∏ (—Å—Ç–∞—Ç—É—Å)
                        if (statusEl) {
                            if (lastData.from === currentUser.uid) {
                                let ticksHtml = lastData.read
                                    ? '<span style="margin-right:-4px;">‚úì</span>‚úì'
                                    : '‚úì';
                                statusEl.innerHTML = ticksHtml;
                                statusEl.style.display = 'inline-flex';
                            } else {
                                statusEl.style.display = 'none';
                            }
                        }
                    } else {
                        if (lastEl) lastEl.innerHTML = "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π";
                        if (statusEl) statusEl.style.display = 'none';
                    }
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É
                    if (dateEl && timeToDisplay > 0) {
                        const date = new Date(timeToDisplay);
                        const now = new Date();
                        // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –¥–∞—Ç—ã: —á–∞—Å—ã:–º–∏–Ω—É—Ç—ã –∏–ª–∏ –¥–µ–Ω—å
                        if (date.toDateString() === now.toDateString()) {
                            dateEl.innerText = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
                        } else {
                            dateEl.innerText = date.getDate() + '.' + (date.getMonth() + 1);
                        }
                    }
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É —Å–ø–∏—Å–∫–∞
                    if (userDiv) {
                        userDiv.setAttribute('data-time', timeToDisplay);
                        sortFriendsList();
                    }
                });
            // –°–ª—É—à–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ (Badge)
            db.collection('chats').doc(chatId).collection('msgs')
                .where('to', '==', currentUser.uid)
                .where('read', '==', false)
                .onSnapshot(unreadSnap => {
                    const badgeEl = document.getElementById('badge-' + chatId);
                    const count = unreadSnap.size;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –æ–±—â–µ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞ (–µ—Å–ª–∏ –æ–Ω —É –≤–∞—Å –µ—Å—Ç—å)
                    if (typeof unreadCounts !== 'undefined') {
                        unreadCounts[chatId] = count;
                        updateTotalFriendsBadge();
                    }
                    if (badgeEl) {
                        if (count > 0) {
                            badgeEl.innerText = count;
                            badgeEl.classList.remove('hidden');
                        } else {
                            badgeEl.classList.add('hidden');
                        }
                    }
                });
        }

        // --- –õ–û–ì–ò–ö–ê –£–î–ê–õ–ï–ù–ò–Ø (–û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø) ---

        // 1. –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        function openDeleteSheet() {
            // 1. –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
            const menu = document.getElementById('contextMenu');
            if (menu) {
                menu.classList.remove('active');
                setTimeout(() => { menu.style.display = 'none'; }, 200);
            }

            // 2. –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —á–∞—Ç–∞
            const chatTitleEl = document.getElementById('chatTitle');
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –ø–µ—Ä–≤–æ–≥–æ div-–∞ (—Ç–∞–º –∏–º—è)
            const friendName = chatTitleEl ? chatTitleEl.querySelector('div').innerText : "—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞";

            // 3. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
            const friendNameSpan = document.getElementById('deleteFriendName');
            if (friendNameSpan) friendNameSpan.innerText = friendName;

            // 4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
            const modal = document.getElementById('deleteModalOverlay');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        // 2. –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ (–∫–Ω–æ–ø–∫–∞ –û—Ç–º–µ–Ω–∞)
        function closeDeleteModal() {
            const modal = document.getElementById('deleteModalOverlay');
            modal.style.display = 'none';
        }

        // 3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è (–∫–Ω–æ–ø–∫–∞ –£–¥–∞–ª–∏—Ç—å)
        function executeDelete() {
            if (!selectedMsgId) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—Ç–æ–∏—Ç –ª–∏ –≥–∞–ª–æ—á–∫–∞ "–£–¥–∞–ª–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö"
            const isDeleteForEveryone = document.getElementById('deleteForEveryone').checked;

            if (isDeleteForEveryone) {
                // –í–ê–†–ò–ê–ù–¢ –ê: –£–¥–∞–ª—è–µ–º –∏–∑ –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö (Firebase)
                // –°–æ–æ–±—â–µ–Ω–∏–µ –∏—Å—á–µ–∑–Ω–µ—Ç –∏ —É –º–µ–Ω—è, –∏ —É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –Ω–∞–≤—Å–µ–≥–¥–∞.
                db.collection('chats').doc(currentChatId).collection('msgs').doc(selectedMsgId).delete()
                    .then(() => {
                        console.log('–£–¥–∞–ª–µ–Ω–æ —É –≤—Å–µ—Ö (–∏–∑ –±–∞–∑—ã)');
                    })
                    .catch(err => {
                        console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", err);
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: " + err.message);
                    });
            } else {
                // –í–ê–†–ò–ê–ù–¢ –ë: –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É —Å–µ–±—è (–õ–æ–∫–∞–ª—å–Ω–æ)
                // 1. –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
                const el = document.getElementById(`msg-${selectedMsgId}`);
                if (el) el.style.display = 'none';

                // 2. –ó–∞–ø–æ–º–∏–Ω–∞–µ–º ID –≤ localStorage, —á—Ç–æ–±—ã –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–Ω–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–æ—Å—å
                const deletedLocal = JSON.parse(localStorage.getItem('deletedMsgs') || '[]');
                deletedLocal.push(selectedMsgId);
                localStorage.setItem('deletedMsgs', JSON.stringify(deletedLocal));
            }

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
            closeDeleteModal();
        }

        function loadData() {
            // 1. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∫—É –∑–∞—è–≤–æ–∫
            if (typeof listenForFriendRequests === 'function') {
                listenForFriendRequests();
            }
            // 2. –°–ª—É—à–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û + –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê –ö–õ–Æ–ß–ï–ô)
            db.collection('friends')
                .where('users', 'array-contains', currentUser.uid)
                .onSnapshot(async snap => {
                    const list = document.getElementById('friendsList');
                    if (snap.empty) {
                        list.innerHTML = '<div style="padding:20px;text-align:center;color:#888">–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –ø—É—Å—Ç</div>';
                        return;
                    }
                    // –ü—Ä–æ—Ö–æ–¥–∏–º —Ç–æ–ª—å–∫–æ –ø–æ –ò–ó–ú–ï–ù–ï–ù–ò–Ø–ú
                    snap.docChanges().forEach(async change => {
                        const d = change.doc.data();
                        const fid = d.users.find(id => id !== currentUser.uid);
                        if (!fid) return;

                        // –ï—Å–ª–∏ –¥—Ä—É–≥–∞ —É–¥–∞–ª–∏–ª–∏
                        if (change.type === 'removed') {
                            const el = document.getElementById('u-' + fid);
                            if (el) el.remove();
                            return;
                        }

                        // --- üî• –í–ê–ñ–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –§–û–ù–û–í–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ö–õ–Æ–ß–ê üî• ---
                        // –í—ã—á–∏—Å–ª—è–µ–º ID —á–∞—Ç–∞
                        const preChatId = [currentUser.uid, fid].sort().join('_');
                        // –¢–∏—Ö–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–ª—é—á. –ú—ã –Ω–µ —Å—Ç–∞–≤–∏–º await, —á—Ç–æ–±—ã –Ω–µ —Ç–æ—Ä–º–æ–∑–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
                        // –°–∫—Ä–∏–ø—Ç –ø–æ–π–¥–µ—Ç –∑–∞ –∫–ª—é—á–æ–º –≤ —Ñ–æ–Ω–µ.
                        fetchChatKey(preChatId).then(k => {
                            if (k) console.log("üîë –ö–ª—é—á –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è:", fid);
                        });
                        // -----------------------------------------------------

                        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∞ (–∏–∑ –∫—ç—à–∞ –∏–ª–∏ –±–∞–∑—ã)
                        let friendData = usersCache[fid];
                        if (!friendData) {
                            try {
                                const userSnap = await db.collection('users').doc(fid).get();
                                if (userSnap.exists) {
                                    friendData = userSnap.data();
                                    usersCache[fid] = friendData;
                                }
                            } catch (e) {
                                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è", e);
                            }
                        }

                        const fName = friendData ? (friendData.name || friendData.username) : '–ó–∞–≥—Ä—É–∑–∫–∞...';
                        const fNick = friendData ? ('@' + friendData.username) : '';
                        const fAvatar = friendData ? friendData.avatar : null;
                        const createdTime = d.createdAt ? d.createdAt.toMillis() : 0;
                        const chatId = preChatId; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π ID

                        let div = document.getElementById('u-' + fid);
                        const isNew = !div;

                        if (isNew) {
                            div = document.createElement('div');
                            div.className = 'user-item';
                            div.id = 'u-' + fid;
                            div.onclick = () => openChat(fid, fName, fNick);
                        }

                        div.setAttribute('data-time', createdTime);

                        const avatarHtml = fAvatar
                            ? `<img src="${fAvatar}" class="user-item-avatar">`
                            : `<div class="user-item-avatar" style="background:#444;display:flex;align-items:center;justify-content:center;font-size:24px;color:#888">üë§</div>`;

                        div.innerHTML = `
                                                        ${avatarHtml}
                                                        <div class="user-name">${fName}</div>
                                                        <div class="last-msg-row">
                                                            <span class="last-msg" id="last-${chatId}">...</span>
                                                        </div>
                                                        <div class="meta-column">
                                                            <span class="last-msg-date" id="date-${chatId}"></span>
                                                            <div class="meta-bottom-row">
                                                                <span id="status-${chatId}" class="list-ticks"></span>
                                                                <div class="badge-count hidden" id="badge-${chatId}">0</div>
                                                            </div>
                                                        </div>
                                                    `;

                        if (isNew) {
                            list.appendChild(div);
                            startMessageListener(chatId, fid, createdTime);
                        }
                    });

                    setTimeout(sortFriendsList, 100);
                });
        }
        function sortFriendsList() {
            const list = document.getElementById('friendsList');
            const items = Array.from(list.children);
            items.sort((a, b) => {
                const timeA = parseInt(a.getAttribute('data-time') || 0);
                const timeB = parseInt(b.getAttribute('data-time') || 0);
                return timeB - timeA;
            });
            items.forEach(item => list.appendChild(item));
        }
        function updateTotalFriendsBadge() {
            const total = Object.values(unreadCounts).reduce((a, b) => a + b, 0);
            const el = document.getElementById('friendsBadge');
            if (total > 0) { el.innerText = total; el.classList.remove('hidden'); }
            else { el.classList.add('hidden'); }
        }
        async function sendFriendRequest() {
            const e = document.getElementById('searchEmail').value;
            const snap = await db.collection('users').where('email', '==', e).get();
            if (snap.empty) return alert('–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            await db.collection('friend_requests').add({ from: currentUser.uid, fromEmail: currentUser.email, to: snap.docs[0].id });
            alert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); document.getElementById('searchEmail').value = '';
        }
        async function accept(rid, fid, femail) {
            await db.collection('friends').add({
                users: [currentUser.uid, fid],
                emails: { [currentUser.uid]: currentUser.email, [fid]: femail },
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await db.collection('friend_requests').doc(rid).delete();
        }
        function reject(rid) { db.collection('friend_requests').doc(rid).delete(); }
        async function openChat(fid, name, nick) {
            window.location.hash = "chat/" + fid;
            currentFriendId = fid;
            currentChatId = [currentUser.uid, fid].sort().join('_');

            if (window.innerWidth <= 768) {
                document.getElementById('mainSidebar').classList.add('hidden-mobile');
                document.getElementById('mainChatArea').classList.add('active');
            }

            document.getElementById('noChat').classList.add('hidden');
            document.getElementById('activeChat').classList.remove('hidden');

            // --- –£–º–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–µ–π ---
            const titleEl = document.getElementById('chatTitle');

            // –ï—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç –≤ –∫—ç—à–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
            if (!sessionKeys[currentChatId] && !localStorage.getItem('chatKey_' + currentChatId)) {
                titleEl.innerHTML = '<div>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–µ–π...</div>';
            }

            // –ñ–¥–µ–º –∫–ª—é—á (–µ—Å–ª–∏ –æ–Ω –≤ –∫—ç—à–µ, —ç—Ç–æ –∑–∞–π–º–µ—Ç 0–º—Å)
            await fetchChatKey(currentChatId);

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            titleEl.innerHTML = `
                <div>${name}</div>
                <div style="font-size:11px; font-weight:normal; color:#888;">${nick}</div>
            `;

            // --- –ë–´–°–¢–†–´–ô –°–¢–ê–¢–£–° –ò–ó –ö–≠–®–ê ---
            const statusEl = document.getElementById('chatStatus');
            if (statusEl) {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª—å (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —Ç–∞–º –æ—Å—Ç–∞–ª—Å—è —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç –æ—Ç "–ø–µ—á–∞—Ç–∞–µ—Ç")
                statusEl.style.color = "#888";
                statusEl.style.fontWeight = "normal";

                if (typeof usersCache !== 'undefined' && usersCache[fid] && usersCache[fid].lastSeen) {
                    statusEl.innerText = formatLastSeen(usersCache[fid].lastSeen);
                }
                // –ï—Å–ª–∏ userData –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π, –Ω–æ –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ —É –≤–∞—Å –±—ã–ª–æ)
                else if (typeof userData !== 'undefined' && userData && userData.lastSeen) {
                    statusEl.innerText = formatLastSeen(userData.lastSeen);
                }
                else {
                    statusEl.innerText = '–∑–∞–≥—Ä—É–∑–∫–∞...';
                }
            }

            // =========================================================
            // 1. –û–ß–ò–°–¢–ö–ê –°–¢–ê–†–´–• –°–õ–£–®–ê–¢–ï–õ–ï–ô
            // =========================================================
            if (chatStatusUnsub) {
                chatStatusUnsub();
                chatStatusUnsub = null;
            }
            if (typingUnsub) {
                typingUnsub();
                typingUnsub = null;
            }

            // =========================================================
            // 2. –°–õ–£–®–ê–¢–ï–õ–¨ –û–ë–´–ß–ù–û–ì–û –°–¢–ê–¢–£–°–ê (–í –°–ï–¢–ò / –ë–´–õ –ù–ï–î–ê–í–ù–û)
            // =========================================================
            chatStatusUnsub = db.collection('users').doc(fid).onSnapshot(userSnap => {
                if (userSnap.exists && currentFriendId === fid) {
                    const userData = userSnap.data();
                    if (typeof usersCache !== 'undefined') {
                        usersCache[fid] = userData;
                    }
                    if (statusEl) {
                        // –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –ù–ï–¢ –Ω–∞–¥–ø–∏—Å–∏ "–ø–µ—á–∞—Ç–∞–µ—Ç..."
                        // –ß—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–±–∏–≤–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é
                        if (!statusEl.querySelector('.typing-text')) {
                            statusEl.innerText = formatLastSeen(userData.lastSeen);
                            statusEl.style.color = "#888";
                        }
                    }
                }
            }, err => console.error("–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è —Å—Ç–∞—Ç—É—Å–∞:", err));

            // =========================================================
            // 3. –°–õ–£–®–ê–¢–ï–õ–¨ –°–¢–ê–¢–£–°–ê "–ü–ï–ß–ê–¢–ê–ï–¢" (–ù–û–í–û–ï)
            // =========================================================
            console.log("üü¢ –°–ª—É—à–∞—Ç–µ–ª—å —Ç–∞–π–ø–∏–Ω–≥–∞ –∑–∞–ø—É—â–µ–Ω –¥–ª—è ID:", fid);

            typingUnsub = db.collection('chats').doc(currentChatId).collection('typing').doc(fid)
                .onSnapshot(snap => {
                    if (!statusEl) return;

                    // –õ–û–ì –í –ö–û–ù–°–û–õ–¨: –ü—Ä–∏—à–ª–∏ –ª–∏ –¥–∞–Ω–Ω—ã–µ?
                    console.log("üì• –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–ø–∏–Ω–≥–∞:", snap.exists ? snap.data() : "–ü—É—Å—Ç–æ–π –¥–æ–∫—É–º–µ–Ω—Ç");

                    let showTyping = false;

                    if (snap.exists) {
                        const data = snap.data();
                        if (data.isTyping) {
                            // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—Ä–µ–º—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∑–∞–≤–∏—Å–ª–æ –ª–∏
                            if (data.ts) {
                                const diff = Date.now() - data.ts.toMillis();
                                console.log("‚è± –ü—Ä–æ—à–ª–æ –≤—Ä–µ–º–µ–Ω–∏ (–º—Å):", diff);

                                // –£–≤–µ–ª–∏—á–∏–º –ø–æ—Ä–æ–≥ –¥–æ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Ç–µ—Å—Ç–∞ (—á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω –≤—Ä–µ–º–µ–Ω–∏)
                                if (diff < 30000) {
                                    showTyping = true;
                                } else {
                                    console.log("‚ö†Ô∏è –°—Ç–∞—Ç—É—Å —É—Å—Ç–∞—Ä–µ–ª (–∑–∞–≤–∏—Å)");
                                }
                            } else {
                                // –ï—Å–ª–∏ –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ—Ç, –Ω–æ —Ñ–ª–∞–≥ true ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
                                showTyping = true;
                            }
                        }
                    }

                    if (showTyping) {
                        console.log("üü£ –ü–û–ö–ê–ó–´–í–ê–Æ: –ø–µ—á–∞—Ç–∞–µ—Ç...");
                        statusEl.innerHTML = `<span class="typing-text">–ø–µ—á–∞—Ç–∞–µ—Ç<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span></span>`;
                    } else {
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                        const cachedUser = usersCache[fid];
                        if (cachedUser && cachedUser.lastSeen) {
                            statusEl.innerText = formatLastSeen(cachedUser.lastSeen);
                            statusEl.style.color = "#888";
                            statusEl.style.fontWeight = "normal";
                        } else {
                            statusEl.innerText = "";
                        }
                    }
                }, error => {
                    // –õ–û–ì –û–®–ò–ë–ö–ò: –ï—Å–ª–∏ –ø—Ä–∞–≤ –Ω–µ—Ç, —Ç—É—Ç –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞
                    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è —Ç–∞–π–ø–∏–Ω–≥–∞:", error);
                });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            loadMessages();

            // –§–æ–∫—É—Å –Ω–∞ –∏–Ω–ø—É—Ç (–¥–ª—è –ü–ö)
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (!isMobile) {
                setTimeout(() => {
                    const inp = document.getElementById('msgInput');
                    if (inp) inp.focus();
                }, 100);
            }
        }

        function scrollToMsg(id) {
            const el = document.getElementById('msg-' + id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // –≠—Ñ—Ñ–µ–∫—Ç –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–Ω–∏—è
                el.style.transition = "background 0.5s";
                el.style.background = "#3a3a3a";
                setTimeout(() => { el.style.background = ""; }, 1500);
            } else {
                showToast("–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (–≤–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–∞—Ä–æ–µ)");
            }
        }

        function loadMessages() {
            const list = document.getElementById('msgList');

            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é –ø–æ–¥–ø–∏—Å–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞
            if (msgUnsub) msgUnsub();
            list.innerHTML = '';

            const deletedLocal = JSON.parse(localStorage.getItem('deletedMsgs') || '[]');

            msgUnsub = db.collection('chats').doc(currentChatId).collection('msgs')
                .orderBy('ts', 'asc')
                .limitToLast(50)
                .onSnapshot({ includeMetadataChanges: true }, snap => {

                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫—ç—à–∞, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π)
                    if (snap.metadata.fromCache && snap.docs.length < 2 && snap.docs.length > 0) return;

                    const batch = db.batch();
                    let needCommit = false;
                    const isWindowActive = document.hasFocus() && document.visibilityState === 'visible';

                    list.innerHTML = '';

                    snap.docs.forEach(doc => {
                        const rawData = doc.data();
                        const msgId = doc.id;

                        // –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
                        const m = { ...rawData };
                        m.txt = decryptText(rawData.txt, currentChatId);

                        if (deletedLocal.includes(msgId)) return;

                        const div = document.createElement('div');
                        div.id = 'msg-' + msgId;

                        // === –õ–û–ì–ò–ö–ê –û–¢–ö–†–´–¢–ò–Ø –ú–ï–ù–Æ (–ü–ö –∏ –ú–æ–±–∞–π–ª) ===
                        div.oncontextmenu = (e) => {
                            e.preventDefault(); e.stopPropagation();
                            openContextMenu(e, msgId, m.from === currentUser.uid);
                        };
                        div.onclick = (e) => {
                            if (window.innerWidth <= 768) {
                                if (e.target.tagName !== 'A' && e.target.tagName !== 'IMG') {
                                    e.stopPropagation();
                                    openContextMenu(e, msgId, m.from === currentUser.uid, true);
                                }
                            }
                        };

                        // –ü–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º
                        if (m.to === currentUser.uid && !m.read && isWindowActive) {
                            batch.update(doc.ref, { read: true });
                            needCommit = true;
                        }

                        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
                        let timeStr = '';
                        if (m.ts) {
                            const date = m.ts.toDate();
                            timeStr = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
                        } else {
                            const now = new Date();
                            timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                        }

                        let ticksHtml = m.read ? '<span style="margin-right: -4px;">‚úì</span>‚úì' : '‚úì';

                        // –ö–ª–∞—Å—Å—ã —Å—Ç–∏–ª–µ–π
                        if (m.sys) div.className = 'msg msg-sys';
                        else if (m.from === currentUser.uid) div.className = 'msg msg-me';
                        else div.className = 'msg msg-other';

                        let contentHtml = '';

                        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–∏—Ç–∞—Ç—ã (–û—Ç–≤–µ—Ç–∞)
                        if (m.replyTo) {
                            contentHtml += `
                            <div class="msg-reply-quote" onclick="scrollToMsg('${m.replyTo.id}')">
                                <div class="msg-reply-name">${m.replyTo.name}</div>
                                <div class="msg-reply-text">${m.replyTo.text}</div>
                            </div>`;
                        }

                        const msgType = m.type || 'text';

                        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–ù–¢–ï–ù–¢–ê ---
                        if (m.sys) {
                            contentHtml += m.txt;
                        }
                        else if (msgType === 'image') {
                            let imgSrc = m.txt;
                            if (m.txt.includes('id=')) { try { const fileId = m.txt.split('id=')[1]; imgSrc = `https://lh3.googleusercontent.com/d/${fileId}=w600`; } catch (e) { } }
                            contentHtml += `<div class="media-container"><img src="${imgSrc}" class="chat-media-img" onclick="openImageViewer('${imgSrc}')" onload="document.getElementById('msgList').scrollTop = document.getElementById('msgList').scrollHeight" onerror="this.src='https://placehold.co/200x200?text=–û—à–∏–±–∫–∞';"></div>`;
                        }
                        else if (msgType === 'file') {
                            contentHtml += `<a href="${m.txt}" target="_blank" class="chat-file-card"><div class="file-icon">üìÑ</div><div class="file-info"><div class="file-name">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</div><div class="file-action">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div></div></a>`;
                        }
                        else {
                            // –¢–ï–ö–°–¢–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï
                            let formattedText = m.txt.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:#4a9eff;text-decoration:underline;">$1</a>');
                            const safeHtml = DOMPurify.sanitize(formattedText, { ALLOWED_TAGS: ['a'], ALLOWED_ATTR: ['href', 'target', 'style'] });
                            // –í–∞–∂–Ω–æ: –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å msg-text, —á—Ç–æ–±—ã –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ –∑–Ω–∞–ª, –∫—É–¥–∞ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç
                            contentHtml += `<span class="msg-text">${safeHtml}</span>`;
                        }

                        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –∏ –≥–∞–ª–æ—á–∫–∏
                        if (!m.sys) {
                            let metaStyle = "";
                            if (msgType === 'image') {
                                metaStyle = "position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 12px; backdrop-filter: blur(4px); z-index: 2;";
                                contentHtml = `<div style="position: relative; display: inline-block; vertical-align: top; min-width: 200px;">${contentHtml}`;
                            }

                            let metaHtml = `
                            <span class="msg-meta" style="${metaStyle}">
                                ${m.edited ? '<span style="font-size: 11px; color: rgba(255,255,255,0.6); margin-right: 5px;">–∏–∑–º.</span>' : ''}
                                <span class="msg-time" style="color: rgba(255,255,255,0.6); font-size: 11px;">${timeStr}</span>
                                ${m.from === currentUser.uid ? `<span class="msg-ticks" style="color: white; font-size: 12px; margin-left: 3px;">${ticksHtml}</span>` : ''}
                            </span>`;

                            if (msgType === 'image') contentHtml += metaHtml + `</div>`;
                            else div.innerHTML = contentHtml + metaHtml;

                            if (msgType === 'image') div.innerHTML = contentHtml;
                        } else {
                            div.innerHTML = contentHtml;
                        }

                        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫
                        list.appendChild(div);

                        // üî•üî•üî• –í–û–¢ –≠–¢–û–ì–û –ù–ï –•–í–ê–¢–ê–õ–û: –ó–ê–ü–£–°–ö –ü–ï–†–ï–í–û–î–ê üî•üî•üî•
                        if (typeof isAutoTranslate !== 'undefined' && isAutoTranslate) {
                            // –ü–µ—Ä–µ–≤–æ–¥–∏–º —Ç–æ–ª—å–∫–æ –¢–ï–ö–°–¢–û–í–´–ï —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –î–†–£–ì–ò–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ)
                            if (m.from !== currentUser.uid && msgType === 'text' && !m.sys) {
                                appendTranslation(div, m.txt);
                            }
                        }
                        // -----------------------------------------------------

                    });

                    if (needCommit) batch.commit();
                    setTimeout(() => { list.scrollTop = list.scrollHeight; }, 50);
                });

            setTimeout(() => {
                const inp = document.getElementById('msgInput');
                if (inp) inp.focus();
            }, 100);
        }
        function performCloseUI() {
            // 1. –°–±—Ä–æ—Å UI
            document.getElementById('mainSidebar').classList.remove('hidden-mobile');
            document.getElementById('mainChatArea').classList.remove('active');
            document.getElementById('activeChat').classList.add('hidden');
            document.getElementById('noChat').classList.remove('hidden');

            // 2. –°–±—Ä–æ—Å –º–æ–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç" –≤ –±–∞–∑–µ (–î–ï–õ–ê–ï–ú –≠–¢–û –î–û —Å–±—Ä–æ—Å–∞ ID)
            if (currentChatId && currentUser) {
                db.collection('chats').doc(currentChatId).collection('typing').doc(currentUser.uid).set({
                    isTyping: false
                }).catch(() => { }); // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ (–µ—Å–ª–∏ –∏–Ω–µ—Ç –ø—Ä–æ–ø–∞–ª)
            }

            // 3. –û—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
            if (msgUnsub) {
                msgUnsub();
                msgUnsub = null;
            }

            // 4. –û—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ "–í —Å–µ—Ç–∏"
            if (chatStatusUnsub) {
                chatStatusUnsub();
                chatStatusUnsub = null;
            }

            // 5. --- –ù–û–í–û–ï: –û—Ç–ø–∏—Å–∫–∞ –æ—Ç "–ü–µ—á–∞—Ç–∞–µ—Ç..." ---
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é typingUnsub (–∫–æ—Ç–æ—Ä—É—é –º—ã –æ–±—ä—è–≤–∏–ª–∏ –≤ –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞)
            if (typeof typingUnsub !== 'undefined' && typingUnsub) {
                typingUnsub();
                typingUnsub = null;
            }

            // 6. –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
            currentFriendId = null;
            currentChatId = null;
        }
        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–∏–ø: 'text', 'image', 'file')
        function sendMsg(txt, isSys = false, type = 'text') {
            const inputEl = document.getElementById('msgInput');
            const t = txt || inputEl.value.trim();
            if (!t) return;

            // ========================================================
            // --- –ù–û–í–û–ï: –°–ë–†–û–° –°–¢–ê–¢–£–°–ê "–ü–ï–ß–ê–¢–ê–ï–¢" ---
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –∏ —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
            if (typeof typingTimeout !== 'undefined' && typingTimeout) {
                clearTimeout(typingTimeout);
            }

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∏ –ø–∏—à–µ–º –≤ –±–∞–∑—É false
            if (typeof isTyping !== 'undefined') isTyping = false;

            if (currentChatId && currentUser) {
                db.collection('chats').doc(currentChatId).collection('typing').doc(currentUser.uid).set({
                    isTyping: false
                }).catch(() => { }); // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
            }
            // ========================================================


            // --- –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ---
            if (isEditingMode && editMessageId) {
                db.collection('chats').doc(currentChatId).collection('msgs').doc(editMessageId).update({
                    txt: encryptText(t, currentChatId),
                    edited: true // –ú–µ—Ç–∫–∞, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ
                }).then(() => {
                    cancelReplyOrEdit();
                });
                return; // –í—ã—Ö–æ–¥–∏–º, –Ω–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ
            }

            // --- –û–ë–´–ß–ù–ê–Ø –û–¢–ü–†–ê–í–ö–ê ---
            const encryptedText = encryptText(t, currentChatId);

            const msgData = {
                txt: encryptedText, // –í –±–∞–∑—É –ª–µ—Ç–∏—Ç —à–∏—Ñ—Ä
                from: currentUser.uid,
                to: currentFriendId,
                sys: isSys,
                type: type,
                read: false,
                ts: firebase.firestore.FieldValue.serverTimestamp()
            };

            // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (replyMessageData) {
                msgData.replyTo = {
                    id: replyMessageData.id,
                    name: replyMessageData.name,
                    text: replyMessageData.text
                };
                cancelReplyOrEdit(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
            }

            db.collection('chats').doc(currentChatId).collection('msgs').add(msgData);

            if (!txt) {
                inputEl.value = '';
                document.getElementById('sendBtn').style.display = 'none';
                document.querySelector('.voice-btn').style.display = 'flex';
                inputEl.focus();
            }
            // –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (–ë–ï–ó–û–ü–ê–°–ù–û –ß–ï–†–ï–ó –°–ï–†–í–ï–†)
            if (!isSys && currentFriendId) {
                sendNotificationSecure(currentFriendId, t, type);
            }
        }
        let isEditingMode = false;
        let editMessageId = null;
        let replyMessageData = null; // { id, name, text }


        function openActionSheet(msgId, isMine) {
            selectedMsgId = msgId;
            selectedMsgIsMine = isMine;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ò–∑–º–µ–Ω–∏—Ç—å"
            const editBtn = document.getElementById('btnEditMsg');
            if (isMine) {
                editBtn.style.display = 'flex';
            } else {
                editBtn.style.display = 'none';
            }

            document.getElementById('overlaySheet').style.display = 'block';
            setTimeout(() => { document.getElementById('actionSheet').classList.add('open'); }, 10);
        }

        // --- –ö–û–ü–ò–†–û–í–ê–¢–¨ ---
        function handleCopy() {
            const msgEl = document.getElementById('msg-' + selectedMsgId);
            if (msgEl) {
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–∏—Å–∫–ª—é—á–∞—è –º–µ—Ç–∞-–∏–Ω—Ñ–æ –∏ –≤—Ä–µ–º—è)
                let text = "";
                const textSpan = msgEl.querySelector('.msg-text');
                if (textSpan) {
                    text = textSpan.innerText;
                } else {
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç –±–µ–∑ span
                    text = msgEl.innerText.replace(/\n\d{2}:\d{2}.*/s, ''); // –ì—Ä—É–±–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
                }

                navigator.clipboard.writeText(text).then(() => {
                    showToast("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
                });
            }
            closeAllSheets();
        }

        // --- –û–¢–í–ï–¢–ò–¢–¨ ---
        function handleReply() {
            const msgEl = document.getElementById('msg-' + selectedMsgId);
            if (!msgEl) return closeAllSheets();

            // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ç–æ–≥–æ, –∫–æ–º—É –æ—Ç–≤–µ—á–∞–µ–º
            // –í —Ç–≤–æ–µ–º –∫–æ–¥–µ –∏–º—è –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏, –±–µ—Ä–µ–º –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã: –µ—Å–ª–∏ isMine - "–í—ã", –µ—Å–ª–∏ –Ω–µ—Ç - –∏–º—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            const name = selectedMsgIsMine ? "–í—ã" : document.getElementById('chatTitle').firstElementChild.innerText;

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç
            let text = "–í–ª–æ–∂–µ–Ω–∏–µ";
            const textSpan = msgEl.querySelector('.msg-text');
            if (textSpan) text = textSpan.innerText;
            else if (msgEl.querySelector('.chat-media-img')) text = "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è";
            else if (msgEl.querySelector('.chat-file-card')) text = "–§–∞–π–ª";

            startReplyUI(selectedMsgId, name, text);
            closeAllSheets();
        }

        // --- –ò–ó–ú–ï–ù–ò–¢–¨ ---
        function handleEdit() {
            const msgEl = document.getElementById('msg-' + selectedMsgId);
            if (!msgEl) return closeAllSheets();

            let text = "";
            const textSpan = msgEl.querySelector('.msg-text');
            if (textSpan) text = textSpan.innerText;

            // –ï—Å–ª–∏ —ç—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ–∫–∞ –Ω–µ –¥–µ–ª–∞–µ–º —Å–ª–æ–∂–Ω—ã–º
            if (!text && (msgEl.querySelector('img') || msgEl.querySelector('a'))) {
                alert("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ");
                return closeAllSheets();
            }

            startEditUI(selectedMsgId, text);
            closeAllSheets();
        }

        function startReplyUI(id, name, text) {
            cancelReplyOrEdit(); // –°–±—Ä–æ—Å
            replyMessageData = { id, name, text };

            const bar = document.getElementById('replyBar');
            const title = document.getElementById('replyTitle');
            const txt = document.getElementById('replyText');
            const icon = bar.querySelector('.reply-icon');

            bar.classList.remove('hidden', 'editing');
            title.innerText = name;
            txt.innerText = text;
            icon.innerText = "‚Ü©Ô∏è";

            document.getElementById('msgInput').focus();
        }

        function startEditUI(id, text) {
            cancelReplyOrEdit(); // –°–±—Ä–æ—Å
            isEditingMode = true;
            editMessageId = id;

            const bar = document.getElementById('replyBar');
            const title = document.getElementById('replyTitle');
            const txt = document.getElementById('replyText');
            const icon = bar.querySelector('.reply-icon');
            const input = document.getElementById('msgInput');

            bar.classList.remove('hidden');
            bar.classList.add('editing'); // –°–∏–Ω–∏–π —Ü–≤–µ—Ç
            title.innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ";
            txt.innerText = text;
            icon.innerText = "‚úèÔ∏è";

            input.value = text;
            input.focus();
        }

        function cancelReplyOrEdit() {
            isEditingMode = false;
            editMessageId = null;
            replyMessageData = null;

            const bar = document.getElementById('replyBar');
            if (bar) bar.classList.add('hidden');

            document.getElementById('msgInput').value = '';
        }




        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ–ª—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è

        function confirmDelete(mode) {
            if (!selectedMsgId) return;
            if (mode === 'all') { db.collection('chats').doc(currentChatId).collection('msgs').doc(selectedMsgId).delete(); }
            else if (mode === 'me') {
                const el = document.getElementById(`msg-${selectedMsgId}`);
                if (el) el.style.display = 'none';
                const deletedLocal = JSON.parse(localStorage.getItem('deletedMsgs') || '[]');
                deletedLocal.push(selectedMsgId);
                localStorage.setItem('deletedMsgs', JSON.stringify(deletedLocal));
            }
            closeAllSheets();
        }
        function closeAllSheets() {
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —à—Ç–æ—Ä, –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ (?.)
            document.getElementById('actionSheet')?.classList.remove('open');
            document.getElementById('deleteSheet')?.classList.remove('open');
            document.getElementById('profileSheet')?.classList.remove('open');
            document.getElementById('editProfileSheet')?.classList.remove('open'); // –î–æ–±–∞–≤–∏–º –∏ —ç—Ç–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π

            const menu = document.getElementById('contextMenu');
            if (menu) {
                menu.classList.remove('active');
                menu.style.display = 'none';
            }

            setTimeout(() => {
                const overlay = document.getElementById('overlaySheet');
                if (overlay) overlay.style.display = 'none';
            }, 300);

            selectedMsgId = null;
        }



        function updateCallStatus(text) { document.getElementById('callStatusText').innerText = text; }
        function startTimer() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –±—ã–ª
            if (callTimerInt) clearInterval(callTimerInt);
            // –ï—Å–ª–∏ –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ –µ—â–µ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω–æ ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–µ–π—á–∞—Å
            if (!callStartTime) callStartTime = Date.now();
            const el = document.getElementById('callTimer');
            const tick = () => {
                // –°—á–∏—Ç–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É "—Å–µ–π—á–∞—Å" –∏ "—Å—Ç–∞—Ä—Ç–æ–º"
                const diff = Math.max(0, Date.now() - callStartTime);
                const totalSeconds = Math.floor(diff / 1000);
                const mm = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
                const ss = String(totalSeconds % 60).padStart(2, '0');
                el.innerText = `${mm}:${ss}`;
            };
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∏–∫–∞–Ω—å–µ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            tick();
            callTimerInt = setInterval(tick, 1000);
        }
        function setupPeerConnection() {
            candidateQueue = [];
            pc = new RTCPeerConnection(iceServers);
            pc.oniceconnectionstatechange = () => {
                if (pc.iceConnectionState === 'connected' || pc.iceConnectionState === 'completed') {
                    pc.getStats().then(stats => {
                        stats.forEach(report => {
                            if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                                const local = stats.get(report.localCandidateId);
                                console.log(`üöÄ Connection: ${local.candidateType}`);
                            }
                        });
                    });
                }
            };
            pc.onicecandidate = e => { };
            pc.ontrack = e => {
                const remoteVid = document.getElementById('remoteVideo');
                remoteVid.muted = false;
                if (remoteVid.srcObject !== e.streams[0]) {
                    remoteVid.srcObject = e.streams[0];
                    remoteVid.play().catch(console.error);
                }
            };
            pc.onconnectionstatechange = () => {
                if (pc.connectionState === 'connected') {
                    isConnected = true; wasCallConnected = true; updateCallStatus("–í —Ä–∞–∑–≥–æ–≤–æ—Ä–µ");
                    stopAllTones(); startTimer(); startPing();
                } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                    endCall(false);
                }
            };
        }
        function startPing() {
            const el = document.getElementById('callPing');
            if (pingInterval) clearInterval(pingInterval);
            pingInterval = setInterval(async () => {
                if (!pc) return;
                const stats = await pc.getStats();
                let rtt = null;
                stats.forEach(r => {
                    if (r.type === 'candidate-pair' && r.state === 'succeeded' && r.currentRoundTripTime) { rtt = r.currentRoundTripTime; }
                });
                if (rtt) el.innerText = `Ping: ${(rtt * 1000).toFixed(0)} ms`;
            }, 2000);
        }
        async function addCandidateSafely(candidate) {
            if (!pc) return;
            if (pc.remoteDescription && pc.remoteDescription.type) { try { await pc.addIceCandidate(new RTCIceCandidate(candidate)); } catch (e) { } }
            else { candidateQueue.push(candidate); }
        }
        async function flushCandidateQueue() {
            if (!pc) return;
            for (const cand of candidateQueue) { try { await pc.addIceCandidate(new RTCIceCandidate(cand)); } catch (e) { } }
            candidateQueue = [];
        }
        function setLocalMirror(facing) {
            const v = document.getElementById('localVideo');
            if (!v) return;
            if (facing === 'user') v.classList.add('mirror');
            else v.classList.remove('mirror');
        }
        async function getStreamForFacing(facing, withAudio) {
            const audio = !!withAudio;
            // 1) –ø—Ä–æ–±—É–µ–º —Å—Ç—Ä–æ–≥–æ –Ω—É–∂–Ω—É—é –∫–∞–º–µ—Ä—É
            try {
                return await navigator.mediaDevices.getUserMedia({
                    audio,
                    video: { facingMode: { exact: facing } }
                });
            } catch (e1) { }
            // 2) –ø—Ä–æ–±—É–µ–º "–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ"
            try {
                return await navigator.mediaDevices.getUserMedia({
                    audio,
                    video: { facingMode: { ideal: facing } }
                });
            } catch (e2) {
                // 3) fallback: —á–µ—Ä–µ–∑ enumerateDevices + deviceId
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cams = devices.filter(d => d.kind === 'videoinput');
                if (!cams.length) throw e2;
                const cam = (facing === 'environment') ? cams[cams.length - 1] : cams[0];
                return await navigator.mediaDevices.getUserMedia({
                    audio,
                    video: { deviceId: { exact: cam.deviceId } }
                });
            }
        }
        async function getMedia() {
            try {
                localStream = await getStreamForFacing(currentFacingMode, true);
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('localVideo').muted = true;
                setLocalMirror(currentFacingMode);
                // –∫–∞–∫ –±—ã–ª–æ —É —Ç–µ–±—è: –≤–∏–¥–µ–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω–æ, –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω
                localStream.getVideoTracks()[0].enabled = false;
                updateCamBtnUI(false);
                localStream.getAudioTracks()[0].enabled = true;
                updateMicBtnUI(true);
                localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            } catch (e) {
                console.error(e);
                alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä/–∫–∞–º–µ—Ä–µ");
            }
        }
        async function switchCamera() {
            if (!pc || !localStream) return;
            const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
            if (!sender) return;
            // –µ—Å–ª–∏ —Å–µ–π—á–∞—Å —à–∞—Ä–∏–Ω–≥ —ç–∫—Ä–∞–Ω–∞ ‚Äî –≤–µ—Ä–Ω—ë–º—Å—è –Ω–∞ –∫–∞–º–µ—Ä—É
            if (sender.track && sender.track.label && sender.track.label.toLowerCase().includes('screen')) {
                stopScreen(sender);
            }
            const oldVideoTrack = localStream.getVideoTracks()[0];
            const wasEnabled = oldVideoTrack ? oldVideoTrack.enabled : true;
            const nextFacing = (currentFacingMode === 'user') ? 'environment' : 'user';
            // –≤–∞–∂–Ω–æ –¥–ª—è Android: –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–∞–º–µ—Ä—É
            if (oldVideoTrack) oldVideoTrack.stop();
            let newStream;
            try {
                newStream = await getStreamForFacing(nextFacing, false); // —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ
            } catch (e) {
                console.error(e);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É");
                return;
            }
            const newVideoTrack = newStream.getVideoTracks()[0];
            newVideoTrack.enabled = wasEnabled;
            // –∫–ª—é—á–µ–≤–æ–µ: –º–µ–Ω—è–µ–º –≤–∏–¥–µ–æ—Ç—Ä–µ–∫ –±–µ–∑ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –∑–≤–æ–Ω–∫–∞ [web:16]
            await sender.replaceTrack(newVideoTrack);
            // –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º localStream: —Å—Ç–∞—Ä—ã–π –∞—É–¥–∏–æ + –Ω–æ–≤—ã–π –≤–∏–¥–µ–æ
            const audioTrack = localStream.getAudioTracks()[0] || null;
            localStream = new MediaStream();
            if (audioTrack) localStream.addTrack(audioTrack);
            localStream.addTrack(newVideoTrack);
            document.getElementById('localVideo').srcObject = localStream;
            currentFacingMode = nextFacing;
            setLocalMirror(currentFacingMode);
            // —á–∏—Å—Ç–∏–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç—Ä–∏–º
            newStream.getTracks().forEach(t => {
                if (t !== newVideoTrack) t.stop();
            });
        }
        async function startCall() {
            if (currentCallId) {
                try {
                    const snap = await db.collection('calls').doc(currentCallId).get();
                    if (snap.exists) { return alert("–í—ã —É–∂–µ –≤ –∑–≤–æ–Ω–∫–µ!"); }
                    else { currentCallId = null; isConnected = false; }
                } catch (e) { currentCallId = null; }
            }
            if (isConnected) return alert("–í—ã —É–∂–µ –≤ –∑–≤–æ–Ω–∫–µ!");
            amICaller = true; wasCallConnected = false;
            const newCallId = [currentUser.uid, currentFriendId].sort().join('_');
            const callDoc = db.collection('calls').doc(newCallId);
            const snap = await callDoc.get();
            if (snap.exists && snap.data().caller !== currentUser.uid) { return alert("–õ–∏–Ω–∏—è –∑–∞–Ω—è—Ç–∞!"); }
            currentCallId = newCallId;
            document.getElementById('callScreen').style.display = 'flex';
            updateCallControlsVisibility();
            document.getElementById('callScreen').style.pointerEvents = 'auto';
            updateCallStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...");
            playConnectingTone();
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–≤–æ–Ω–∫–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º
            if (currentFriendId) {
                db.collection('users').doc(currentFriendId).get().then(doc => {
                    if (doc.exists && doc.data().tgChatId) {
                        sendTelegramNotification(doc.data().tgChatId, `üìû *–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫*\n–û—Ç: ${currentUser.email}\n–ó–∞–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å!`);
                    }
                });
            }
            setupPeerConnection();
            pc.onicecandidate = e => { if (e.candidate) callDoc.collection('offerCandidates').add(e.candidate.toJSON()); };
            await getMedia();
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ 'to', —á—Ç–æ–±—ã —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –º–æ–≥ –Ω–∞–π—Ç–∏ —ç—Ç–æ—Ç –∑–≤–æ–Ω–æ–∫
            await callDoc.set({
                offer: { type: offer.type, sdp: offer.sdp },
                caller: currentUser.uid,
                to: currentFriendId, // <--- –í–ê–ñ–ù–û–ï –î–û–ë–ê–í–õ–ï–ù–ò–ï
                status: 'dialing'
            });
            callDoc.onSnapshot(async snap => {
                if (!snap.exists) { endCall(false, true); return; }
                const data = snap.data();
                if (data.status === 'ringing' && !isConnected) { updateCallStatus("–ó–≤–æ–Ω–æ–∫..."); playRingingTone(); }
                if (pc && !pc.currentRemoteDescription && data && data.answer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    flushCandidateQueue();
                }
            });
            callDoc.collection('answerCandidates').onSnapshot(snap => {
                snap.docChanges().forEach(change => { if (change.type === 'added') addCandidateSafely(change.doc.data()); });
            });
        }
        async function answerCall() {
            amICaller = false; wasCallConnected = false;
            document.getElementById('ringtone').pause();
            document.getElementById('incomingPopup').style.display = 'none';
            document.getElementById('callScreen').style.display = 'flex';
            updateCallControlsVisibility();
            document.getElementById('callScreen').style.pointerEvents = 'auto';
            updateCallStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...");
            const callDoc = db.collection('calls').doc(currentCallId);
            const data = (await callDoc.get()).data();
            setupPeerConnection();
            pc.onicecandidate = e => { if (e.candidate) callDoc.collection('answerCandidates').add(e.candidate.toJSON()); };
            await getMedia();
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            flushCandidateQueue();
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await callDoc.update({ answer: { type: answer.type, sdp: answer.sdp }, status: 'connected' });
            callDoc.onSnapshot(snap => { if (!snap.exists) endCall(false, true); });
            callDoc.collection('offerCandidates').onSnapshot(snap => {
                snap.docChanges().forEach(change => { if (change.type === 'added') addCandidateSafely(change.doc.data()); });
            });
        }
        function toggleMic() {
            if (!localStream) return;
            const track = localStream.getAudioTracks()[0]; track.enabled = !track.enabled; updateMicBtnUI(track.enabled);
        }
        function updateMicBtnUI(enabled) {
            const btn = document.getElementById('btnMic'); const lbl = document.getElementById('lblMic');
            if (enabled) { btn.classList.remove('btn-active-white'); btn.innerHTML = 'üé§'; lbl.innerText = '–í—ã–∫–ª. –∑–≤—É–∫'; }
            else { btn.classList.add('btn-active-white'); btn.innerHTML = 'üîá'; lbl.innerText = '–í–∫–ª. –∑–≤—É–∫'; }
        }
        function toggleCamera() {
            if (!localStream) return;
            const sender = pc.getSenders().find(s => s.track.kind === 'video');
            if (sender && sender.track.label.includes('screen')) stopScreen(sender);
            const track = localStream.getVideoTracks()[0]; track.enabled = !track.enabled; updateCamBtnUI(track.enabled);
        }
        function updateCamBtnUI(enabled) {
            const btn = document.getElementById('btnCam'); const lbl = document.getElementById('lblCam');
            if (enabled) { btn.classList.add('btn-active-white'); btn.innerHTML = 'üì∑'; lbl.innerText = '–í—ã–∫–ª. –≤–∏–¥–µ–æ'; }
            else { btn.classList.remove('btn-active-white'); btn.innerHTML = 'üìµ'; lbl.innerText = '–í–∫–ª. –≤–∏–¥–µ–æ'; }
        }
        async function toggleScreen() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) { alert("–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ iPhone."); return; }
            if (!localStream) return;
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const screenTrack = stream.getVideoTracks()[0];
                const sender = pc.getSenders().find(s => s.track.kind === 'video');
                if (sender) {
                    sender.replaceTrack(screenTrack);
                    document.getElementById('localVideo').srcObject = stream;
                    const btn = document.getElementById('btnScr'); const lbl = document.getElementById('lblScr');
                    btn.classList.add('btn-screen-on'); lbl.innerText = '–û—Å—Ç. —Å—Ç—Ä–∏–º';
                    screenTrack.onended = () => stopScreen(sender);
                }
            } catch (e) { console.log(e); }
        }
        function stopScreen(sender) {
            const camTrack = localStream.getVideoTracks()[0];
            sender.replaceTrack(camTrack);
            document.getElementById('localVideo').srcObject = localStream;
            const btn = document.getElementById('btnScr'); const lbl = document.getElementById('lblScr');
            btn.classList.remove('btn-screen-on'); lbl.innerText = '–≠–∫—Ä–∞–Ω';
        }
        function listenForIncomingCalls() {
            db.collection('calls').where('to', '==', currentUser.uid).onSnapshot(snap => {
                snap.docChanges().forEach(change => {
                    if (change.type === "added") {
                        if (change.doc.id.includes(currentUser.uid)) {
                            if (currentCallId) {
                                console.log("Ignored incoming call because busy");
                                return;
                            }
                            currentCallId = change.doc.id;
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É
                            const popup = document.getElementById('incomingPopup');
                            popup.style.display = 'flex';
                            document.getElementById('ringtone').play().catch(() => { });
                            db.collection('calls').doc(currentCallId).update({ status: 'ringing' }).catch(() => { });
                            const data = change.doc.data();
                            const callerId = data.caller;
                            // –°—Å—ã–ª–∫–∞ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç –∏–º–µ–Ω–∏
                            const nameEl = document.getElementById('callerName');
                            nameEl.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞..."; // –°–±—Ä–æ—Å –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
                            // --- –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ó–î–ï–°–¨: –ó–ê–ì–†–£–ó–ö–ê –ò–ú–ï–ù–ò, –§–ê–ú–ò–õ–ò–ò –ò –ê–í–ê–¢–ê–†–ö–ò ---
                            db.collection('users').doc(callerId).get().then(userDoc => {
                                if (userDoc.exists) {
                                    const u = userDoc.data();
                                    // 1. –§–æ—Ä–º–∏—Ä—É–µ–º –ò–º—è + –§–∞–º–∏–ª–∏—è
                                    // –ï—Å–ª–∏ —Ñ–∞–º–∏–ª–∏–∏ –Ω–µ—Ç, –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ –∏–º—è. trim() —É–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã.
                                    let fullName = `${u.name || ''} ${u.surname || ''}`.trim();
                                    // –ï—Å–ª–∏ –∏ –∏–º–µ–Ω–∏ –Ω–µ—Ç, –±–µ—Ä–µ–º –Ω–∏–∫–Ω–µ–π–º –∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É
                                    if (!fullName) fullName = u.username ? `@${u.username}` : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";
                                    // 2. –õ–æ–≥–∏–∫–∞ –ê–≤–∞—Ç–∞—Ä–∫–∏
                                    let avatarHtml;
                                    if (u.avatar) {
                                        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ç–æ
                                        avatarHtml = `<img src="${u.avatar}" style="width:42px; height:42px; border-radius:50%; object-fit:cover; margin-right:12px;">`;
                                    } else {
                                        // –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ - –¥–µ–ª–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –∫—Ä—É–∂–æ–∫ —Å –ø–µ—Ä–≤–æ–π –±—É–∫–≤–æ–π (–°—Ç–∏–ª—å Telegram)
                                        const firstLetter = fullName.charAt(0).toUpperCase();
                                        avatarHtml = `<div style="width:42px; height:42px; border-radius:50%; background: linear-gradient(135deg, #6a11cb, #2575fc); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:18px; margin-right:12px; border: 1px solid #444;">${firstLetter}</div>`;
                                    }
                                    // 3. –§–æ—Ä–º–∏—Ä—É–µ–º HTML "–∫–∞–∫ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–µ"
                                    // –°–≤–µ—Ä—Ö—É –∏–º—è (–±–µ–ª–æ–µ, –∂–∏—Ä–Ω–æ–µ), —Å–Ω–∏–∑—É "Telegram Audio..." (–≥–æ–ª—É–±–æ–≤–∞—Ç–æ–µ/—Å–µ—Ä–æ–µ)
                                    nameEl.innerHTML = `
                                                                                                                                                                                                                                            <div style="display:flex; align-items:center;">
                                                                                                                                                                                                                                                ${avatarHtml}
                                                                                                                                                                                                                                                <div style="display:flex; flex-direction:column; align-items:flex-start; justify-content:center;">
                                                                                                                                                                                                                                                    <span style="font-size: 15px; font-weight: 600; color: white; line-height: 1.2;">${fullName}</span>
                                                                                                                                                                                                                                                    <span style="font-size: 13px; color: #8faebf; font-weight: normal; margin-top: 2px;">Telegram Audio...</span>
                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                        `;
                                } else {
                                    nameEl.innerText = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –Ω–æ–º–µ—Ä";
                                }
                            }).catch(err => {
                                console.error(err);
                                nameEl.innerText = "–û—à–∏–±–∫–∞ ID";
                            });
                            // -------------------------------------------------------------
                        }
                    }
                    if (change.type === "removed") {
                        if (currentCallId === change.doc.id) {
                            endCall(false, true);
                        }
                    }
                });
            });
        }
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –≤—Ö–æ–¥—è—â–µ–≥–æ –≤—ã–∑–æ–≤–∞
        function rejectCall() {
            // 1. –í—ã–∫–ª—é—á–∞–µ–º –∑–≤—É–∫
            document.getElementById('ringtone').pause();
            document.getElementById('ringtone').currentTime = 0;
            // 2. –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
            document.getElementById('incomingPopup').style.display = 'none';
            // 3. –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫ (ID –∑–≤–æ–Ω–∫–∞)
            if (currentCallId) {
                // –£–¥–∞–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –∑–≤–æ–Ω–∫–∞ –∏–∑ –±–∞–∑—ã (—ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∏—Ç –∑–≤–æ–Ω–æ–∫ –∏ —É –∑–≤–æ–Ω—è—â–µ–≥–æ)
                db.collection('calls').doc(currentCallId).delete()
                    .then(() => {
                        console.log("–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω");
                    })
                    .catch(error => {
                        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏:", error);
                    });
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                currentCallId = null;
            }
        }
        function endCallUser() { endCall(true, false); }
        function endCall(isInitiator = true, isRemote = false) {
            document.getElementById('ringtone').pause();
            document.getElementById('ringtone').currentTime = 0;
            stopAllTones();
            if (amICaller) {
                if (wasCallConnected && isConnected) {
                    const time = document.getElementById('callTimer').innerText;
                    sendMsg(`üìû –ó–≤–æ–Ω–æ–∫: ${time}`, true);
                } else if (!wasCallConnected) {
                    if (isInitiator && !isRemote) { sendMsg(`üìû –û—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫`, true); }
                    else {
                        sendMsg(`üìû –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫`, true);
                        if (currentFriendId) {
                            db.collection('users').doc(currentFriendId).get().then(doc => {
                                if (doc.exists && doc.data().tgChatId) {
                                    sendTelegramNotification(doc.data().tgChatId, `‚ùå *–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫*\n–û—Ç: ${currentUser.email}`);
                                }
                            });
                        }
                    }
                }
            }
            if (pc) pc.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (callTimerInt) clearInterval(callTimerInt);
            if (pingInterval) clearInterval(pingInterval);
            const statusText = document.getElementById('callStatusText');
            statusText.innerText = "–ó–í–û–ù–û–ö –ó–ê–í–ïÔøΩ –®–ï–ù"; statusText.style.color = "#ff4444"; statusText.style.fontWeight = "bold";
            playEndTone();
            const screen = document.getElementById('callScreen'); screen.style.pointerEvents = 'none';
            document.getElementById('incomingPopup').style.display = 'none';
            if (isInitiator && currentCallId) { db.collection('calls').doc(currentCallId).delete().catch(() => { }); }
            pc = null; localStream = null; candidateQueue = []; isConnected = false; currentCallId = null; wasCallConnected = false; amICaller = false;
            setTimeout(() => {
                screen.style.display = 'none';
                document.getElementById('callTimer').innerText = "00:00";
                document.getElementById('callPing').innerText = "Ping: -";
                statusText.style.color = "#ccc"; statusText.style.fontWeight = "normal";
            }, 1500);
        }
        function saveTgId() {
            const id = document.getElementById('tgChatId').value.trim();
            if (!id) return alert("–í–≤–µ–¥–∏—Ç–µ ID!");
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).set({ tgChatId: id }, { merge: true }).then(() => {
                    alert("ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
                    sendTelegramNotification(id, "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!");
                });
            }
        }
        function loadTgId() {
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).get().then(doc => {
                    if (doc.exists && doc.data().tgChatId) { document.getElementById('tgChatId').value = doc.data().tgChatId; }
                });
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ü–†–û–§–ò–õ–Ø ---
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∏–∫–Ω–µ–π–º–∞ (—Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª, —Ü–∏—Ñ—Ä—ã, _ –∏ .)
        function validateUsername(input) {
            input.value = input.value.replace(/[^a-zA-Z0-9_.]/g, '');
        }
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∂–∞—Ç–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞
        let currentAvatarBase64 = null;
        function handleAvatarSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
                if (!file.type.match('image.*')) {
                    alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.");
                    return;
                }
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function () {
                        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∂–∞—Ç–∏—è
                        const MAX_WIDTH = 300; // –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä –¥–æ 300px (–¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
                        const MAX_HEIGHT = 300;
                        let width = img.width;
                        let height = img.height;
                        // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        // –†–∏—Å—É–µ–º –Ω–∞ Canvas –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // –ü–æ–ª—É—á–∞–µ–º —Å–∂–∞—Ç—É—é Base64 —Å—Ç—Ä–æ–∫—É (JPEG —Å –∫–∞—á–µ—Å—Ç–≤–æ–º 0.7)
                        // –≠—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∏—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞!
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                        currentAvatarBase64 = compressedDataUrl;
                        const preview = document.getElementById('profileAvatarPreview');
                        const placeholder = document.getElementById('profileAvatarPlaceholder');
                        preview.src = compressedDataUrl;
                        preview.style.display = 'block';
                        placeholder.style.display = 'none';
                    };
                };
                reader.readAsDataURL(file);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
        async function saveProfile() {
            const name = document.getElementById('profileName').value.trim();
            const surname = document.getElementById('profileSurname').value.trim();
            const bio = document.getElementById('profileBio').value.trim();

            if (!name) {
                showToast("–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
                return;
            }

            const updateData = {
                name: name,
                surname: surname,
                bio: bio
            };

            if (currentAvatarBase64) {
                updateData.avatar = currentAvatarBase64;
            }

            db.collection('users').doc(currentUser.uid).set(updateData, { merge: true })
                .then(() => {
                    showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úì");
                    closeAllSheets();
                })
                .catch(err => {
                    console.error(err);
                    showToast("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
                });
        }

        // 3. –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        function copyData(elementId, label) {
            const el = document.getElementById(elementId);
            if (el && el.innerText && el.innerText.trim() !== '' && el.innerText !== '@–Ω–µ_–∑–∞–¥–∞–Ω') {
                const text = el.innerText;

                navigator.clipboard.writeText(text).then(() => {
                    showToast(`${label} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω`);
                }).catch(err => {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', err);
                });
            }
        }

        // 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.innerText = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ–ª—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
        function openProfileSheet() {
            document.getElementById('overlaySheet').style.display = 'block';
            const sheet = document.getElementById('profileSheet');
            setTimeout(() => sheet.classList.add('open'), 10);

            if (!currentUser) return;

            db.collection('users').doc(currentUser.uid).get().then(doc => {
                if (doc.exists) {
                    const d = doc.data();

                    // Email (–¢–µ–∫—Å—Ç)
                    const emailEl = document.getElementById('profileEmail');
                    if (emailEl) emailEl.innerText = d.email;

                    // Username (–¢–µ–∫—Å—Ç) - –ò–°–ü–†–ê–í–õ–ï–ù–û
                    const usernameDiv = document.getElementById('profileUsername');
                    if (usernameDiv) {
                        // –ï—Å–ª–∏ —é–∑–µ—Ä–Ω–µ–π–º –µ—Å—Ç—å –≤ –±–∞–∑–µ, —Å—Ç–∞–≤–∏–º –µ–≥–æ, –∏–Ω–∞—á–µ –∑–∞–≥–ª—É—à–∫—É
                        usernameDiv.innerText = d.username ? '@' + d.username : '@–Ω–µ_–∑–∞–¥–∞–Ω';
                    }

                    // –ò–º—è –∏ –§–∞–º–∏–ª–∏—è (Input)
                    document.getElementById('profileName').value = d.name || '';
                    document.getElementById('profileSurname').value = d.surname || '';

                    // –û —Å–µ–±–µ (Textarea)
                    const bioArea = document.getElementById('profileBio');
                    if (bioArea) {
                        bioArea.value = d.bio || '';
                        // –ê–≤—Ç–æ-–ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –≤—ã—Å–æ—Ç—ã
                        bioArea.style.height = 'auto';
                        bioArea.style.height = bioArea.scrollHeight + 'px';
                    }

                    // –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
                    const birthInput = document.getElementById('profileBirthdate');
                    const birthDisplay = document.getElementById('displayBirthdate');
                    const birthBlock = document.getElementById('birthdateBlock');

                    if (d.birthdate) {
                        birthInput.value = d.birthdate;
                        // –ö—Ä–∞—Å–∏–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì
                        const parts = d.birthdate.split('-');
                        if (parts.length === 3) {
                            birthDisplay.innerText = `${parts[2]}.${parts[1]}.${parts[0]}`;
                        } else {
                            birthDisplay.innerText = d.birthdate;
                        }
                        birthBlock.style.display = 'flex';
                    } else {
                        birthInput.value = '';
                        birthDisplay.innerText = '';
                        birthBlock.style.display = 'none';
                    }

                    // –ê–≤–∞—Ç–∞—Ä–∫–∞
                    const img = document.getElementById('profileAvatarPreview');
                    const ph = document.getElementById('profileAvatarPlaceholder');

                    if (d.avatar) {
                        img.src = d.avatar;
                        img.style.display = 'block';
                        ph.style.display = 'none';
                    } else {
                        img.style.display = 'none';
                        ph.style.display = 'flex';
                    }
                }
            });
        }

        // --- –ï–î–ò–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö ESC ---
        document.addEventListener('keydown', function (e) {
            if (e.key === "Escape") {
                // –°—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã
                const viewer = document.getElementById('imageViewer');
                const searchRes = document.getElementById('searchResults');
                const searchInp = document.getElementById('searchInput');
                // 1. –°–ê–ú–´–ô –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢: –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç–∏–Ω–∫–∏
                if (viewer.classList.contains('active')) {
                    closeImageViewer();
                    return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –∑–∞–∫—Ä—ã—Ç—å —á—Ç–æ-—Ç–æ –ø–æ–¥ –Ω–∏–∑–æ–º
                }
                // 2. –°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢: –ó–∞–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫
                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –ò–õ–ò –µ—Å—Ç—å —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ –ò–õ–ò —Ñ–æ–∫—É—Å –≤ –ø–æ–ª–µ
                if (searchRes.classList.contains('active') || searchInp.value.trim() !== '' || document.activeElement === searchInp) {
                    e.preventDefault(); // –ß—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å —Ñ–æ–∫—É—Å —Å–ª—É—á–∞–π–Ω–æ
                    closeSearch();
                    return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –∑–∞–∫—Ä—ã—Ç—å —á–∞—Ç —Å—Ä–∞–∑—É –∂–µ
                }
                // 3. –ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢: –ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç
                // –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–∏—Å–∫ –∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —É–∂–µ –∑–∞–∫—Ä—ã—Ç—ã
                if (currentChatId) {
                    closeChat();
                    return;
                }
            }
        });
        const msgInput = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.querySelector('.voice-btn');
        msgInput.addEventListener('input', function () {
            handleTyping();
            if (this.value.trim().length > 0) {
                sendBtn.classList.remove('hidden'); // <-- –ò–°–ü–†–ê–í–õ–ï–ù–û (–±—ã–ª–æ hidden-btn)
                sendBtn.style.display = 'flex';¬† ¬† ¬†// –¢–µ–ø–µ—Ä—å —ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
                voiceBtn.style.display = 'none';
            } else {
                sendBtn.classList.add('hidden');¬† ¬† // <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
                sendBtn.style.display = 'none';
                voiceBtn.style.display = 'flex';
            }
        });
        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –ø–æ Enter
        msgInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMsg();
            }
        });
        // --- –ê–í–¢–û–ü–û–í–û–†–û–¢ –û–ö–û–®–ö–ê –°–í–û–ï–ì–û –í–ò–î–ï–û ---
        // --- PIP: drag + resize (–∫—Ä–∞—Å–∏–≤–æ –∏ –±–µ–∑ –±–∞–≥–æ–≤) ---
        const localVidEl = document.getElementById('localVideo');
        const pipEl = document.getElementById('localPip');¬† ¬† ¬† ¬† ¬† ¬† ¬† // –Ω–æ–≤—ã–π id
        const gridEl = document.querySelector('.video-grid');
        const controlsEl = document.querySelector('.controls');
        const resizeHandleEl = pipEl.querySelector('.pip-resize-handle');
        const PIP_STORAGE_KEY = 'pipState_v3';
        let pipRatio = 2 / 3;¬† ¬† ¬† // width/height, –¥–µ—Ñ–æ–ª—Ç –∫–∞–∫ —É —Ç–µ–±—è 140x210
        let pipUserSized = false;¬† // —Å—Ç–∞–Ω–µ—Ç true –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ —Ä–µ—Å–∞–π–∑–∞
        function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
        function getBounds() {
            const gridRect = gridEl.getBoundingClientRect();
            const controlsRect = controlsEl.getBoundingClientRect();
            const margin = 12;
            // bottomLimit: –Ω–µ –¥–∞—ë–º –∑–∞–ª–µ–∑–∞—Ç—å –ø–æ–¥ controls (–æ–Ω–∏ absolute –∏ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç –Ω–∏–∑)
            const bottomLimit = Math.min(gridRect.bottom, controlsRect.top) - gridRect.top - margin;
            return {
                minLeft: margin,
                minTop: margin,
                maxLeft: gridRect.width - margin,
                maxTop: bottomLimit
            };
        }
        function readPipRect() {
            return {
                left: parseFloat(pipEl.style.left || '0'),
                top: parseFloat(pipEl.style.top || '0'),
                width: parseFloat(pipEl.style.width || pipEl.offsetWidth),
                height: parseFloat(pipEl.style.height || pipEl.offsetHeight)
            };
        }
        function applyPipRect(rect, { save = true } = {}) {
            const b = getBounds();
            const minW = 110;
            const maxW = Math.max(minW, b.maxLeft - b.minLeft);
            const width = clamp(rect.width, minW, maxW);
            // –≤—ã—Å–æ—Ç—É –¥–µ—Ä–∂–∏–º –ø–æ ratio (—á—Ç–æ–±—ã –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–æ—Å—å)
            const height = Math.max(90, Math.round(width / pipRatio));
            const maxLeft = Math.max(b.minLeft, b.maxLeft - width);
            const maxTop = Math.max(b.minTop, b.maxTop - height);
            const left = clamp(rect.left, b.minLeft, maxLeft);
            const top = clamp(rect.top, b.minTop, maxTop);
            // –≤–∞–∂–Ω–æ–µ: –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ left/top, —á—Ç–æ–±—ã drag/resize –±—ã–ª–∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º–∏
            pipEl.style.left = `${Math.round(left)}px`;
            pipEl.style.top = `${Math.round(top)}px`;
            pipEl.style.right = 'auto';
            pipEl.style.bottom = 'auto';
            pipEl.style.width = `${Math.round(width)}px`;
            pipEl.style.height = `${Math.round(height)}px`;
            if (save) {
                const state = { left: Math.round(left), top: Math.round(top), width: Math.round(width), ratio: pipRatio, userSized: pipUserSized };
                localStorage.setItem(PIP_STORAGE_KEY, JSON.stringify(state));
            }
        }
        function setDefaultPip() {
            const gridRect = gridEl.getBoundingClientRect();
            const controlsRect = controlsEl.getBoundingClientRect();
            const controlsH = Math.max(0, gridRect.bottom - controlsRect.top);
            const defW = (pipRatio >= 1) ? 210 : 140;¬† ¬†// –ø–æ—Ö–æ–∂–µ –Ω–∞ —Ç–≤–æ—é —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É landscape [–ø–æ —Å–º—ã—Å–ª—É]
            const left = gridRect.width - defW - 20;
            const top = gridRect.height - controlsH - Math.round(defW / pipRatio) - 160; // —Ç–≤–æ–π bottom:160 [–ø–æ —Å–º—ã—Å–ª—É]
            pipUserSized = false;
            applyPipRect({ left, top, width: defW, height: defW / pipRatio }, { save: true });
        }
        function loadPipState() {
            try {
                const raw = localStorage.getItem(PIP_STORAGE_KEY);
                if (!raw) return false;
                const s = JSON.parse(raw);
                if (typeof s.ratio === 'number' && isFinite(s.ratio) && s.ratio > 0.1) pipRatio = s.ratio;
                pipUserSized = !!s.userSized;
                applyPipRect({ left: s.left ?? 0, top: s.top ?? 0, width: s.width ?? 140, height: 0 }, { save: false });
                return true;
            } catch (_) {
                return false;
            }
        }
        function updateRatioFromVideo() {
            if (localVidEl.videoWidth && localVidEl.videoHeight) {
                const w = localVidEl.videoWidth;
                const h = localVidEl.videoHeight;
                // –õ–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –≤–∏–¥–µ–æ —à–∏—Ä–æ–∫–æ–µ (–ü–ö) -> –¥–µ–ª–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (2:3)
                // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –≤—ã—Å–æ–∫–æ–µ (–¢–µ–ª–µ—Ñ–æ–Ω) -> –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                if (w > h) {
                    pipRatio = 2 / 3;
                } else {
                    pipRatio = w / h;
                }
                // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                let currentWidth = parseFloat(pipEl.style.width) || 140;
                let newHeight = currentWidth / pipRatio;
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –≥–ª—é–∫–æ–≤: –µ—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ –ø–æ–ª—É—á–∏–ª–∞—Å—å —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–π, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
                if (newHeight < 100) newHeight = currentWidth * 1.5;
                applyPipRect({ width: currentWidth, height: newHeight }, true);
            }
        }
        // 1) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏/—Ä–∞–∑–º–µ—Ä–∞
        (function initPip() {
            // –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ bottom/right (–∏–∑ CSS) –≤ left/top, —á—Ç–æ–±—ã –¥–∞–ª—å—à–µ –±—ã–ª–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ
            // –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Äî –æ–Ω–æ –≥–ª–∞–≤–Ω–µ–µ
            const hasState = loadPipState();
            if (!hasState) setDefaultPip();
            // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–≤—Ç–æ-–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –±–µ–∑ –¥–µ—Ä–≥–∞–Ω–∏–π
            localVidEl.addEventListener('loadedmetadata', () => {
                updateRatioFromVideo();
                // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–µ–Ω—è–ª —Ä–∞–∑–º–µ—Ä ‚Äî –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç –ø–æ–¥ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é
                if (!pipUserSized) setDefaultPip();
            });
            // –∫–æ–≥–¥–∞ –º–µ–Ω—è–µ—Ç—Å—è viewport (–ø–æ–≤–æ—Ä–æ—Ç/resize –æ–∫–Ω–∞) ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–∂–∏–º–∞–µ–º –≤ –≥—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('resize', () => applyPipRect(readPipRect(), { save: true }));
        })();
        // 2) Drag
        let drag = null;
        pipEl.addEventListener('pointerdown', (e) => {
            if (e.button !== 0) return;
            if (e.target === resizeHandleEl) return; // resize –æ—Ç–¥–µ–ª—å–Ω–æ
            e.preventDefault();
            pipEl.classList.add('dragging');
            pipEl.setPointerCapture(e.pointerId);
            const r = readPipRect();
            drag = {
                id: e.pointerId,
                startX: e.clientX,
                startY: e.clientY,
                startLeft: r.left,
                startTop: r.top,
                width: r.width,
                height: r.height
            };
        });
        pipEl.addEventListener('pointermove', (e) => {
            if (!drag || drag.id !== e.pointerId) return;
            const dx = e.clientX - drag.startX;
            const dy = e.clientY - drag.startY;
            applyPipRect({
                left: drag.startLeft + dx,
                top: drag.startTop + dy,
                width: drag.width,
                height: drag.height
            }, { save: false });
        });
        pipEl.addEventListener('pointerup', (e) => {
            if (!drag || drag.id !== e.pointerId) return;
            pipEl.classList.remove('dragging');
            drag = null;
            applyPipRect(readPipRect(), { save: true });
        });
        // 3) Resize (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º aspect ratio)
        let resize = null;
        resizeHandleEl.addEventListener('pointerdown', (e) => {
            if (e.button !== 0) return;
            e.preventDefault();
            pipEl.classList.add('resizing');
            pipEl.setPointerCapture(e.pointerId);
            const r = readPipRect();
            resize = {
                id: e.pointerId,
                startX: e.clientX,
                startY: e.clientY,
                startW: r.width,
                startLeft: r.left,
                startTop: r.top
            };
        });
        pipEl.addEventListener('pointermove', (e) => {
            if (!resize || resize.id !== e.pointerId) return;
            const dx = e.clientX - resize.startX;
            const dy = e.clientY - resize.startY;
            // –±–µ—Ä—ë–º ‚Äú–Ω–∞–∏–±–æ–ª–µ–µ —Å–∏–ª—å–Ω–æ–µ‚Äù –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
            const grow = Math.max(dx, dy * pipRatio);
            const newW = resize.startW + grow;
            pipUserSized = true;
            applyPipRect({
                left: resize.startLeft,
                top: resize.startTop,
                width: newW,
                height: 0
            }, { save: false });
        });
        pipEl.addEventListener('pointerup', (e) => {
            if (!resize || resize.id !== e.pointerId) return;
            pipEl.classList.remove('resizing');
            resize = null;
            applyPipRect(readPipRect(), { save: true });
        });
        // 4) –ë—ã—Å—Ç—Ä—ã–π —Å–±—Ä–æ—Å (–¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ / –¥–≤–æ–π–Ω–æ–π —Ç–∞–ø)
        pipEl.addEventListener('dblclick', () => setDefaultPip());
        // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –≤–∏–¥–µ–æ
        localVidEl.addEventListener('loadedmetadata', checkLocalVideoOrientation);
        localVidEl.addEventListener('resize', checkLocalVideoOrientation);
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        function checkLocalVideoOrientation() {
            if (!localStream) return;
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                const settings = videoTrack.getSettings();
                // –õ–æ–≥–∏–∫–∞ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–≥–ª—É—à–∫–∞, —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞–ª–æ
                console.log("Orientation check:", settings.width, settings.height);
            }
        }
        function updateCallControlsVisibility() {
            const isMobile = isMobileDevice();
            // –ò—â–µ–º –∫–Ω–æ–ø–∫–∏
            const btnFlip = document.getElementById('btnFlip');
            const btnScr = document.getElementById('btnScr');
            // –ò—â–µ–º –∏—Ö —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ .control-item
            const flipItem = btnFlip ? btnFlip.closest('.control-item') : null;
            const scrItem = btnScr ? btnScr.closest('.control-item') : null;
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å —Å–∫—Ä—ã—Ç–∏—è:
            // - –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ (btnScr) —Å–∫—Ä—ã—Ç–∞ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ
            // - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã (btnFlip) —Å–∫—Ä—ã—Ç–æ –Ω–∞ –ü–ö
            if (scrItem) {
                if (isMobile) {
                    scrItem.classList.add('control-item-hidden');
                } else {
                    scrItem.classList.remove('control-item-hidden');
                }
            }
            if (flipItem) {
                if (isMobile) {
                    flipItem.classList.remove('control-item-hidden');
                } else {
                    flipItem.classList.add('control-item-hidden');
                }
            }
            console.log('[updateCallControls] isMobile:', isMobile, '| scrItem —Å–∫—Ä—ã—Ç–∞:', scrItem?.classList.contains('control-item-hidden'), '| flipItem —Å–∫—Ä—ã—Ç–∞:', flipItem?.classList.contains('control-item-hidden'));
        }
    </script>
    <!-- OneSignal Push Logic (–í—Å—Ç–∞–≤—å —ç—Ç–æ –≤ —Å–∞–º—ã–π –Ω–∏–∑ –ø–µ—Ä–µ–¥ </body>) -->
    <script>
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(function (OneSignal) {
            OneSignal.init({
                appId: "6af8818f-ba3a-40c4-b820-5235c1d73925", // –¢–≤–æ–π App ID
            });
            function savePlayerId() {
                if (OneSignal.User.PushSubscription.optedIn) {
                    const oneSignalId = OneSignal.User.PushSubscription.id;
                    const user = firebase.auth().currentUser;
                    if (user && oneSignalId) {
                        console.log("–°–æ—Ö—Ä–∞–Ω—è–µ–º OneSignal ID:", oneSignalId);
                        db.collection('users').doc(user.uid).update({ oneSignalId: oneSignalId }).catch(e => { });
                    }
                }
            }
            OneSignal.User.PushSubscription.addEventListener("change", savePlayerId);
            firebase.auth().onAuthStateChanged(u => { if (u) setTimeout(savePlayerId, 3000); });
        });
        // 2. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—É—à–∞ (–° –û–ë–•–û–î–û–ú –ë–õ–û–ö–ò–†–û–í–ö–ò)


        // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        async function logout() {
            if (!confirm("–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?")) return;
            const user = firebase.auth().currentUser;
            if (user) {
                try {
                    // –£–¥–∞–ª—è–µ–º ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ –±–∞–∑—ã, —á—Ç–æ–±—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å—é–¥–∞ –±–æ–ª—å—à–µ –Ω–µ —à–ª–∏
                    await db.collection('users').doc(user.uid).update({
                        oneSignalId: firebase.firestore.FieldValue.delete()
                    });
                    console.log("Push ID —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.");
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Push ID (–≤–æ–∑–º–æ–∂–Ω–æ, –µ–≥–æ –∏ –Ω–µ –±—ã–ª–æ):", e);
                }
            }
            // –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É –≤—Ö–æ–¥–∞ –∏ –≤—ã—Ö–æ–¥–∏–º
            localStorage.removeItem('isLoggedIn');
            auth.signOut().then(() => {
                window.location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            });
        }
        // === –†–û–£–¢–ï–† (–ù–ê–í–ò–ì–ê–¶–ò–Ø) ===
        // 1. –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥)
        window.addEventListener('hashchange', handleHashChange);
        async function handleHashChange() {
            const hash = window.location.hash;
            // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –ø—É—Å—Ç–∞—è (–º—ã –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤)
            if (!hash || hash === '#') {
                performCloseUI();
                return;
            }
            // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –≤–∏–¥–∞ #chat/USER_ID
            if (hash.startsWith('#chat/')) {
                const userId = hash.replace('#chat/', '');

                // –ï—Å–ª–∏ –º—ã —É–∂–µ –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                if (currentFriendId === userId) return;

                if (!currentUser) return;

                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≤ –∫—ç—à–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –±–∞–∑—ã
                let userData = usersCache[userId];
                if (!userData) {
                    try {
                        document.getElementById('mainChatArea').classList.add('active');
                        document.getElementById('noChat').classList.add('hidden');
                        document.getElementById('activeChat').classList.remove('hidden');
                        document.getElementById('chatTitle').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";

                        const doc = await db.collection('users').doc(userId).get();
                        if (doc.exists) {
                            userData = doc.data();
                            usersCache[userId] = userData;
                        }
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞", e);
                    }
                }

                if (userData) {
                    const name = userData.name || userData.username || 'User';
                    const nick = userData.username ? '@' + userData.username : '';

                    currentFriendId = userId;
                    currentChatId = [currentUser.uid, userId].sort().join('_');

                    // --- –í–ê–ñ–ù–û: –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª—é—á–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
                    fetchChatKey(currentChatId);
                    // -----------------------------------------------------------------

                    if (window.innerWidth <= 768) {
                        document.getElementById('mainSidebar').classList.add('hidden-mobile');
                        document.getElementById('mainChatArea').classList.add('active');
                    }

                    document.getElementById('noChat').classList.add('hidden');
                    document.getElementById('activeChat').classList.remove('hidden');

                    document.getElementById('chatTitle').innerHTML = `
                                    <div>${name}</div>
                                    <div style="font-size:11px; font-weight:normal; color:#888;">${nick}</div>
                                `;

                    // =======================================================
                    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–ê–ü–£–°–ö–ê–ï–ú –°–õ–£–®–ê–¢–ï–õ–¨ –°–¢–ê–¢–£–°–ê –ü–†–ò –û–ë–ù–û–í–õ–ï–ù–ò–ò
                    // =======================================================

                    // 1. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π, –µ—Å–ª–∏ –±—ã–ª
                    if (chatStatusUnsub) chatStatusUnsub();

                    // 2. –°—Ç–∞–≤–∏–º "–∑–∞–≥—Ä—É–∑–∫–∞" –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–≤–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è —Å—Ä–∞–∑—É
                    const statusEl = document.getElementById('chatStatus');
                    if (statusEl) {
                        statusEl.innerText = userData.lastSeen ? formatLastSeen(userData.lastSeen) : '–∑–∞–≥—Ä—É–∑–∫–∞...';
                    }

                    // 3. –ó–∞–ø—É—Å–∫–∞–µ–º –∂–∏–≤–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ
                    chatStatusUnsub = db.collection('users').doc(userId).onSnapshot(userSnap => {
                        if (userSnap.exists && currentFriendId === userId) {
                            const uData = userSnap.data();
                            usersCache[userId] = uData; // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à

                            const el = document.getElementById('chatStatus');
                            if (el) {
                                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –ù–ï –∏–¥–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—è "–ø–µ—á–∞—Ç–∞–µ—Ç"
                                if (!el.querySelector('.typing-text')) {
                                    el.innerText = formatLastSeen(uData.lastSeen);
                                    el.style.color = "#888";
                                }
                            }
                        }
                    }, err => console.error("–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è —Å—Ç–∞—Ç—É—Å–∞:", err));

                    // =======================================================

                    loadMessages();
                } else {
                    // –Æ–∑–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω
                    window.location.hash = '';
                }
            }
        }
        // --- –í—Å—Ç–∞–≤—å —ç—Ç–æ –≤ —Å–≤–æ–π —Å–∫—Ä–∏–ø—Ç ---
        // !!! –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ú–ï–ù–ò –°–°–´–õ–ö–£ –ù–ò–ñ–ï –ù–ê –°–í–û–Æ !!!
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwGYrk10xkvkdYVQDDUhLWHiYZUHJOoKf0BsFFXXNmbmFi66fYP-rAS6uipmecT6UB5/exec";
        // --- –ë–ï–ó–û–ü–ê–°–ù–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
        const APP_SECRET_KEY = "JH54jnbdfkjs297615109dxc1kDmnsg_df1jksHnh1Lhsc";

        async function sendNotificationSecure(friendUid, messageText, msgType = 'text') {
            if (!friendUid || !messageText) return;

            // 1. –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            let displayText = messageText;
            if (msgType === 'image') displayText = 'üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è';
            if (msgType === 'file') displayText = 'üìÑ –§–∞–π–ª';

            // 2. –ü–æ–ª—É—á–∞–µ–º –ú–û–Å –∏–º—è –ø—Ä—è–º–æ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–°–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
            let senderName = "–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"; // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –∏–º—è –Ω–µ –Ω–∞–π–¥–µ—Ç—Å—è

            try {
                // –ï—Å–ª–∏ –º—ã –∑–∞–ª–æ–≥–∏–Ω–µ–Ω—ã
                if (currentUser) {
                    const myDoc = await db.collection('users').doc(currentUser.uid).get();
                    if (myDoc.exists) {
                        const myData = myDoc.data();
                        // –°–æ–±–∏—Ä–∞–µ–º –ò–º—è + –§–∞–º–∏–ª–∏—è
                        if (myData.name) {
                            senderName = myData.name;
                            if (myData.surname) senderName += " " + myData.surname;
                        } else if (myData.username) {
                            // –ï—Å–ª–∏ –∏–º–µ–Ω–∏ –Ω–µ—Ç, –±–µ—Ä–µ–º –Ω–∏–∫–Ω–µ–π–º
                            senderName = "@" + myData.username;
                        }
                    }
                }
            } catch (err) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è:", err);
            }

            try {
                // 3. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è (—á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –µ–≥–æ ID –¥–ª—è –ø—É—à–∞)
                const doc = await db.collection('users').doc(friendUid).get();
                if (!doc.exists) return;

                const userData = doc.data();
                const tgId = userData.tgChatId || null;
                const osId = userData.oneSignalId || null;

                if (!tgId && !osId) return;

                // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        action: "notification",
                        secret: APP_SECRET_KEY,
                        tgId: tgId,
                        oneSignalId: osId,
                        title: senderName,¬† ¬† // <--- –°—é–¥–∞ –ø–æ–π–¥–µ—Ç –ò–º—è –§–∞–º–∏–ª–∏—è –∏–∑ –±–∞–∑—ã
                        text: displayText
                    })
                });

                console.log("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –æ—Ç:", senderName);

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", e);
            }
        }


        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "—Ñ–µ–π–∫–æ–≤–æ–µ" —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–æ–∫–∞ —Ñ–∞–π–ª –≥—Ä—É–∑–∏—Ç—Å—è
        function showTempMessage(file) {
            const list = document.getElementById('msgList');
            const tempId = 'temp-' + Date.now();
            const div = document.createElement('div');
            div.id = tempId;
            div.className = 'msg msg-me'; // –°—Ä–∞–∑—É –∫–∞–∫ "—Å–≤–æ—ë"
            let contentHtml = '';
            if (file.type.startsWith('image/')) {
                const url = URL.createObjectURL(file); // –ë–µ—Ä–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –ª–æ–∫–∞–ª—å–Ω–æ
                contentHtml = `
                                                                                                                                                                                                                <div class="media-container loading-overlay" style="position: relative; display: inline-block;">
                                                                                                                                                                                                                    <img src="${url}" class="chat-media-img" style="opacity: 1;">
                                                                                                                                                                                                                    <div class="upload-spinner"></div>
                                                                                                                                                                                                                </div>
                                                                                                                                                                                                            `;
            } else {
                contentHtml = `
                                                                                                                                                                                                                <div class="chat-file-card" style="opacity: 0.7;">
                                                                                                                                                                                                                    <div class="file-icon">üìÑ</div>
                                                                                                                                                                                                                    <div class="file-info">
                                                                                                                                                                                                                        <div class="file-name">${DOMPurify.sanitize(file.name)}</div>
                                                                                                                                                                                                                        <div class="file-action">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                    <div class="upload-spinner" style="width: 20px; height: 20px; border-width: 2px; left: auto; right: 10px; transform: translateY(-50%);"></div>
                                                                                                                                                                                                                </div>
                                                                                                                                                                                                            `;
            }
            div.innerHTML = contentHtml;
            list.appendChild(div);
            // –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
            setTimeout(() => { list.scrollTop = list.scrollHeight; }, 50);
            return tempId; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º ID, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
        }
        // --- 1. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ "–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ" —Å–æ–æ–±—â–µ–Ω–∏—è (–ø—Ä–µ–≤—å—é) ---
        function showTempMessage(file) {
            const list = document.getElementById('msgList');
            const tempId = 'temp-' + Date.now();
            const div = document.createElement('div');
            div.id = tempId;
            div.className = 'msg msg-me'; // –°—Ä–∞–∑—É –∫–∞–∫ "—Å–≤–æ—ë"
            let contentHtml = '';
            // –ï—Å–ª–∏ —ç—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë —Å—Ä–∞–∑—É
            if (file.type.startsWith('image/')) {
                const url = URL.createObjectURL(file);
                contentHtml = `
                                                                                                                                                                                                                <div class="media-container loading-overlay" style="position: relative; display: inline-block;">
                                                                                                                                                                                                                    <img src="${url}" class="chat-media-img" style="opacity: 1;">
                                                                                                                                                                                                                    <div class="upload-spinner"></div>
                                                                                                                                                                                                                </div>
                                                                                                                                                                                                            `;
            }
            // –ï—Å–ª–∏ —ç—Ç–æ —Ñ–∞–π–ª ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
            else {
                contentHtml = `
                                                                                                                                                                                                                <div class="chat-file-card" style="opacity: 0.7;">
                                                                                                                                                                                                                    <div class="file-icon">üìÑ</div>
                                                                                                                                                                                                                    <div class="file-info">
                                                                                                                                                                                                                        <div class="file-name">${file.name}</div>
                                                                                                                                                                                                                        <div class="file-action">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                    <div class="upload-spinner" style="width: 20px; height: 20px; border-width: 2px; left: auto; right: 10px; transform: translateY(-50%);"></div>
                                                                                                                                                                                                                </div>
                                                                                                                                                                                                            `;
            }
            div.innerHTML = contentHtml;
            list.appendChild(div);
            // –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
            setTimeout(() => { list.scrollTop = list.scrollHeight; }, 50);
            return tempId; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º ID, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
        }
        // --- 2. –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ ---
        // !!! –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è GOOGLE_SCRIPT_URL –æ–±—ä—è–≤–ª–µ–Ω–∞ –≤—ã—à–µ !!!
        async function uploadFile(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 20 * 1024 * 1024) {
                alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 20 –ú–ë.");
                return;
            }
            // 1. –ü–û–ö–ê–ó–´–í–ê–ï–ú –ü–†–ï–í–¨–Æ –ú–ì–ù–û–í–ï–ù–ù–û
            const tempMsgId = showTempMessage(file);
            const originalPlaceholder = document.getElementById('msgInput').placeholder;
            // document.getElementById('msgInput').disabled = true; // –ú–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–≤–æ–¥
            try {
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Base64 (–Ω—É–∂–Ω–æ –¥–ª—è Google Script)
                const toBase64 = f => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(f);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });
                const base64Data = await toBase64(file);
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ Google
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        filename: file.name,
                        mimeType: file.type,
                        base64: base64Data
                    })
                });
                const data = await response.json();
                // 2. –ó–ê–ì–†–£–ó–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê -> –£–î–ê–õ–Ø–ï–ú –ü–†–ï–í–¨–Æ
                const tempEl = document.getElementById(tempMsgId);
                if (tempEl) tempEl.remove();
                if (data.result === "success") {
                    // 3. –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ù–ê–°–¢–û–Ø–©–ï–ï –°–û–û–ë–©–ï–ù–ò–ï
                    const type = file.type.startsWith('image/') ? 'image' : 'file';
                    sendMsg(data.url, false, type);
                } else {
                    throw new Error(data.message || "–û—à–∏–±–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞");
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞:", error);
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - —É–¥–∞–ª—è–µ–º –∫—Ä—É—Ç–∏–ª–∫—É –∏ –≥–æ–≤–æ—Ä–∏–º —é–∑–µ—Ä—É
                const tempEl = document.getElementById(tempMsgId);
                if (tempEl) tempEl.remove();
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
            } finally {
                document.getElementById('msgInput').placeholder = originalPlaceholder;
                document.getElementById('msgInput').disabled = false;
                input.value = ''; // –û—á–∏—â–∞–µ–º –∏–Ω–ø—É—Ç
            }
        }
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ
        function openImageViewer(src) {
            const viewer = document.getElementById('imageViewer');
            const img = document.getElementById('imageViewerImg');
            // –ú–µ–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–≤—ã—à–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–µ—Å–ª–∏ —ç—Ç–æ –≥—É–≥–ª –¥–∏—Å–∫)
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä =w2000 (—à–∏—Ä–∏–Ω–∞ 2000px)
            let highResSrc = src;
            if (src.includes('lh3.googleusercontent.com')) {
                highResSrc = src.split('=')[0] + '=w2000';
            }
            img.src = highResSrc;
            viewer.classList.add('active');
        }
        function closeImageViewer() {
            const viewer = document.getElementById('imageViewer');
            viewer.classList.remove('active');
            setTimeout(() => {
                document.getElementById('imageViewerImg').src = ''; // –û—á–∏—Å—Ç–∫–∞
            }, 300);
        }
        function closeChat() {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–µ—à (–Ω–∞–ø—Ä–∏–º–µ—Ä, #chat/123)
            if (window.location.hash) {
                // 2. –£–±–∏—Ä–∞–µ–º —Ö–µ—à –∏–∑ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                history.pushState("", document.title, window.location.pathname + window.location.search);
                // 3. –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —Ö–µ—à–∞ –≤—Ä—É—á–Ω—É—é, —á—Ç–æ–±—ã –æ–Ω –∑–∞–ø—É—Å—Ç–∏–ª performCloseUI()
                handleHashChange();
            } else {
                // –ï—Å–ª–∏ —Ö–µ—à–∞ –Ω–µ—Ç (—Å—Ç—Ä–∞–Ω–Ω—ã–π —Å–ª—É—á–∞–π), –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º UI
                performCloseUI();
            }
        }
        function closeSearch() {
            const resBox = document.getElementById('searchResults');
            const searchInput = document.getElementById('searchInput');

            const friendsList = document.getElementById('friendsList');
            const requestsList = document.getElementById('requestsList');
            const tabs = document.querySelector('.tabs');

            // 1. –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            resBox.classList.remove('active');
            resBox.style.display = 'none';
            resBox.innerHTML = '';

            // 2. –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
            searchInput.value = '';

            // 3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫–∏ –∏ –∞–∫—Ç–∏–≤–Ω—ã–π —Å–ø–∏—Å–æ–∫)
            if (tabs) tabs.classList.remove('hidden');

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∞—è –≤–∫–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
            const activeTab = document.querySelector('.tab.active');
            if (activeTab && activeTab.innerText.includes('–ó–∞—è–≤–∫–∏')) {
                requestsList.classList.remove('hidden');
                friendsList.classList.add('hidden');
            } else {
                friendsList.classList.remove('hidden');
                requestsList.classList.add('hidden');
            }

            // 4. –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫–∏ –≤ —à–∞–ø–∫–µ
            document.getElementById('profileBtn').style.display = 'flex';
            document.getElementById('searchBackBtn').style.display = 'none';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è openSearchUI (—Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å, —Ç–∞–∫ –∫–∞–∫ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –¥–µ–ª–∞–µ—Ç handleSearchInput)
        function openSearchUI() {
            document.getElementById('profileBtn').style.display = 'none';
            document.getElementById('searchBackBtn').style.display = 'block';
        }
        // –ò –æ–±–Ω–æ–≤–∏ openSearchUI, —á—Ç–æ–±—ã display –ø–µ—Ä–µ–∫–ª—é—á–∞–ª—Å—è
        function openSearchUI() {
            const resBox = document.getElementById('searchResults');
            resBox.style.display = 'flex';
            resBox.classList.add('active');
            document.getElementById('profileBtn').style.display = 'none';
            document.getElementById('searchBackBtn').style.display = 'block';
        }

        function openContextMenu(e, msgId, isMine, isMobile = false) {
            selectedMsgId = msgId;
            selectedMsgIsMine = isMine;

            const menu = document.getElementById('contextMenu');
            const btnEdit = document.getElementById('ctxEdit');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ò–∑–º–µ–Ω–∏—Ç—å"
            if (isMine) btnEdit.style.display = 'flex';
            else btnEdit.style.display = 'none';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é, —á—Ç–æ–±—ã –≤—ã—á–∏—Å–ª–∏—Ç—å –µ–≥–æ —Ä–∞–∑–º–µ—Ä—ã
            menu.style.display = 'flex';
            setTimeout(() => menu.classList.add('active'), 10);

            if (isMobile) {
                // –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É
                menu.style.left = '50%';
                menu.style.top = '50%';
                menu.style.transform = 'translate(-50%, -50%)';
                return;
            }

            // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –î–µ—Å–∫—Ç–æ–ø–∞
            let x = e.clientX;
            let y = e.clientY;

            const menuWidth = menu.offsetWidth;
            const menuHeight = menu.offsetHeight;
            const winWidth = window.innerWidth;
            const winHeight = window.innerHeight;

            // –ï—Å–ª–∏ –º–µ–Ω—é –≤—ã–ª–µ–∑–∞–µ—Ç —Å–ø—Ä–∞–≤–∞
            if (x + menuWidth > winWidth) {
                x -= menuWidth;
            }
            // –ï—Å–ª–∏ –º–µ–Ω—é –≤—ã–ª–µ–∑–∞–µ—Ç —Å–Ω–∏–∑—É
            if (y + menuHeight > winHeight) {
                y -= menuHeight;
            }

            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.style.transform = 'none'; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
        }





        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ (–∫–∞–∫ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ)
        document.addEventListener('scroll', () => {
            const menu = document.getElementById('contextMenu');
            if (menu.style.display === 'flex') {
                menu.classList.remove('active');
                menu.style.display = 'none';
            }
        }, true); // true –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ —Å–∫—Ä–æ–ª–ª–∞ –≤–Ω—É—Ç—Ä–∏ div'–æ–≤

        let editAvatarBase64 = null;


        function openEditProfile() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
            const sheet = document.getElementById('editProfileSheet');
            sheet.classList.add('open');

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            db.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists) {
                    const d = doc.data();

                    // –ò–º—è –∏ –§–∞–º–∏–ª–∏—è
                    document.getElementById('editName').value = d.name || '';
                    document.getElementById('editSurname').value = d.surname || '';

                    // –ë–∏–æ
                    document.getElementById('editBio').value = d.bio || '';
                    updateBioCounter(document.getElementById('editBio'));

                    // –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
                    if (d.birthdate) {
                        document.getElementById('editBirthdate').value = d.birthdate;
                        syncBirthdateView();
                    } else {
                        document.getElementById('editBirthdate').value = ''; // –°–±—Ä–æ—Å, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞—Ç—ã
                    }

                    // --- –Æ–∑–µ—Ä–Ω–µ–π–º (–ò–ó–ú–ï–ù–ï–ù–ò–Ø) ---
                    originalUsername = d.username || '';
                    document.getElementById('editUsername').value = originalUsername;
                    document.getElementById('editUsernameStatus').style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å

                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –≤ true (—Ç–∞–∫ –∫–∞–∫ —Ç–µ–∫—É—â–∏–π —é–∑–µ—Ä–Ω–µ–π–º –≤–∞–ª–∏–¥–µ–Ω)
                    isUsernameValid = true;

                    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                    const saveBtn = document.querySelector('#editProfileSheet .tg-header-top button:last-child');
                    if (saveBtn) {
                        saveBtn.style.opacity = "1";
                        saveBtn.style.pointerEvents = "auto";
                    }
                    // --------------------------

                    // –ê–≤–∞—Ç–∞—Ä
                    const img = document.getElementById('editAvatarPreview');
                    const ph = document.getElementById('editAvatarPlaceholder');

                    if (d.avatar) {
                        img.src = d.avatar;
                        img.style.display = 'block';
                        ph.style.display = 'none';
                        editAvatarBase64 = d.avatar; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                    } else {
                        img.style.display = 'none';
                        ph.style.display = 'flex';
                        // –ü–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –∏–º–µ–Ω–∏ –∏–ª–∏ "U"
                        const firstLetter = (d.name || 'U').charAt(0).toUpperCase();
                        ph.innerText = firstLetter;
                        editAvatarBase64 = null;
                    }
                }
            });
        }


        function closeEditProfile() {
            document.getElementById('editProfileSheet').classList.remove('open');
        }

        function updateBioCounter(el) {
            const count = el.value.length;
            const remaining = 70 - count;
            document.getElementById('bioCounter').innerText = remaining;
            if (remaining < 0) {
                document.getElementById('bioCounter').style.color = 'red';
            } else {
                document.getElementById('bioCounter').style.color = '#888';
            }
        }

        function handleEditAvatarSelect(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                // –°–∂–∞—Ç–∏–µ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É —Å–∂–∞—Ç–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º)
                const img = new Image();
                img.src = e.target.result;
                img.onload = function () {
                    // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ canvas –¥–ª—è —Å–∂–∞—Ç–∏—è –¥–æ 500x500
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const MAX = 500;
                    if (width > height) {
                        if (width > MAX) { height *= MAX / width; width = MAX; }
                    } else {
                        if (height > MAX) { width *= MAX / height; height = MAX; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    editAvatarBase64 = canvas.toDataURL('image/jpeg', 0.8);

                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    const preview = document.getElementById('editAvatarPreview');
                    const ph = document.getElementById('editAvatarPlaceholder');
                    preview.src = editAvatarBase64;
                    preview.style.display = 'block';
                    ph.style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
        }

        function saveEditProfile() {
            const name = document.getElementById('editName').value.trim();
            if (!name) {
                showToast('–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!');
                return;
            }

            const surname = document.getElementById('editSurname').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            const birthdate = document.getElementById('editBirthdate').value;
            const username = document.getElementById('editUsername').value.trim();

            const updateData = {
                name: name,
                surname: surname,
                bio: bio,
                birthdate: birthdate,
                username: username
            };

            if (editAvatarBase64) {
                updateData.avatar = editAvatarBase64;
            }

            const user = firebase.auth().currentUser;
            db.collection('users').doc(user.uid).update(updateData)
                .then(() => {
                    // === –ù–ê–ß–ê–õ–û: –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —ç–∫—Ä–∞–Ω–µ ===

                    // 1. –û–±–Ω–æ–≤–ª—è–µ–º –ò–º—è
                    const nameInput = document.getElementById('profileName');
                    if (nameInput) nameInput.value = name;

                    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –§–∞–º–∏–ª–∏—é (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º)
                    const surInput = document.getElementById('profileSurname');
                    if (surInput) {
                        if (surname && surname.trim() !== "") {
                            surInput.value = surname;
                            surInput.style.display = "block"; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
                        } else {
                            surInput.style.display = "none";¬† // –°–∫—Ä—ã–≤–∞–µ–º
                        }
                    }

                    // 3. –û–±–Ω–æ–≤–ª—è–µ–º "–û —Å–µ–±–µ"
                    const bioInput = document.getElementById('profileBio');
                    if (bioInput) {
                        bioInput.value = bio;
                        // –ü–æ–¥–≥–æ–Ω—è–µ–º –≤—ã—Å–æ—Ç—É –ø–æ–ª—è –ø–æ–¥ —Ç–µ–∫—Å—Ç
                        bioInput.style.height = "auto";
                        bioInput.style.height = (bioInput.scrollHeight) + "px";
                    }

                    // 4. –û–±–Ω–æ–≤–ª—è–µ–º –ù–∏–∫–Ω–µ–π–º
                    const nickDiv = document.getElementById('profileUsername');
                    if (nickDiv) {
                        nickDiv.innerText = username ? username : '';
                    }

                    // 5. –û–±–Ω–æ–≤–ª—è–µ–º –ê–≤–∞—Ç–∞—Ä–∫—É (–µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–∞–ª–∏ –Ω–æ–≤—É—é)
                    if (editAvatarBase64) {
                        // 1. –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–ª–µ–Ω—å–∫—É—é –∞–≤–∞—Ç–∞—Ä–∫—É –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
                        const myAvatarSmall = document.getElementById('myAvatarSmall');
                        if (myAvatarSmall) {
                            myAvatarSmall.innerHTML = `<img src="${editAvatarBase64}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                        }

                        // 2. –û–±–Ω–æ–≤–ª—è–µ–º –±–æ–ª—å—à—É—é –∞–≤–∞—Ç–∞—Ä–∫—É –≤ –ø—Ä–æ—Ñ–∏–ª–µ
                        const pImg = document.getElementById('profileAvatarPreview');
                        const pPh = document.getElementById('profileAvatarPlaceholder');
                        if (pImg) {
                            pImg.src = editAvatarBase64;
                            pImg.style.display = 'block';
                        }
                        if (pPh) {
                            pPh.style.display = 'none';
                        }
                    }


                    // 6. –û–±–Ω–æ–≤–ª—è–µ–º –î–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è
                    const birthDisplay = document.getElementById('displayBirthdate');
                    const birthBlock = document.getElementById('birthdateBlock');
                    const birthInput = document.getElementById('profileBirthdate'); // –°–∫—Ä—ã—Ç—ã–π –∏–Ω–ø—É—Ç

                    if (birthInput) birthInput.value = birthdate;

                    if (birthdate) {
                        const parts = birthdate.split('-'); // 2006-04-04 -> [2006, 04, 04]
                        if (parts.length === 3 && birthDisplay) {
                            // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ 04.04.2006
                            birthDisplay.innerText = `${parts[2]}.${parts[1]}.${parts[0]}`;
                            if (birthBlock) birthBlock.style.display = 'flex';
                        }
                    } else {
                        if (birthBlock) birthBlock.style.display = 'none';
                    }
                    // === –ö–û–ù–ï–¶: –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞ ===

                    showToast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
                    closeEditProfile();
                })
                .catch(err => {
                    console.error(err);
                    showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message);
                });

        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ç–∞–π–º–µ—Ä–∞ (–¥–æ–±–∞–≤—å—Ç–µ –≤ –Ω–∞—á–∞–ª–æ —Å–∫—Ä–∏–ø—Ç–∞, –µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç)
        // let usernameCheckTimeout = null;

        function checkUsernameAvailability(input) {
            // 1. –û—á–∏—Å—Ç–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤ (–¢–û–ß–ù–û –ö–ê–ö –ü–†–ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò)
            // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü—É, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ
            let val = input.value;
            const cleanVal = val.replace(/[^a-zA-Z0-9_]/g, '');

            if (val !== cleanVal) {
                input.value = cleanVal;
                val = cleanVal;
            }

            const statusEl = document.getElementById('editUsernameStatus');
            // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Ö–µ–¥–µ—Ä–∞ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const saveBtn = document.querySelector('#editProfileSheet .tg-header-top button:last-child');

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
            if (usernameCheckTimeout) clearTimeout(usernameCheckTimeout);

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–æ–π
            const setValid = (isValid) => {
                isUsernameValid = isValid;
                saveBtn.style.opacity = isValid ? "1" : "0.5";
                saveBtn.style.pointerEvents = isValid ? "auto" : "none";
            };

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã (–∫–∞–∫ –Ω–∞ –≤–∞—à–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç–µ - 5 —Å–∏–º–≤–æ–ª–æ–≤)
            if (val.length < 5) {
                statusEl.innerText = "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ ‚Äî 5 —Å–∏–º–≤–æ–ª–æ–≤.";
                statusEl.style.color = "#ff595a"; // –ö—Ä–∞—Å–Ω—ã–π
                statusEl.style.display = "block";
                setValid(false);
                return;
            }

            // 3. –í–ê–ñ–ù–û: –ï—Å–ª–∏ —é–∑–µ—Ä–Ω–µ–π–º —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º ‚Äî –æ–Ω —Å–≤–æ–±–æ–¥–µ–Ω!
            // (–≠—Ç–æ–≥–æ –Ω–µ—Ç –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –Ω–æ —ç—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–¥–µ—Å—å)
            if (val === originalUsername) {
                statusEl.style.display = "none";
                setValid(true);
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ü—Ä–æ–≤–µ—Ä–∫–∞..."
            statusEl.innerText = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";
            statusEl.style.color = "#888";
            statusEl.style.display = "block";
            setValid(false); // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∫–∞ –∏–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞

            // 4. –ó–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ (Debounce 500–º—Å ‚Äî –∫–∞–∫ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
            usernameCheckTimeout = setTimeout(() => {
                db.collection('users').where('username', '==', val).get().then(snap => {
                    if (snap.empty) {
                        // –°–≤–æ–±–æ–¥–Ω–æ
                        statusEl.innerText = "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–≤–æ–±–æ–¥–Ω–æ.";
                        statusEl.style.color = "#4caf50"; // –ó–µ–ª–µ–Ω—ã–π
                        setValid(true);
                    } else {
                        // –ó–∞–Ω—è—Ç–æ
                        statusEl.innerText = "–≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ.";
                        statusEl.style.color = "#ff595a"; // –ö—Ä–∞—Å–Ω—ã–π
                        setValid(false);
                    }
                });
            }, 500);
        }


        function pad2(n) { return String(n).padStart(2, '0'); }
        function daysInMonth(y, m1to12) { return new Date(y, m1to12, 0).getDate(); }

        function setSelectValue(sel, val) {
            sel.value = String(val);
        }

        function fillSelect(sel, from, to, fmt = v => v) {
            sel.innerHTML = '';
            for (let v = from; v <= to; v++) {
                const opt = document.createElement('option');
                opt.value = String(v);
                opt.textContent = fmt(v);
                sel.appendChild(opt);
            }
        }

        function syncBirthdateView() {
            const hidden = document.getElementById('editBirthdate');
            const view = document.getElementById('editBirthdateView');
            if (!hidden || !view) return;

            if (!hidden.value) {
                view.value = '';
                return;
            }
            const [y, m, d] = hidden.value.split('-');
            view.value = `${pad2(d)}.${pad2(m)}.${y}`;
        }

        function openBirthModal() {
            const modal = document.getElementById('birthModal');
            const hidden = document.getElementById('editBirthdate');

            const daySel = document.getElementById('bdDay');
            const monthSel = document.getElementById('bdMonth');
            const yearSel = document.getElementById('bdYear');

            const now = new Date();
            let y = now.getFullYear(), m = now.getMonth() + 1, d = now.getDate();

            if (hidden && hidden.value) {
                const parts = hidden.value.split('-');
                if (parts.length === 3) {
                    y = parseInt(parts[0], 10);
                    m = parseInt(parts[1], 10);
                    d = parseInt(parts[2], 10);
                }
            }

            const minYear = 1900;
            const maxYear = 2011;

            if (y > maxYear) y = maxYear;

            fillSelect(yearSel, minYear, maxYear);
            fillSelect(monthSel, 1, 12, v => pad2(v));

            setSelectValue(yearSel, y);
            setSelectValue(monthSel, m);

            function refreshDays() {
                const yy = parseInt(yearSel.value, 10);
                const mm = parseInt(monthSel.value, 10);
                const maxD = daysInMonth(yy, mm);
                const curD = Math.min(parseInt(daySel.value || d, 10), maxD);

                fillSelect(daySel, 1, maxD, v => pad2(v));
                setSelectValue(daySel, curD);
            }

            yearSel.onchange = refreshDays;
            monthSel.onchange = refreshDays;

            refreshDays();
            modal.style.display = 'flex';
        }

        function closeBirthModal() {
            const modal = document.getElementById('birthModal');
            if (modal) modal.style.display = 'none';
        }

        function applyBirthdate() {
            const daySel = document.getElementById('bdDay');
            const monthSel = document.getElementById('bdMonth');
            const yearSel = document.getElementById('bdYear');

            const y = yearSel.value;
            const m = pad2(monthSel.value);
            const d = pad2(daySel.value);

            document.getElementById('editBirthdate').value = `${y}-${m}-${d}`;
            syncBirthdateView();
            closeBirthModal();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const view = document.getElementById('editBirthdateView');
            if (view) {
                view.addEventListener('click', openBirthModal);
            }
            syncBirthdateView();
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
        function viewProfileAvatar() {
            const img = document.getElementById('profileAvatarPreview');
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
            if (img && img.style.display !== 'none' && img.src) {
                openImageViewer(img.src);
            }
        }

        function openGeneralSettings() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–∫—Ä—ã–ª–∏—Å—å –ø–æ–≤–µ—Ä—Ö (–∏–ª–∏ –≤–º–µ—Å—Ç–æ)
            // document.getElementById('profileSheet').classList.remove('open'); // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å

            const sheet = document.getElementById('generalSettingsSheet');
            sheet.style.display = 'flex'; // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –±–ª–æ–∫ –≤–∏–¥–∏–º
            setTimeout(() => {
                sheet.classList.add('open');
            }, 10);
        }

        function closeGeneralSettings() {
            const sheet = document.getElementById('generalSettingsSheet');
            sheet.classList.remove('open');
            // –ñ–¥–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–µ—Ä–µ–¥ —Å–∫—Ä—ã—Ç–∏–µ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        }



        fetch(KEY_PROVIDER_URL, { method: 'GET', mode: 'no-cors' }).catch(() => { });
        // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ ---
        window.addEventListener('click', function (e) {
            const menu = document.getElementById('contextMenu');
            // –ï—Å–ª–∏ –º–µ–Ω—é –æ—Ç–∫—Ä—ã—Ç–æ (display: flex) –ò –∫–ª–∏–∫ –±—ã–ª –ù–ï –≤–Ω—É—Ç—Ä–∏ –º–µ–Ω—é
            if (menu && menu.style.display === 'flex' && !menu.contains(e.target)) {
                menu.classList.remove('active');
                menu.style.display = 'none';
            }
        });

        // --- –õ–û–ì–ò–ö–ê –ü–†–û–ß–¢–ï–ù–ò–Ø –ü–†–ò –í–û–ó–í–†–ê–©–ï–ù–ò–ò –ù–ê –í–ö–õ–ê–î–ö–£ ---

        function markCurrentChatRead() {
            // –ï—Å–ª–∏ —á–∞—Ç –Ω–µ –æ—Ç–∫—Ä—ã—Ç –∏–ª–∏ –æ–∫–Ω–æ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ - –≤—ã—Ö–æ–¥–∏–º
            if (!currentChatId || !currentUser) return;
            if (!document.hasFocus() || document.visibilityState !== 'visible') return;

            // –ò—â–µ–º –≤—Å–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ, –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–µ –º–Ω–µ
            db.collection('chats').doc(currentChatId).collection('msgs')
                .where('to', '==', currentUser.uid)
                .where('read', '==', false)
                .get()
                .then(snap => {
                    if (snap.empty) return;

                    const batch = db.batch();
                    snap.docs.forEach(doc => {
                        batch.update(doc.ref, { read: true });
                    });

                    batch.commit().then(() => {
                        console.log('–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–º–µ—á–µ–Ω—ã –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏');
                    });
                })
                .catch(err => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º:", err));
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ñ–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –æ–∫–Ω–µ
        window.addEventListener('focus', markCurrentChatRead);

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É, –∫–æ–≥–¥–∞ –≤–∫–ª–∞–¥–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–∏–¥–∏–º–æ–π
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                markCurrentChatRead();
            }
        });

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±—É—é —á–∞—Å—Ç—å –æ–∫–Ω–∞ (–Ω–∞ —Å–ª—É—á–∞–π –≥–ª—é–∫–æ–≤ —Ñ–æ–∫—É—Å–∞)
        window.addEventListener('click', () => {
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –∑–∞–ø—Ä–æ—Å–∞–º–∏
            if (currentChatId) markCurrentChatRead();
        });

        function handleTyping() {
            if (!currentChatId || !currentUser) return;

            const now = Date.now();

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å "–ø–µ—á–∞—Ç–∞—é" —Ä–∞–∑ –≤ 2 —Å–µ–∫—É–Ω–¥—ã
            if (!isTyping || (now - lastTypingTime > 2000)) {
                isTyping = true;
                lastTypingTime = now;

                console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Å—Ç–∞—Ç—É—Å: –ø–µ—á–∞—Ç–∞—é..."); // <-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏

                db.collection('chats').doc(currentChatId).collection('typing').doc(currentUser.uid).set({
                    isTyping: true,
                    ts: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(err => console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:", err));
            }

            // –°–±—Ä–æ—Å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã —Ç–∏—à–∏–Ω—ã
            if (typingTimeout) clearTimeout(typingTimeout);

            typingTimeout = setTimeout(() => {
                isTyping = false;
                console.log("üì§ –°—Ç–∞—Ç—É—Å —Å–±—Ä–æ—à–µ–Ω (–Ω–µ –ø–µ—á–∞—Ç–∞—é)"); // <-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏

                db.collection('chats').doc(currentChatId).collection('typing').doc(currentUser.uid).set({
                    isTyping: false
                });
            }, 3000);
        }




        // --- –õ–û–ì–ò–ö–ê –ü–ï–†–ï–í–û–î–ê ---

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ø–∞–º—è—Ç–∏
        let isAutoTranslate = localStorage.getItem('isAutoTranslate') === 'true';
        let targetLang = localStorage.getItem('targetLang') || 'ru';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        function initSettingsUI() {
            const toggle = document.getElementById('autoTranslateToggle');
            if (toggle) toggle.checked = isAutoTranslate;

            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É —è–∑—ã–∫–∞ —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –∏–∑ localStorage
            const label = document.getElementById('currentLangLabel');
            if (label) {
                label.innerText = `–ö–æ–¥ —è–∑—ã–∫–∞: ${targetLang}`;
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç—É–º–±–ª–µ—Ä–∞
        function toggleAutoTranslate(el) {
            isAutoTranslate = el.checked;
            localStorage.setItem('isAutoTranslate', isAutoTranslate);
            showToast(isAutoTranslate ? "–ê–≤—Ç–æ–ø–µ—Ä–µ–≤–æ–¥ –≤–∫–ª—é—á–µ–Ω" : "–ê–≤—Ç–æ–ø–µ—Ä–µ–≤–æ–¥ –≤—ã–∫–ª—é—á–µ–Ω");
        }

        // –°–º–µ–Ω–∞ —è–∑—ã–∫–∞ (–ø—Ä–æ—Å—Ç–æ–π prompt)
        // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –Ø–ó–´–ö–ê ---

        // 1. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ –≤–º–µ—Å—Ç–æ prompt
        function changeTranslateLang() {
            const modal = document.getElementById('langModal');
            if (modal) {
                modal.style.display = 'flex';
            } else {
                console.error("Modale window #langModal not found!");
            }
        }

        // 2. –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ
        function closeLangModal() {
            document.getElementById('langModal').style.display = 'none';
        }

        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±–æ—Ä
        function selectLanguage(code) {
            const langs = {
                'ru': '–†—É—Å—Å–∫–∏–π',
                'en': 'English',
                'de': 'Deutsch',
                'fr': 'Fran√ßais',
                'es': 'Espa√±ol',
                'it': 'Italiano',
                'tr': 'T√ºrk√ße',
                'uk': '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞'
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å –∏ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
            targetLang = code;
            localStorage.setItem('targetLang', targetLang);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
            updateLangLabel();

            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showToast(`–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${langs[code] || code}`);

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
            closeLangModal();
        }

        // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å, –Ω–æ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∞ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:
        function updateLangLabel() {
            const el = document.getElementById('currentLangLabel');
            if (el) {
                const langNames = {
                    'ru': '–†—É—Å—Å–∫–∏–π',
                    'en': 'English',
                    'de': 'Deutsch',
                    'es': 'Espa√±ol',
                    'fr': 'Fran√ßais',
                    'it': 'Italiano',
                    'tr': 'T√ºrk√ße',
                    'uk': '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞'
                };
                const name = langNames[targetLang] || targetLang.toUpperCase();
                el.innerText = `${name} (${targetLang})`;
            }
        }

        function updateLangLabel() {
            const el = document.getElementById('currentLangLabel');
            if (el) {
                const langNames = { 'ru': '–†—É—Å—Å–∫–∏–π', 'en': 'English', 'de': 'Deutsch', 'es': 'Espa√±ol' };
                const name = langNames[targetLang] || targetLang.toUpperCase();
                el.innerText = `${name} (${targetLang})`;
            }
        }



        // –í—ã–∑–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–¥–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –≤—ã–∑–æ–≤ –≤ openGeneralSettings)
        const originalOpenSettings = openGeneralSettings;
        openGeneralSettings = function () {
            originalOpenSettings();
            initSettingsUI();
        };

        // --- API –ü–ï–†–ï–í–û–î–ê ---
        async function fetchTranslation(text, toLang) {
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É: –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —É–∂–µ –Ω–∞ —Ü–µ–ª–µ–≤–æ–º —è–∑—ã–∫–µ, –Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å
                // langpair=Autodetect|ru
                const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=Autodetect|${toLang}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data && data.responseData && data.responseData.translatedText) {
                    // MyMemory –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–ª–∏ —Å –æ—à–∏–±–∫–æ–π "MOUNT LIMIT REACHED"
                    return data.responseData.translatedText;
                }
                return null;
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ API –ø–µ—Ä–µ–≤–æ–¥–∞:", e);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –≤—Å—Ç–∞–≤–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ
        async function appendTranslation(msgElement, text) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –ª–∏ —É–∂–µ
            if (msgElement.querySelector('.translated-block')) return;

            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const loader = document.createElement('div');
            loader.className = 'translating-loader';
            loader.innerText = '–ü–µ—Ä–µ–≤–æ–¥...';
            // –í—Å—Ç–∞–≤–ª—è–µ–º –≤–Ω—É—Ç—Ä—å —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ –ø–µ—Ä–µ–¥ –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã–º–∏ (–≤—Ä–µ–º–µ–Ω–µ–º) –µ—Å–ª–∏ –ø–æ–ª—É—á–∏—Ç—Å—è, –∏–ª–∏ –≤ –∫–æ–Ω–µ—Ü
            const contentSpan = msgElement.querySelector('.msg-text');
            if (contentSpan) contentSpan.appendChild(loader);
            else msgElement.appendChild(loader);

            const translatedText = await fetchTranslation(text, targetLang);

            loader.remove(); // –£–¥–∞–ª—è–µ–º –ª–æ–∞–¥–µ—Ä

            if (translatedText && translatedText !== text) {
                const transBlock = document.createElement('div');
                transBlock.className = 'translated-block';
                transBlock.innerText = translatedText;

                if (contentSpan) contentSpan.appendChild(transBlock);
                else msgElement.appendChild(transBlock);
            }
        }




    </script>

    <div id="birthModal" class="modal-overlay" style="display:none" onclick="closeBirthModal()">
        <div class="birth-modal" onclick="event.stopPropagation()">
            <h3 style="margin:0; font-size:18px; color:white; font-weight:600;">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</h3>

            <div class="birth-pickers">
                <select id="bdDay"></select>
                <select id="bdMonth"></select>
                <select id="bdYear"></select>
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeBirthModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-confirm" style="color:#8774e1" onclick="applyBirthdate()">–ì–æ—Ç–æ–≤–æ</button>
            </div>
        </div>
    </div>


    <div id="imageViewer" class="image-viewer" onclick="closeImageViewer()">
        <span class="close-viewer-btn">&times;</span>
        <img id="imageViewerImg" src="" onclick="event.stopPropagation()">
    </div>
</body>
</html>
